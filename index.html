<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACCA FR çŸ¥è¯†å›¾è°± (PDF è”åŠ¨ç‰ˆ)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --sidebar-bg: #1e293b;
            --accent-color: #38bdf8;
            --node-chapter: #ef4444;
            --node-standard: #f59e0b;
            --node-concept: #10b981;
            --node-case: #8b5cf6;
            --btn-hover: #2563eb;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
        }

        #graph-container {
            flex-grow: 1;
            position: relative;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }

        #sidebar {
            width: 400px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid #334155;
            padding: 20px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            overflow-y: auto;
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            z-index: 10;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }

        #sidebar.hidden {
            transform: translateX(100%);
        }

        h1 { font-size: 1.2rem; color: var(--accent-color); margin-top: 0; border-bottom: 2px solid #334155; padding-bottom: 10px; }
        h2 { font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        
        .content-block {
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 0.95rem;
            color: #cbd5e1;
        }

        .example-box {
            background-color: #334155;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--node-case);
            margin-top: 15px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            margin-right: 5px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* PDF è·³è½¬æŒ‰é’®æ ·å¼ */
        .pdf-btn {
            display: block;
            width: 100%;
            text-align: center;
            background-color: #dc2626;
            color: white;
            text-decoration: none;
            padding: 12px 0;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: bold;
            transition: background 0.2s;
            box-sizing: border-box;
            border: 1px solid #b91c1c;
        }
        .pdf-btn:hover {
            background-color: #b91c1c;
        }
        .pdf-btn span {
            font-size: 0.8em;
            opacity: 0.8;
            font-weight: normal;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 41, 59, 0.9);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid #475569;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        input[type="text"] {
            background: #0f172a;
            border: 1px solid #475569;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 220px;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--accent-color); }

        .legend { margin-top: 12px; font-size: 0.85rem; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; cursor: default; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 1.5rem;
            color: #94a3b8;
            background: none;
            border: none;
        }
        .close-btn:hover { color: #fff; }

    </style>
</head>
<body>

<div id="container">
    <div id="graph-container">
        <div id="controls">
            <input type="text" id="search" placeholder="æœç´¢çŸ¥è¯†ç‚¹ (e.g. Topsy)...">
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:var(--node-chapter)"></div>ç« èŠ‚ (Chapters)</div>
                <div class="legend-item"><div class="legend-color" style="background:var(--node-standard)"></div>å‡†åˆ™ (Standards)</div>
                <div class="legend-item"><div class="legend-color" style="background:var(--node-concept)"></div>æ ¸å¿ƒæ¦‚å¿µ (Concepts)</div>
                <div class="legend-item"><div class="legend-color" style="background:var(--node-case)"></div>æ¡ˆä¾‹/è®¡ç®— (Cases)</div>
            </div>
        </div>
    </div>
    <div id="sidebar" class="hidden">
        <button class="close-btn" onclick="closeSidebar()">Ã—</button>
        <div id="node-details"></div>
    </div>
</div>

<script>
    // --- 1. æ•°æ®æ„å»º (å«ç²¾ç¡® PDF é¡µç ) ---
    // Page Mapping Source: Table of Contents  and Content Analysis
    const data = {
        nodes: [
            { id: "FR", group: 0, label: "Financial Reporting (FR)", desc: "ACCA FR æ ¸å¿ƒçŸ¥è¯†ä½“ç³»", page: 1 },
            
            // --- Chapter 1 ---
            { id: "Ch1", group: 1, label: "Ch1: æŠ¥è¡¨æ ¼å¼", desc: "IFRS 18 Presentation and disclosure", page: 5 },
            { id: "SOFP", group: 2, label: "SOFP (èµ„äº§è´Ÿå€ºè¡¨)", parent: "Ch1", desc: "èµ„äº§ = è´Ÿå€º + æƒç›Šã€‚éœ€åŒºåˆ†æµåŠ¨ä¸éæµåŠ¨ã€‚", page: 5 },
            { id: "SPL", group: 2, label: "SPL (åˆ©æ¶¦è¡¨)", parent: "Ch1", desc: "IFRS 18æ–°è§„åˆ†ç±»ï¼šOperating, Investing, Financing, Income Taxes, Discontinued [cite: 35-41]ã€‚", page: 7 },
            { id: "SOCE", group: 2, label: "SOCE (æƒç›Šå˜åŠ¨è¡¨)", parent: "Ch1", desc: "è®°å½• Share Capital, Premium, RE, Revaluation Surplus çš„å˜åŠ¨ã€‚", page: 8 },

            // --- Chapter 2 ---
            { id: "Ch2", group: 1, label: "Ch2: æ¦‚å¿µæ¡†æ¶", desc: "Conceptual Framework", page: 9 },
            { id: "Qualitative", group: 3, label: "è´¨é‡ç‰¹å¾", parent: "Ch2", desc: "Fundamental (Relevance, Faithful rep) vs Enhancing (Comparability, Verifiability, Timeliness, Understandability) [cite: 89-113]ã€‚", page: 10 },
            { id: "Elements", group: 3, label: "äº”å¤§è¦ç´ ", parent: "Ch2", desc: "Asset, Liability, Equity, Income, Expenseã€‚", page: 12 },
            { id: "Measurement", group: 3, label: "è®¡é‡åŸºç¡€", parent: "Ch2", desc: "Historical Cost vs Current Value (Fair Value, Value in use, Current Cost) [cite: 129-143]ã€‚", page: 13 },
            { id: "Case_Drexler", group: 4, label: "æ¡ˆä¾‹: Drexler Co", parent: "Measurement", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nè®¡ç®— Historical Cost vs Current Cost ä¸‹çš„è´¦é¢ä»·å€¼ã€‚\nPlant Cost: $500k, Life: 5y.\nä¸¤å¹´å Current Price: $600k.\nHC NBV = 300k\nCC NBV = 360k", page: 16 },

            // --- Chapter 3 ---
            { id: "Ch3", group: 1, label: "Ch3: ç›‘ç®¡æ¡†æ¶", desc: "IFRS Foundation structure & IFRS S1/S2", page: 17 },
            { id: "IFRS_S1", group: 2, label: "IFRS S1", parent: "Ch3", desc: "å¯æŒç»­å‘å±•æŠ«éœ²ä¸€èˆ¬è¦æ±‚ã€‚æ ¸å¿ƒå†…å®¹ï¼šGovernance, Strategy, Risk Management, Metrics/Targetsã€‚", page: 19 },

            // --- Chapter 4: Assets ---
            { id: "Ch4", group: 1, label: "Ch4: èµ„äº§ç±»å‡†åˆ™", desc: "IAS 16, 38, 40, 36, 23, 2, 41, IFRS 5", page: 23 },
            
            // IAS 16
            { id: "IAS16", group: 2, label: "IAS 16 PPE", parent: "Ch4", desc: "å›ºå®šèµ„äº§ã€‚åˆå§‹è®¡é‡ï¼šCost (å«ç›´æ¥å½’å±è´¹ç”¨ï¼Œæ‹†é™¤æˆæœ¬)ã€‚", page: 23 },
            { id: "Depreciation", group: 3, label: "æŠ˜æ—§", parent: "IAS16", desc: "å¼€å§‹ï¼šReady for useã€‚é—²ç½®ï¼šç»§ç»­æŠ˜æ—§ã€‚æ–¹æ³•ï¼šç›´çº¿æ³•/ä½™é¢é€’å‡æ³•ã€‚", page: 24 },
            { id: "Revaluation", group: 3, label: "é‡ä¼°æ¨¡å‹", parent: "IAS16", desc: "å¢å€¼è®° OCI/RSã€‚å‡å€¼å…ˆæŠµå‡ RS å†è¿› SPLã€‚æ¯å¹´éœ€è½¬ç§»å¤šä½™æŠ˜æ—§(RS -> RE)ã€‚", page: 25 },
            { id: "Case_Elite", group: 4, label: "æ¡ˆä¾‹: Elite Co", parent: "IAS16", desc: "ã€æ•™æä¾‹é¢˜ã€‘\né‚®è½®ç»„ä»¶æ‹†åˆ†æŠ˜æ—§ã€‚\nShip fabric (25y), Fittings (12y), Propulsion (40k hours)ã€‚\næ›´æ¢æ¨è¿›ç³»ç»Ÿæ—¶ï¼Œæ—§ç³»ç»Ÿå‰©ä½™ä»·å€¼éœ€ derecognizeï¼Œæ–°æˆæœ¬ capitalizeã€‚", page: 28 },
            { id: "Case_Topsy", group: 4, label: "æ¡ˆä¾‹: Topsy Co (é‡ä¼°)", parent: "Revaluation", desc: "ã€é‡ä¼°ç›ˆä½™ä½™é¢è®¡ç®—ã€‘\n1. æœŸåˆ RS: $705,000\n2. å»ºç­‘ç‰©è°ƒæ•´ (å¤šä½™æŠ˜æ—§è½¬ç§»):\n   $1.5m/50y = $30k (æ–°)\n   $750k/50y = $15k (æ—§)\n   è½¬ç§»: ($15,000) (RS -> RE)\n3. åœŸåœ°è°ƒæ•´ (é‡ä¼°å¢å€¼):\n   $950k - $800k = +$150,000 (è®¡å…¥ RS)\n4. æœŸæœ«ä½™é¢: $840,000", page: 25 }, // Linked to Revaluation concept page

            // IAS 38
            { id: "IAS38", group: 2, label: "IAS 38 æ— å½¢èµ„äº§", parent: "Ch4", desc: "æ— å®ä½“ã€å¯è¾¨è®¤ã€éè´§å¸æ€§èµ„äº§ã€‚", page: 30 },
            { id: "RD", group: 3, label: "R&D (ç ”å‘)", parent: "IAS38", desc: "Research: Expense.\nDevelopment: Capitalize if PIRATE criteria met [cite: 513-520]ã€‚", page: 31 },
            { id: "Case_Assoria", group: 4, label: "æ¡ˆä¾‹: Assoria Co", parent: "IAS38", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nè®¡ç®—ç ”å‘è´¹ç”¨æ‘Šé”€ã€‚\nResearch cost ($1.4m) -> SPL.\nDev cost ($0.8m/mo) -> Capitalize from confident dateã€‚", page: 33 },

            // IAS 40
            { id: "IAS40", group: 2, label: "IAS 40 æŠ•èµ„æ€§æˆ¿åœ°äº§", parent: "Ch4", desc: "èµšç§Ÿé‡‘æˆ–èµ„æœ¬å¢å€¼ã€‚Fair Value Model (å˜åŠ¨è¿› SPLï¼Œä¸æŠ˜æ—§) vs Cost Modelã€‚", page: 35 },
            { id: "Case_Carter", group: 4, label: "æ¡ˆä¾‹: Carter Co", parent: "IAS40", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nOwner-occupied è½¬ Investment Propertyã€‚\nè½¬æ¢æ—¥å…ˆé‡ä¼°è‡³ FV (Gain -> OCI)ï¼Œä¹‹åæŒ‰ IAS 40 å¤„ç†ã€‚", page: 38 },

            // IAS 36
            { id: "IAS36", group: 2, label: "IAS 36 èµ„äº§å‡å€¼", parent: "Ch4", desc: "Carrying Amount > Recoverable Amount.\nRA = Higher of (FV-CTS, VIU)ã€‚", page: 39 },
            { id: "CGU", group: 3, label: "CGU (ç°é‡‘äº§å‡ºå•å…ƒ)", parent: "IAS36", desc: "å‡å€¼åˆ†æ‘Šé¡ºåºï¼š1. Specific asset damage 2. Goodwill 3. Pro-rata other assetsã€‚", page: 40 },
            { id: "Case_Riley", group: 4, label: "æ¡ˆä¾‹: Riley Co", parent: "IAS36", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nè®¡ç®— Impairment Lossã€‚\nNBV=$50k. FV-CTS=$30k. VIU=$31,875 (Cashflows discounted)ã€‚\nRecoverable amount = $31,875ã€‚\nImpairment = $18,125ã€‚", page: 42 },

            // IAS 23
            { id: "IAS23", group: 2, label: "IAS 23 å€Ÿæ¬¾è´¹ç”¨", parent: "Ch4", desc: "Qualifying Asset (å»ºé€ æœŸé•¿)ã€‚èµ„æœ¬åŒ–åˆ©æ¯ = å®é™…å‘ç”Ÿ - ä¸´æ—¶æŠ•èµ„æ”¶ç›Šã€‚", page: 44 },
            { id: "Case_Fido", group: 4, label: "æ¡ˆä¾‹: Fido Co", parent: "IAS23", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nä¸€èˆ¬å€Ÿæ¬¾åŠ æƒå¹³å‡åˆ©ç‡è®¡ç®—ã€‚\nLoan A (10%) & Loan B (8%)ã€‚\nWACC calculation for capitalization rateã€‚", page: 45 },

            // IAS 2
            { id: "IAS2", group: 2, label: "IAS 2 å­˜è´§", parent: "Ch4", desc: "Lower of Cost and NRV (Net Realizable Value)ã€‚", page: 46 },
            { id: "Case_Litch", group: 4, label: "æ¡ˆä¾‹: Litch Co", parent: "IAS2", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nWIP valuationã€‚\nCost $14,900. NRV = Selling price - Completion cost - Selling costã€‚", page: 48 },

            // IFRS 5
            { id: "IFRS5", group: 2, label: "IFRS 5 æŒæœ‰å¾…å”®", parent: "Ch4", desc: "æ¡ä»¶ï¼šAvailable for immediate sale, Highly probable, <1 yearã€‚\nè®¡é‡ï¼šLower of CA and FV-CTSã€‚åœæ­¢æŠ˜æ—§ã€‚", page: 50 },

            // IAS 41
            { id: "IAS41", group: 2, label: "IAS 41 å†œä¸š", parent: "Ch4", desc: "ç”Ÿç‰©èµ„äº§ï¼šFV - CTS (å˜åŠ¨è¿› SPL)ã€‚\næ”¶è·å†œäº§å“ï¼šHarvest æ—¶ FV - CTS è½¬ä¸º Inventory Costã€‚", page: 54 },
            { id: "Case_Shaw", group: 4, label: "æ¡ˆä¾‹: Shaw Co", parent: "IAS41", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nç¾Šç¾¤ä¼°å€¼ã€‚\nYear end measure at FV ($480k) less commission (4%). Gain to SPLã€‚", page: 55 },

            // --- Chapter 5: Leases ---
            { id: "Ch5", group: 1, label: "Ch5: ç§Ÿèµ (IFRS 16)", desc: "Lessee Accounting", page: 57 },
            { id: "ROU_Liab", group: 2, label: "ROU Asset & Liability", parent: "Ch5", desc: "Asset: Cost model. Liability: PV of lease paymentsã€‚", page: 58 },
            { id: "Exemptions", group: 3, label: "è±å…æƒ…å†µ", parent: "Ch5", desc: "Short-term (<12m) & Low value assets -> Expense straight lineã€‚", page: 57 },
            { id: "Case_Pebworth", group: 4, label: "æ¡ˆä¾‹: Pebworth Co", parent: "Ch5", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nè®¡ç®— SPL Charge (Depn + Interest)ã€‚\nLiab Opening $15.4m. Interest 8%ã€‚\nDepn over shorter of lease term or useful life (if no transfer)ã€‚", page: 62 },

            // --- Chapter 6: Provisions ---
            { id: "Ch6", group: 1, label: "Ch6: é¢„è®¡è´Ÿå€º (IAS 37)", desc: "Provision, Contingent Liability/Asset", page: 64 },
            { id: "Criteria", group: 2, label: "ç¡®è®¤æ¡ä»¶", parent: "Ch6", desc: "1. Present Obligation (Legal/Constructive)\n2. Probable outflow\n3. Reliable estimateã€‚", page: 64 },
            { id: "Case_Onerous", group: 4, label: "äºæŸåˆåŒ/é‡ç»„", parent: "Ch6", desc: "Onerous Contract: Lower of cost to fulfill and penalty.\nRestructuring: Must have detailed plan & raised valid expectation [cite: 1245]ã€‚", page: 66 },

            // --- Chapter 7: Tax ---
            { id: "Ch7", group: 1, label: "Ch7: æ‰€å¾—ç¨ (IAS 12)", desc: "Current Tax & Deferred Tax", page: 69 },
            { id: "DeferredTax", group: 2, label: "é€’å»¶æ‰€å¾—ç¨", parent: "Ch7", desc: "Temporary Difference (Carrying Amount vs Tax Base) * Rateã€‚", page: 70 },
            { id: "DT_Logic", group: 3, label: "DTL/DTA è®¡ç®—", parent: "DeferredTax", desc: "DTL = (CA > TB) * Rate. è®¡å…¥ Tax Expense (é™¤éæºäº Revaluation -> OCI)ã€‚", page: 71 },

            // --- Chapter 8: Financial Instruments ---
            { id: "Ch8", group: 1, label: "Ch8: é‡‘èå·¥å…·", desc: "IFRS 9, IAS 32", page: 77 },
            { id: "FinAsset", group: 2, label: "é‡‘èèµ„äº§", parent: "Ch8", desc: "Debt: Amortized Cost (if BM is collect). Equity: FVTPL (default) or FVTOCI (election)ã€‚", page: 78 },
            { id: "FinLiab", group: 2, label: "é‡‘èè´Ÿå€º", parent: "Ch8", desc: "Amortized Cost (Effective Interest Rate method)ã€‚", page: 79 },
            { id: "Compound", group: 2, label: "æ··åˆå·¥å…· (å¯è½¬å€º)", parent: "Ch8", desc: "Split Accountingã€‚\n1. PV of principal+interest (Liability)\n2. Residual (Equity/Option)ã€‚", page: 80 },
            { id: "Case_Tenfold", group: 4, label: "æ¡ˆä¾‹: Tenfold Co", parent: "FinAsset", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nAmortized Cost calculationã€‚\nInitial FV + Transaction costsã€‚\nYear end = Open + EIR Interest - Coupon Receivedã€‚", page: 81 },

            // --- Chapter 9: Revenue ---
            { id: "Ch9", group: 1, label: "Ch9: æ”¶å…¥ (IFRS 15)", desc: "5-Step Model", page: 84 },
            { id: "Steps", group: 2, label: "äº”æ­¥æ³•", parent: "Ch9", desc: "1.Contract 2.Performance Obligations 3.Price 4.Allocate Price 5.Recognize when satisfiedã€‚", page: 85 },
            { id: "Construction", group: 3, label: "å»ºé€ åˆåŒ", parent: "Ch9", desc: "æŒ‰å®Œå·¥ç™¾åˆ†æ¯”ç¡®è®¤æ”¶å…¥ (Input/Output method)ã€‚\näºæŸåˆåŒç«‹å³ç¡®è®¤å…¨éƒ¨æŸå¤±ã€‚", page: 88 },
            { id: "Case_Quincy", group: 4, label: "æ¡ˆä¾‹: Quincy (å”®åæœåŠ¡)", parent: "Ch9", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nSale with service ($10m)ã€‚\nProduct revenue recognized at pointã€‚\nService revenue deferred and recognized over timeã€‚", page: 87 },

            // --- Chapter 10: EPS ---
            { id: "Ch10", group: 1, label: "Ch10: æ¯è‚¡æ”¶ç›Š (IAS 33)", desc: "Basic & Diluted EPS", page: 101 },
            { id: "BasicEPS", group: 2, label: "Basic EPS", parent: "Ch10", desc: "Earnings / WANS.\nBonus Issue: è§†åŒè¿™å°±å­˜åœ¨ (Restate prior yr).\nRights Issue: Calculate TERPã€‚", page: 101 },
            { id: "DilutedEPS", group: 2, label: "Diluted EPS", parent: "Ch10", desc: "Adjust earnings for interest saving (post-tax).\nAdjust shares for max potential conversionã€‚", page: 103 },

            // --- Chapter 11: Presentation ---
            { id: "Ch11", group: 1, label: "Ch11: åˆ—æŠ¥å‡†åˆ™", desc: "IAS 8, 10, 21, IFRS 13", page: 105 },
            { id: "IAS10", group: 2, label: "IAS 10 æœŸåäº‹é¡¹", parent: "Ch11", desc: "Adjusting (e.g., Customer bankruptcy confirming bad debt) vs Non-adjusting (e.g., Fire after YE)ã€‚", page: 108 },
            { id: "IAS21", group: 2, label: "IAS 21 å¤–æ±‡", parent: "Ch11", desc: "Monetary items: Retranslate at YE spot rate (Gain/Loss -> SPL).\nNon-monetary: Historical rateã€‚", page: 111 },
            { id: "Case_Jeffers", group: 4, label: "æ¡ˆä¾‹: Jeffers Co", parent: "IAS10", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nEvents analysis:\n1. Fine confirmed (Adjusting)\n2. Customer bankrupt (Adjusting)\n3. Acquisition finalized (Non-adjusting)ã€‚", page: 109 },

            // --- Chapter 12: Single Entity ---
            { id: "Ch12", group: 1, label: "Ch12: å•ä½“æŠ¥è¡¨ç¼–åˆ¶", desc: "ä» Trial Balance ç¼–åˆ¶ SOFP/SPL", page: 115 },
            { id: "Technique", group: 2, label: "ç¼–åˆ¶æŠ€å·§", parent: "Ch12", desc: "æ³¨æ„ Cost of Sales è®¡ç®— (Op Inv + Purch - Cl Inv).\næ³¨æ„ Admin Exp ä¸ Distribution Exp åˆ†ç±»ã€‚", page: 115 },

            // --- Chapter 13: Cash Flows ---
            { id: "Ch13", group: 1, label: "Ch13: ç°é‡‘æµé‡è¡¨ (IAS 7)", desc: "Indirect Method", page: 122 },
            { id: "Operating", group: 2, label: "ç»è¥æ´»åŠ¨", parent: "Ch13", desc: "PBIT + Non-cash (Depn) +/- Working Capital changes - Interest - Taxã€‚", page: 123 },
            { id: "Investing", group: 2, label: "æŠ•èµ„æ´»åŠ¨", parent: "Ch13", desc: "Purchase/Sale of NCA, Interest Receivedã€‚", page: 122 },
            { id: "Financing", group: 2, label: "èèµ„æ´»åŠ¨", parent: "Ch13", desc: "Share issue, Loan repayment, Dividend paidã€‚", page: 122 },

            // --- Chapter 14: Ratios ---
            { id: "Ch14", group: 1, label: "Ch14: è´¢æŠ¥åˆ†æ", desc: "Performance & Position", page: 128 },
            { id: "Ratios", group: 2, label: "å…³é”®æ¯”ç‡", parent: "Ch14", desc: "ROCE, Gearing, Current Ratio, Inventory Days, Receivable Daysã€‚", page: 128 },

            // --- Chapter 15 & 16: Consolidation ---
            { id: "Ch15_16", group: 1, label: "Ch15-16: åˆå¹¶æŠ¥è¡¨", desc: "IFRS 10, IFRS 3", page: 133 },
            { id: "W1_W5", group: 2, label: "äº”æ­¥æ³• (SOFP)", parent: "Ch15_16", desc: "W1: Group Structure/Cost.\nW2: Net Assets of Sub.\nW3: Goodwill.\nW4: NCI.\nW5: Group REã€‚", page: 142 },
            { id: "PURP", group: 3, label: "PURP (æœªå®ç°åˆ©æ¶¦)", parent: "Ch15_16", desc: "Inventory PURP.\nSeller = Parent: Dr RE(P), Cr Inv.\nSeller = Sub: Dr RE(S), Cr Inv (Impacts NCI)ã€‚", page: 157 },
            { id: "Goodwill_Calc", group: 3, label: "å•†èª‰è®¡ç®—", parent: "Ch15_16", desc: "Cost of Inv + FV of NCI - FV of Net Assets.\nNegative Goodwill -> Gain in SPLã€‚", page: 138 },
            { id: "Associates", group: 3, label: "è”è¥å…¬å¸ (IAS 28)", parent: "Ch15_16", desc: "Equity Accounting.\nSOFP: Cost + Share of Post-Acq Profit - Div.\nSPL: Share of Profitã€‚", page: 164 },
            { id: "Case_Golden", group: 4, label: "æ¡ˆä¾‹: Golden Co", parent: "Ch15_16", desc: "ã€æ•™æä¾‹é¢˜ã€‘\nå¤„ç½®å­å…¬å¸ (Disposal)ã€‚\nGroup Gain = Proceeds + FV retained interest - (Net Assets + Goodwill)ã€‚", page: 163 }
        ],
        links: [
            // Roots
            { source: "FR", target: "Ch1" }, { source: "FR", target: "Ch2" }, { source: "FR", target: "Ch3" },
            { source: "FR", target: "Ch4" }, { source: "FR", target: "Ch5" }, { source: "FR", target: "Ch6" },
            { source: "FR", target: "Ch7" }, { source: "FR", target: "Ch8" }, { source: "FR", target: "Ch9" },
            { source: "FR", target: "Ch10" }, { source: "FR", target: "Ch11" }, { source: "FR", target: "Ch12" },
            { source: "FR", target: "Ch13" }, { source: "FR", target: "Ch14" }, { source: "FR", target: "Ch15_16" },

            // Connections
            { source: "Ch1", target: "SOFP" }, { source: "Ch1", target: "SPL" }, { source: "Ch1", target: "SOCE" },
            { source: "Ch2", target: "Qualitative" }, { source: "Ch2", target: "Elements" }, { source: "Ch2", target: "Measurement" }, { source: "Measurement", target: "Case_Drexler" },
            { source: "Ch3", target: "IFRS_S1" },
            { source: "Ch4", target: "IAS16" }, { source: "IAS16", target: "Depreciation" }, { source: "IAS16", target: "Revaluation" }, { source: "IAS16", target: "Case_Elite" }, { source: "Revaluation", target: "Case_Topsy" },
            { source: "Ch4", target: "IAS38" }, { source: "IAS38", target: "RD" }, { source: "IAS38", target: "Case_Assoria" },
            { source: "Ch4", target: "IAS40" }, { source: "IAS40", target: "Case_Carter" },
            { source: "Ch4", target: "IAS36" }, { source: "IAS36", target: "CGU" }, { source: "IAS36", target: "Case_Riley" },
            { source: "Ch4", target: "IAS23" }, { source: "IAS23", target: "Case_Fido" },
            { source: "Ch4", target: "IAS2" }, { source: "IAS2", target: "Case_Litch" },
            { source: "Ch4", target: "IFRS5" },
            { source: "Ch4", target: "IAS41" }, { source: "IAS41", target: "Case_Shaw" },
            { source: "Ch5", target: "ROU_Liab" }, { source: "Ch5", target: "Exemptions" }, { source: "Ch5", target: "Case_Pebworth" },
            { source: "Ch6", target: "Criteria" }, { source: "Ch6", target: "Case_Onerous" },
            { source: "Ch7", target: "DeferredTax" }, { source: "DeferredTax", target: "DT_Logic" },
            { source: "Ch8", target: "FinAsset" }, { source: "Ch8", target: "FinLiab" }, { source: "Ch8", target: "Compound" }, { source: "FinAsset", target: "Case_Tenfold" },
            { source: "Ch9", target: "Steps" }, { source: "Ch9", target: "Construction" }, { source: "Ch9", target: "Case_Quincy" },
            { source: "Ch10", target: "BasicEPS" }, { source: "Ch10", target: "DilutedEPS" },
            { source: "Ch11", target: "IAS10" }, { source: "Ch11", target: "IAS21" }, { source: "IAS10", target: "Case_Jeffers" },
            { source: "Ch12", target: "Technique" },
            { source: "Ch13", target: "Operating" }, { source: "Ch13", target: "Investing" }, { source: "Ch13", target: "Financing" },
            { source: "Ch14", target: "Ratios" },
            { source: "Ch15_16", target: "W1_W5" }, { source: "Ch15_16", target: "PURP" }, { source: "Ch15_16", target: "Goodwill_Calc" }, { source: "Ch15_16", target: "Associates" }, { source: "Ch15_16", target: "Case_Golden" }
        ]
    };

    // --- 2. D3.js å›¾è°±æ¸²æŸ“é€»è¾‘ ---
    
    const width = window.innerWidth;
    const height = window.innerHeight;

    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });

    const svg = d3.select("#graph-container").append("svg")
        .attr("width", width)
        .attr("height", height)
        .call(zoom)
        .on("dblclick.zoom", null);

    const g = svg.append("g");

    // é¢œè‰²æ˜ å°„
    const colorMap = {
        0: "#ffffff", // Root
        1: "#ef4444", // Chapter
        2: "#f59e0b", // Standard/Topic
        3: "#10b981", // Detail
        4: "#8b5cf6"  // Case
    };

    const radiusMap = {
        0: 30,
        1: 20,
        2: 12,
        3: 8,
        4: 10
    };

    const simulation = d3.forceSimulation(data.nodes)
        .force("link", d3.forceLink(data.links).id(d => d.id).distance(d => {
            if (d.target.group === 1) return 150;
            if (d.target.group === 4) return 100;
            return 70;
        }))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(d => radiusMap[d.group] + 15));

    const link = g.append("g")
        .attr("stroke", "#475569")
        .attr("stroke-opacity", 0.6)
        .selectAll("line")
        .data(data.links)
        .join("line")
        .attr("stroke-width", d => Math.sqrt(2));

    const node = g.append("g")
        .selectAll("circle")
        .data(data.nodes)
        .join("circle")
        .attr("r", d => radiusMap[d.group])
        .attr("fill", d => colorMap[d.group])
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .attr("cursor", "pointer")
        .call(drag(simulation));

    const text = g.append("g")
        .selectAll("text")
        .data(data.nodes)
        .join("text")
        .text(d => d.label)
        .attr("x", 12)
        .attr("y", 4)
        .attr("font-size", d => d.group === 1 ? "14px" : "10px")
        .attr("fill", "#cbd5e1")
        .style("pointer-events", "none")
        .style("text-shadow", "1px 1px 2px #000");

    // --- 3. äº¤äº’é€»è¾‘ ---

    node.on("click", (event, d) => {
        showDetails(d);
        event.stopPropagation();
    });

    function closeSidebar() {
        document.getElementById("sidebar").classList.add("hidden");
    }

    document.getElementById("search").addEventListener("input", function(e) {
        const term = e.target.value.toLowerCase();
        if (!term) {
            node.attr("opacity", 1);
            link.attr("opacity", 0.6);
            text.attr("opacity", 1);
            return;
        }

        const matchedNodes = data.nodes.filter(n => 
            n.label.toLowerCase().includes(term) || 
            n.desc.toLowerCase().includes(term)
        );
        const matchedIds = new Set(matchedNodes.map(n => n.id));

        node.attr("opacity", d => matchedIds.has(d.id) ? 1 : 0.1);
        link.attr("opacity", d => matchedIds.has(d.source.id) && matchedIds.has(d.target.id) ? 0.6 : 0.05);
        text.attr("opacity", d => matchedIds.has(d.id) ? 1 : 0.1);
    });

    function showDetails(d) {
        const sidebar = document.getElementById("sidebar");
        const details = document.getElementById("node-details");
        
        sidebar.classList.remove("hidden");
        
        let typeLabel = "";
        if(d.group === 1) typeLabel = '<span class="tag" style="background:var(--node-chapter)">Chapter</span>';
        else if(d.group === 2) typeLabel = '<span class="tag" style="background:var(--node-standard)">Standard</span>';
        else if(d.group === 4) typeLabel = '<span class="tag" style="background:var(--node-case)">Case</span>';
        else typeLabel = '<span class="tag" style="background:var(--node-concept)">Topic</span>';

        // PDF Link Generation logic
        // Assumes "FRç”µå­æ•™æ.pdf" is in the same directory.
        let pdfLink = d.page ? `<a href="FRç”µå­æ•™æ.pdf#page=${d.page}" target="_blank" class="pdf-btn">ğŸ“– æ‰“å¼€æ•™æ (ç¬¬ ${d.page} é¡µ)<span><br>ç‚¹å‡»è·³è½¬è‡³ PDF</span></a>` : '';

        let contentHtml = `
            <h2>${typeLabel} ${d.label}</h2>
            <div class="content-block">
                <strong>æ ¸å¿ƒè¦ç‚¹ï¼š</strong><br>
                ${d.desc.replace(/\n/g, "<br>")}
            </div>
            ${pdfLink}
        `;

        if (d.group === 4) {
            contentHtml = `
                <h2>${typeLabel} ${d.label}</h2>
                <div class="example-box">
                    ${d.desc}
                </div>
                ${pdfLink}
                <p style="margin-top:15px; font-size:0.85rem; color:#94a3b8;">
                    * æ¡ˆä¾‹è§£æåŸºäºæ•™æåŸæ–‡æˆ–ç»ƒä¹ é¢˜ã€‚
                </p>
            `;
        }

        details.innerHTML = contentHtml;
    }

    function drag(simulation) {
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
    }

    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

        text
            .attr("x", d => d.x + 12)
            .attr("y", d => d.y + 4);
    });

</script>
</body>
</html>
