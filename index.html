<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACCA FR ç»ˆæå¤ä¹ å›¾è°± (å›½å†…é«˜é€Ÿç‰ˆ)</title>
    <script src="https://cdn.staticfile.net/d3/7.9.0/d3.min.js"></script>
    <style>
        :root {
            --bg-color: #020617;
            --sidebar-bg: #0f172a;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border-color: #334155;
            
            /* é¢œè‰²ç¼–ç  */
            --c-framework: #ef4444; 
            --c-assets: #f59e0b;    
            --c-liab: #10b981;      
            --c-perf: #06b6d4;      
            --c-consol: #8b5cf6;    
            --c-analy: #ec4899;     
            --c-case: #64748b;      
        }

        body { margin: 0; overflow: hidden; background: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        #container { display: flex; width: 100vw; height: 100vh; }
        
        #graph-area { flex: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        /* åŠ è½½ä¸é”™è¯¯æç¤º */
        #status-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-main); font-size: 1.2rem; text-align: center;
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px;
            z-index: 100;
        }
        .error { color: #ef4444 !important; border: 1px solid #ef4444; }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: 450px;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            position: absolute;
            right: 0; top: 0; height: 100%;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
            box-shadow: -10px 0 30px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
        }
        #sidebar.active { transform: translateX(0); }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .sidebar-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        h2 { font-size: 1.4rem; margin: 0 0 10px 0; color: var(--text-main); line-height: 1.3; border-bottom: 2px solid #334155; padding-bottom: 10px; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; color: #000; text-transform: uppercase; }

        /* è¯¦æƒ…æ¡† */
        .detail-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .detail-title { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 8px; font-weight: bold; }
        .desc { line-height: 1.8; color: #cbd5e1; font-size: 0.95rem; white-space: pre-wrap; }
        .desc strong { color: #fff; font-weight: bold; background: rgba(255,255,255,0.1); padding: 0 4px; border-radius: 2px; }
        
        /* æ¡ˆä¾‹æ¡† */
        .example-box {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--c-case);
            margin-top: 15px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            color: #e2e8f0;
            line-height: 1.6;
        }

        /* PDF æŒ‰é’® */
        .pdf-container { padding: 20px; border-top: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .pdf-btn {
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #e11d48, #be123c);
            color: white; text-decoration: none;
            padding: 12px; border-radius: 8px; font-weight: bold;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
            border: 1px solid #be123c;
        }
        .pdf-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(225, 29, 72, 0.5); }

        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-sub); font-size: 1.8rem; cursor: pointer; }
        .close-btn:hover { color: white; }

        /* æœç´¢ä¸å›¾ä¾‹ */
        #controls { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); backdrop-filter: blur(5px); }
        #search { background: #020617; border: 1px solid var(--border-color); color: white; padding: 8px 12px; border-radius: 6px; width: 220px; outline: none; }
        .legend-item { display: flex; align-items: center; margin-top: 8px; font-size: 0.8rem; color: var(--text-sub); }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }

    </style>
</head>
<body>

<div id="container">
    <div id="graph-area">
        <div id="status-msg">èµ„æºåŠ è½½ä¸­...<br>å¦‚æœé•¿æ—¶é—´æ— ååº”ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å·²ä¿å­˜ä¸º .html æ–‡ä»¶</div>
        <div id="controls">
            <input type="text" id="search" placeholder="ğŸ” æœç´¢çŸ¥è¯†ç‚¹...">
            <div style="margin-top:15px; border-top:1px solid #334155; padding-top:10px;">
                <div class="legend-item"><div class="dot" style="background:var(--c-framework)"></div>æ¦‚å¿µä¸ç›‘ç®¡</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-assets)"></div>èµ„äº§å‡†åˆ™</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-liab)"></div>è´Ÿå€º/æƒç›Š</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-perf)"></div>ç»©æ•ˆ/æ”¶å…¥</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-consol)"></div>åˆå¹¶æŠ¥è¡¨</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-analy)"></div>åˆ†æ</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-case)"></div>æ¡ˆä¾‹</div>
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <div class="sidebar-header">
            <button class="close-btn" onclick="toggleSidebar(false)">Ã—</button>
            <div id="header-content"></div>
        </div>
        <div class="sidebar-body">
            <div id="body-content"></div>
        </div>
        <div class="pdf-container" id="pdf-footer"></div>
    </div>
</div>

<script>
    // å…¨å±€é”™è¯¯æ•æ‰
    window.onerror = function(msg, source, lineno, colno, error) {
        const statusDiv = document.getElementById('status-msg');
        statusDiv.innerHTML = `âš ï¸ ç¨‹åºå‘ç”Ÿé”™è¯¯:<br>${msg}<br>è¯·æ£€æŸ¥ä»£ç å®Œæ•´æ€§ã€‚`;
        statusDiv.classList.add('error');
        return false;
    };

    // ç­‰å¾… D3 åŠ è½½
    window.onload = function() {
        if (typeof d3 === 'undefined') {
            const statusDiv = document.getElementById('status-msg');
            statusDiv.innerHTML = "âš ï¸ D3.js åº“åŠ è½½å¤±è´¥ã€‚<br>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–ç¡®ä¿èƒ½è®¿é—® cdn.staticfile.netã€‚";
            statusDiv.classList.add('error');
            return;
        }
        initGraph();
    };

    function initGraph() {
        const statusDiv = document.getElementById('status-msg');
        statusDiv.style.display = 'none';

        // --- æ•°æ®å®šä¹‰ ---
        const nodes = [
            { id: "Root", label: "ACCA FR æ ¸å¿ƒå›¾è°±", group: 0, r: 45, page: 1, desc: "Financial Reporting çŸ¥è¯†ä½“ç³»æ¦‚è§ˆ" },

            // === 1. æ¦‚å¿µä¸ç›‘ç®¡ (Red) ===
            { id: "Mod_Frame", label: "æ¦‚å¿µä¸ç›‘ç®¡", group: 1, parent: "Root", page: 9, desc: "è´¢åŠ¡æŠ¥å‘Šçš„ç†è®ºåŸºçŸ³ã€‚" },
            { id: "Ch2", label: "æ¦‚å¿µæ¡†æ¶", group: 1, parent: "Mod_Frame", page: 9, desc: "ä¸ºå‡†åˆ™åˆ¶å®šæä¾›ç†è®ºåŸºç¡€ï¼Œæœ¬èº«ä¸æ˜¯å‡†åˆ™ã€‚\nå½“å‡†åˆ™ä¸æ¡†æ¶å†²çªæ—¶ï¼Œ**å‡†åˆ™ä¼˜å…ˆ** (IFRS overrides Framework)ã€‚" },
            [cite_start]{ id: "Qual", label: "è´¨é‡ç‰¹å¾", group: 1, parent: "Ch2", page: 10, desc: "â— **åŸºæœ¬ç‰¹å¾:** ç›¸å…³æ€§ (Relevance)ã€å¦‚å®åæ˜  (Faithful Rep)ã€‚\nâ— **å¼ºåŒ–ç‰¹å¾:** å¯æ¯”æ€§ã€å¯éªŒè¯æ€§ã€åŠæ—¶æ€§ã€å¯ç†è§£æ€§ [cite: 103-110]ã€‚" },
            [cite_start]{ id: "Meas", label: "è®¡é‡åŸºç¡€", group: 1, parent: "Ch2", page: 13, desc: "â— **å†å²æˆæœ¬:** è´­ä¹°ä»· + äº¤æ˜“è´¹ã€‚\nâ— **ç°è¡Œä»·å€¼:**\n  1. å…¬å…ä»·å€¼ (FV): å¸‚åœºé€€å‡ºä»·æ ¼ (Exit price)ã€‚\n  2. ä½¿ç”¨ä»·å€¼ (VIU): ç°é‡‘æµæŠ˜ç°ã€‚\n  3. ç°è¡Œæˆæœ¬ (Current Cost): é‡ç½®æˆæœ¬ [cite: 140-147]ã€‚" },
            { id: "S1", label: "IFRS S1 å¯æŒç»­", group: 1, parent: "Mod_Frame", page: 19, desc: "æ ¸å¿ƒæŠ«éœ²ï¼šGovernance, Strategy, Risk Mgmt, Metrics & Targetsã€‚" },

            // === 2. èµ„äº§ (Yellow) ===
            { id: "Mod_Asset", label: "èµ„äº§å‡†åˆ™", group: 2, parent: "Root", page: 23, desc: "æ ¸å¿ƒèµ„äº§ç±»çš„ç¡®è®¤ã€è®¡é‡ä¸æŠ«éœ²ã€‚" },
            
            // IAS 16
            { id: "IAS16", label: "IAS 16 å›ºå®šèµ„äº§", group: 2, parent: "Mod_Asset", page: 23, desc: "æœ‰å½¢èµ„äº§ï¼Œä½¿ç”¨è¶…è¿‡ä¸€æœŸã€‚" },
            { id: "Init", label: "åˆå§‹è®¡é‡", group: 2, parent: "IAS16", page: 24, desc: "Cost = è´­ä¹°ä»· + è¿›å£ç¨ + **ç›´æ¥å½’å±è´¹ç”¨** (åœºåœ°å‡†å¤‡ã€è¿è´¹ã€å®‰è£…ã€æµ‹è¯•) + **æ‹†é™¤æˆæœ¬ç°å€¼** (IAS 37)ã€‚\nâŒ ä¸åŒ…æ‹¬ï¼šç®¡ç†è´¹ã€åŸ¹è®­è´¹ã€å¯åŠ¨äºæŸã€‚" },
            { id: "Reval", label: "é‡ä¼°æ¨¡å‹", group: 2, parent: "IAS16", page: 25, desc: "â— **å¢å€¼ (Gain):** è®¡å…¥ OCI (RS)ã€‚\nâ— **å‡å€¼ (Loss):** å…ˆå†² RSï¼Œåè¿› SPLã€‚\nâ— **å¤šä½™æŠ˜æ—§:** æ¯å¹´å¯ä» RS è½¬å…¥ REã€‚" },
            { id: "Case_Topsy", label: "æ¡ˆä¾‹: Topsy Co", group: 7, parent: "Reval", page: 25, desc: "ã€é‡ä¼°è®¡ç®—ã€‘\n1. **å¤šä½™æŠ˜æ—§:** æ–°æŠ˜æ—§($30k) - æ—§æŠ˜æ—§($15k) = $15k (Dr RS, Cr RE)ã€‚\n2. **åœŸåœ°é‡ä¼°:** FV $950k - Cost $800k = +$150k (Dr Asset, Cr RS)ã€‚\n3. **æœŸæœ« RS:** $705k - $15k + $150k = **$840,000**ã€‚" },

            // IAS 38
            { id: "IAS38", label: "IAS 38 æ— å½¢èµ„äº§", group: 2, parent: "Mod_Asset", page: 30, desc: "æ— å®ç‰©å½¢æ€èµ„äº§ã€‚" },
            { id: "RD", label: "R&D ç ”å‘", group: 2, parent: "IAS38", page: 31, desc: "â— **ç ”ç©¶ (Research):** è´¹ç”¨åŒ– (Expense)ã€‚\nâ— **å¼€å‘ (Development):** èµ„æœ¬åŒ– (Capitalize)ï¼Œéœ€æ»¡è¶³ PIRATE æ¡ä»¶ (Probable benefits, Intention, Resources, Ability, Tech feasibility, Expenditure)ã€‚" },
            { id: "Case_Assoria", label: "æ¡ˆä¾‹: Assoria", group: 7, parent: "RD", page: 33, desc: "ã€R&D æ‘Šé”€ã€‘\nResearch cost ($1.4m) -> SPLã€‚\næ‘Šé”€ä» **Ready for use** (Asset available) çš„æ—¶ç‚¹å¼€å§‹ï¼Œè€Œéé¡¹ç›®å¼€å§‹æ—¶ã€‚" },

            // IAS 40
            { id: "IAS40", label: "IAS 40 æŠ•èµ„æˆ¿äº§", group: 2, parent: "Mod_Asset", page: 35, desc: "èµšç§Ÿé‡‘æˆ–èµ„æœ¬å¢å€¼ã€‚" },
            { id: "FV_Mod", label: "å…¬å…ä»·å€¼æ¨¡å‹", group: 2, parent: "IAS40", page: 36, desc: "é»˜è®¤æ¨¡å‹ã€‚æœŸæœ«æŒ‰ FV è®¡é‡ï¼Œ**å˜åŠ¨è¿› SPL**ã€‚**ä¸æŠ˜æ—§**ã€‚\n(æ³¨æ„ä¸ IAS 16 é‡ä¼°è¿› OCI çš„åŒºåˆ«)ã€‚" },

            // IAS 36
            { id: "IAS36", label: "IAS 36 å‡å€¼", group: 2, parent: "Mod_Asset", page: 39, desc: "å½“ Carrying Amount > Recoverable Amount æ—¶å‡å€¼ã€‚" },
            { id: "RA_Calc", label: "å¯å›æ”¶é‡‘é¢ (RA)", group: 2, parent: "IAS36", page: 40, desc: "RA = **Higher of**:\n1. FV less Cost to Sell (å‡€å…¬å…ä»·å€¼)\n2. Value in Use (æœªæ¥ç°é‡‘æµæŠ˜ç°)ã€‚" },
            { id: "Case_Riley", label: "æ¡ˆä¾‹: Riley", group: 7, parent: "RA_Calc", page: 42, desc: "ã€å‡å€¼è®¡ç®—ã€‘\nNBV=$50kã€‚\nFV-CTS=$30k; VIU=$31,875ã€‚\nRA=$31,875 (å–é«˜å€¼)ã€‚\nImpairment = $50k - $31,875 = **$18,125**ã€‚" },

            // IAS 23 & 2
            { id: "IAS23", label: "IAS 23 å€Ÿæ¬¾è´¹ç”¨", group: 2, parent: "Mod_Asset", page: 44, desc: "Qualifying Asset éœ€èµ„æœ¬åŒ–ã€‚\nèµ„æœ¬åŒ– = å®é™…åˆ©æ¯ - é—²ç½®èµ„é‡‘æ”¶ç›Šã€‚" },
            { id: "IAS2", label: "IAS 2 å­˜è´§", group: 2, parent: "Mod_Asset", page: 46, desc: "è®¡é‡ï¼š**Lower of Cost and NRV**ã€‚\nNRV = å”®ä»· - å®Œå·¥æˆæœ¬ - é”€å”®æˆæœ¬ã€‚" },

            // === 3. è´Ÿå€ºä¸æƒç›Š (Green) ===
            { id: "Mod_Liab", label: "è´Ÿå€ºä¸æƒç›Š", group: 3, parent: "Root", page: 57, desc: "èèµ„å·¥å…·ä¸ä¹‰åŠ¡ã€‚" },
            
            // IFRS 16
            { id: "IFRS16", label: "IFRS 16 ç§Ÿèµ", group: 3, parent: "Mod_Liab", page: 57, desc: "æ‰¿ç§Ÿäººæ¨¡å‹ï¼šROU Asset + Lease Liabilityã€‚" },
            { id: "L_Calc", label: "è®¡é‡é€»è¾‘", group: 3, parent: "IFRS16", page: 58, desc: "â— **è´Ÿå€º:** ä»˜æ¬¾é¢ç°å€¼ã€‚åç»­æŒ‰æ‘Šä½™æˆæœ¬ã€‚\nâ— **èµ„äº§:** åˆå§‹è´Ÿå€º + ç›´æ¥è´¹ + æ‹†é™¤è´¹ã€‚åç»­æŒ‰æˆæœ¬æŠ˜æ—§ã€‚" },
            { id: "Case_Pebworth", label: "æ¡ˆä¾‹: Pebworth", group: 7, parent: "L_Calc", page: 62, desc: "ã€è´¹ç”¨è®¡ç®—ã€‘\nSPL Charge = æŠ˜æ—§ (ROU/Life) + èèµ„æˆæœ¬ (Opening Liab * Rate)ã€‚" },

            // IAS 37
            { id: "IAS37", label: "IAS 37 é¢„è®¡è´Ÿå€º", group: 3, parent: "Mod_Liab", page: 64, desc: "ç¡®è®¤ä¸‰è¦ç´ ï¼šPresent Obligation + Probable Outflow + Reliable Estimateã€‚" },
            { id: "Case_Onerous", label: "äºæŸåˆåŒ", group: 7, parent: "IAS37", page: 65, desc: "Onerous Contract Provision = Lower of (å±¥è¡Œæˆæœ¬, è¿çº¦ç½šé‡‘)ã€‚" },

            // IAS 12
            { id: "IAS12", label: "IAS 12 æ‰€å¾—ç¨", group: 3, parent: "Mod_Liab", page: 69, desc: "é€’å»¶ç¨ (DT) = (è´¦é¢ä»·å€¼ - è®¡ç¨åŸºç¡€) * ç¨ç‡ã€‚\nå˜åŠ¨é¢è®¡å…¥ Tax Expense (æˆ– OCI)ã€‚" },

            // IFRS 9
            { id: "IFRS9", label: "IFRS 9 é‡‘èå·¥å…·", group: 3, parent: "Mod_Liab", page: 77, desc: "â— **èµ„äº§:** Amortized Cost / FVTPL / FVTOCIã€‚\nâ— **è´Ÿå€º:** Amortized Costã€‚" },
            { id: "IAS32", label: "æ··åˆå·¥å…·", group: 3, parent: "IFRS9", page: 80, desc: "å¯è½¬å€ºæ‹†åˆ† (Split Accounting):\n1. **è´Ÿå€º:** ç°é‡‘æµæŒ‰å¸‚åœºåˆ©ç‡æŠ˜ç°ã€‚\n2. **æƒç›Š:** å‘è¡Œå¾—æ¬¾ - è´Ÿå€ºéƒ¨åˆ†ã€‚" },

            // === 4. ç»©æ•ˆ (Cyan) ===
            { id: "Mod_Perf", label: "ç»©æ•ˆæŠ¥è¡¨", group: 4, parent: "Root", page: 84, desc: "æ”¶å…¥ä¸ EPSã€‚" },
            { id: "IFRS15", label: "IFRS 15 æ”¶å…¥", group: 4, parent: "Mod_Perf", page: 84, desc: "äº”æ­¥æ³•ï¼šåˆåŒ -> PO -> ä»·æ ¼ -> åˆ†æ‘Š -> ç¡®è®¤ã€‚" },
            { id: "Step5", label: "ç¡®è®¤æ—¶ç‚¹", group: 4, parent: "IFRS15", page: 85, desc: "â— **æ—¶ç‚¹ (Point in time):** æ§åˆ¶æƒè½¬ç§»æ—¶ã€‚\nâ— **æ—¶æ®µ (Over time):** å¦‚å»ºé€ åˆåŒã€æœåŠ¡ã€‚" },
            { id: "Cons_Cont", label: "å»ºé€ åˆåŒ", group: 4, parent: "IFRS15", page: 88, desc: "æŒ‰è¿›åº¦ (Input/Output) ç¡®è®¤ã€‚\näºæŸåˆåŒç«‹å³ç¡®è®¤å…¨éƒ¨æŸå¤±ã€‚" },
            
            { id: "IAS33", label: "IAS 33 EPS", group: 4, parent: "Mod_Perf", page: 101, desc: "Basic EPS = Earnings / WANSã€‚\nDiluted EPS éœ€è°ƒæ•´å¯è½¬å€º(åŠ å›åˆ©æ¯)å’ŒæœŸæƒ(å…è´¹è‚¡)ã€‚" },

            // === 5. åˆå¹¶æŠ¥è¡¨ (Purple - é‡ç‚¹) ===
            { id: "Mod_Consol", label: "åˆå¹¶æŠ¥è¡¨", group: 5, parent: "Root", page: 133, desc: "IFRS 10 & IFRS 3ã€‚" },
            { id: "Process", label: "åˆå¹¶äº”æ­¥æ³• (SOFP)", group: 5, parent: "Mod_Consol", page: 142, desc: "W1 ç»“æ„, W2 å‡€èµ„äº§, W3 å•†èª‰, W4 NCI, W5 é›†å›¢REã€‚" },
            { id: "W3", label: "W3: å•†èª‰", group: 5, parent: "Process", page: 154, desc: "Goodwill = Cost + NCI - Net Assets @ Acqã€‚\nå‡å€¼ (Impairment) è®¡å…¥è´¹ç”¨ã€‚" },
            { id: "W4", label: "W4: NCI", group: 5, parent: "Process", page: 154, desc: "NCI = NCI @ Acq + NCI% * (Post-acq Net Assets Change)ã€‚" },
            
            { id: "Adj", label: "åˆå¹¶è°ƒæ•´", group: 5, parent: "Mod_Consol", page: 156, desc: "æŠµæ¶ˆå†…éƒ¨äº¤æ˜“ã€‚" },
            { id: "PURP", label: "PURP (æœªå®ç°åˆ©æ¶¦)", group: 5, parent: "Adj", page: 157, desc: "å­˜è´§äº¤æ˜“æŠµæ¶ˆï¼š\nâ— **æ¯å–å­:** Dr Group RE, Cr Group Invã€‚\nâ— **å­å–æ¯:** Dr Sub RE (å½±å“ NCI), Cr Group Invã€‚" },
            
            { id: "Assoc", label: "IAS 28 è”è¥å…¬å¸", group: 5, parent: "Mod_Consol", page: 164, desc: "æƒç›Šæ³• (Equity Method)ã€‚\nSOFP: Cost + Share of Post-acq Profit - Dividendã€‚" },
            { id: "Case_Golden", label: "æ¡ˆä¾‹: Golden Co", group: 7, parent: "Mod_Consol", page: 163, desc: "ã€å¤„ç½®å­å…¬å¸ã€‘\nGain = Proceeds + FV Retained Interest - (Net Assets @ Disposal + Goodwill)ã€‚" },

            // === 6. åˆ†æ (Pink) ===
            { id: "Mod_Analy", label: "åˆ†æä¸è§£è¯»", group: 6, parent: "Root", page: 128, desc: "æ¯”ç‡ä¸ç°é‡‘æµã€‚" },
            { id: "Ratios", label: "è´¢åŠ¡æ¯”ç‡", group: 6, parent: "Mod_Analy", page: 128, desc: "ROCE, Gearing, Liquidity, Working Capital daysã€‚" },
            { id: "Cashflow", label: "IAS 7 ç°é‡‘æµ", group: 6, parent: "Mod_Analy", page: 122, desc: "ç»è¥ (Operating), æŠ•èµ„ (Investing), èèµ„ (Financing)ã€‚" }
        ];

        // ç”Ÿæˆè¿çº¿ (é˜²é”™å¤„ç†)
        const nodeMap = new Map(nodes.map(n => [n.id, n]));
        const links = [];
        nodes.forEach(n => {
            if (n.parent) {
                if (nodeMap.has(n.parent)) {
                    links.push({ source: n.parent, target: n.id });
                } else {
                    console.warn(`Parent node '${n.parent}' not found for '${n.id}'`);
                }
            }
        });

        // --- D3 æ¸²æŸ“ ---
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        const svg = d3.select("#graph-area").append("svg")
            .attr("width", width).attr("height", height)
            .call(d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => g.attr("transform", e.transform)))
            .on("dblclick.zoom", null);

        const g = svg.append("g");

        // é¢œè‰²
        const colorMap = {
            0: "#fff", 1: "#ef4444", 2: "#f59e0b", 3: "#10b981", 4: "#06b6d4", 5: "#8b5cf6", 6: "#ec4899", 7: "#64748b"
        };

        // æ¨¡æ‹Ÿ
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(d => d.group === 7 ? 60 : 100))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(35));

        // çº¿
        const link = g.append("g").selectAll("line")
            .data(links).join("line")
            .attr("stroke", "#334155").attr("stroke-width", 1.5).attr("stroke-opacity", 0.6);

        // èŠ‚ç‚¹
        const node = g.append("g").selectAll("g")
            .data(nodes).join("g")
            .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend))
            .on("click", (e, d) => { e.stopPropagation(); showInfo(d); });

        node.append("circle")
            .attr("r", d => d.group === 0 ? 40 : (d.group === 7 ? 10 : 18))
            .attr("fill", d => colorMap[d.group])
            .attr("stroke", "#fff").attr("stroke-width", 2)
            .style("cursor", "pointer");

        node.append("text")
            .text(d => d.label)
            .attr("x", d => d.group === 0 ? 45 : 22)
            .attr("y", 5)
            .style("font-size", d => d.group === 0 ? "18px" : "12px")
            .style("fill", "#e2e8f0")
            .style("pointer-events", "none")
            .style("text-shadow", "2px 2px 3px #000");

        // äº¤äº’
        function dragstart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
        function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
        function dragend(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // æœç´¢
        document.getElementById("search").addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            node.style("opacity", d => d.label.toLowerCase().includes(val) ? 1 : 0.1);
            link.style("opacity", d => d.source.label.toLowerCase().includes(val) || d.target.label.toLowerCase().includes(val) ? 1 : 0.05);
        });
    }

    function toggleSidebar(show) {
        const sb = document.getElementById("sidebar");
        show ? sb.classList.add("active") : sb.classList.remove("active");
    }

    function showInfo(d) {
        const header = document.getElementById("header-content");
        const body = document.getElementById("body-content");
        const footer = document.getElementById("pdf-footer");
        
        const groupNames = ["Core", "Framework", "Assets", "Liabilities", "Performance", "Consolidation", "Analysis", "Case"];
        const colors = ["#fff", "#ef4444", "#f59e0b", "#10b981", "#06b6d4", "#8b5cf6", "#ec4899", "#64748b"];
        
        header.innerHTML = `<span class="badge" style="background:${colors[d.group]}">${groupNames[d.group]}</span><h2>${d.label}</h2>`;
        
        let descHtml = '';
        if (d.group === 7) {
            descHtml = `<div class="example-box">${formatText(d.desc)}</div>`;
        } else if (d.desc) {
            descHtml = `<div class="detail-box"><div class="detail-title" style="color:${colors[d.group]}">çŸ¥è¯†è¦ç‚¹</div><div class="desc">${formatText(d.desc)}</div></div>`;
        }
        body.innerHTML = descHtml || `<div class="desc" style="text-align:center; color:#64748b;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹æ•™æè¯¦æƒ…</div>`;

        if (d.page) {
            footer.innerHTML = `<a href="FRç”µå­æ•™æ.pdf#page=${d.page}" target="_blank" class="pdf-btn"><span>ğŸ“–</span> æ‰“å¼€æ•™æ (ç¬¬ ${d.page} é¡µ)</a>`;
        } else {
            footer.innerHTML = '';
        }
        toggleSidebar(true);
    }

    function formatText(text) {
        if (!text) return "";
        text = text.replace(/\/g, '<span style="color:#64748b; font-size:0.8em;">$&</span>');
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong style="color:#fff; background:rgba(255,255,255,0.1);">$1</strong>');
        return text;
    }
</script>
</body>
</html>
