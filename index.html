<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACCA FR è€ƒç‚¹å…¨æ™¯å›¾è°± (èƒŒè¯µç‰ˆ)</title>
    <script src="https://lib.baomitu.com/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border-color: #334155;
            
            /* é¢œè‰²ç¼–ç  */
            --c-framework: #ef4444; --c-assets: #f59e0b; --c-liab: #10b981;
            --c-perf: #06b6d4; --c-consol: #8b5cf6; --c-analy: #ec4899; --c-case: #64748b;
            --c-highlight: #f43f5e; /* é‡ç‚¹é«˜äº®è‰² */
        }

        body { margin: 0; overflow: hidden; background: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
        #container { display: flex; width: 100vw; height: 100vh; }
        #graph-area { flex: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: 480px; background: var(--sidebar-bg); border-left: 1px solid var(--border-color);
            position: absolute; right: 0; top: 0; height: 100%;
            transform: translateX(100%); transition: transform 0.3s ease; z-index: 20;
            box-shadow: -10px 0 30px rgba(0,0,0,0.6); display: flex; flex-direction: column;
        }
        #sidebar.active { transform: translateX(0); }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .sidebar-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        h2 { margin: 0 0 10px 0; color: var(--text-main); border-bottom: 2px solid #334155; padding-bottom: 10px; font-size: 1.4rem; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; color: #000; }

        /* è¯¦æƒ…å†…å®¹æ ·å¼ */
        .detail-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .detail-title { color: var(--text-sub); font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        
        .desc { line-height: 1.7; color: #cbd5e1; font-size: 0.95rem; white-space: pre-wrap; }
        
        /* é«˜äº®æ ·å¼ */
        .highlight-box { border-left: 4px solid var(--c-highlight); background: rgba(244, 63, 94, 0.1); padding: 10px 15px; margin: 10px 0; border-radius: 0 4px 4px 0; }
        .tag-exam { color: #f43f5e; font-weight: bold; font-size: 0.85em; border: 1px solid #f43f5e; padding: 1px 4px; border-radius: 3px; margin-right: 5px; }
        .tag-mem { color: #fbbf24; font-weight: bold; font-size: 0.85em; border: 1px solid #fbbf24; padding: 1px 4px; border-radius: 3px; margin-right: 5px; }

        /* æ¡ˆä¾‹æ¡† */
        .example-box { background: #0f172a; padding: 15px; border-left: 4px solid var(--c-case); border-radius: 6px; font-family: monospace; white-space: pre-wrap; color: #e2e8f0; font-size: 0.9rem; }

        /* PDF æŒ‰é’® */
        .pdf-container { padding: 20px; border-top: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .pdf-btn {
            display: flex; align-items: center; justify-content: center; width: 100%;
            background: linear-gradient(135deg, #dc2626, #991b1b); color: white; text-decoration: none;
            padding: 12px; border-radius: 8px; font-weight: bold; border: 1px solid #7f1d1d;
            transition: all 0.2s;
        }
        .pdf-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4); }

        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-sub); font-size: 1.8rem; cursor: pointer; }
        
        /* æœç´¢æ  */
        #controls { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
        #search { background: #020617; border: 1px solid var(--border-color); color: white; padding: 8px 12px; border-radius: 6px; width: 220px; outline: none; }
        .legend-item { display: flex; align-items: center; margin-top: 8px; font-size: 0.8rem; color: var(--text-sub); }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>

<div id="container">
    <div id="graph-area">
        <div id="controls">
            <input type="text" id="search" placeholder="ğŸ” æœç´¢è€ƒç‚¹ (å¦‚: Goodwil)...">
            <div style="margin-top:15px; border-top:1px solid #334155; padding-top:10px;">
                <div class="legend-item"><div class="dot" style="background:var(--c-framework)"></div>æ¦‚å¿µä¸ç›‘ç®¡</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-assets)"></div>èµ„äº§å‡†åˆ™</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-liab)"></div>è´Ÿå€º/æƒç›Š</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-perf)"></div>ç»©æ•ˆ/æ”¶å…¥</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-consol)"></div>åˆå¹¶æŠ¥è¡¨</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-analy)"></div>åˆ†æ</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-case)"></div>æ¡ˆä¾‹</div>
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <div class="sidebar-header">
            <button class="close-btn" onclick="toggleSidebar(false)">Ã—</button>
            <div id="header-content"></div>
        </div>
        <div class="sidebar-body">
            <div id="body-content"></div>
        </div>
        <div class="pdf-container" id="pdf-footer"></div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒæ•°æ®æº (é›†æˆæ•™æè€ƒç‚¹) ---
    const nodes = [
        { id: "Root", label: "ACCA FR è€ƒç‚¹å…¨å›¾", group: 0, r: 45, page: 1, desc: "åŒ…å«æ‰€æœ‰ã€èƒŒè¿‡ã€‘ã€è€ƒç‚¹ã€‘ã€é‡ç‚¹ã€‘æ ‡è®°å†…å®¹" },

        // === 1. æ¦‚å¿µä¸ç›‘ç®¡ (Red) ===
        { id: "Mod_Frame", label: "æ¦‚å¿µä¸ç›‘ç®¡", group: 1, parent: "Root", page: 9 },
        
        // Ch2 Conceptual Framework
        { id: "Ch2", label: "æ¦‚å¿µæ¡†æ¶", group: 1, parent: "Mod_Frame", page: 9, desc: "ã€âš¡è€ƒç‚¹ã€‘å½“å‡†åˆ™ä¸æ¦‚å¿µæ¡†æ¶å†²çªæ—¶ï¼Œ**å‡†åˆ™ä¼˜å…ˆ** (IFRS overrides Framework)ã€‚" },
        { id: "Elements", label: "äº”å¤§è¦ç´ å®šä¹‰", group: 1, parent: "Ch2", page: 12, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\n1. **Asset:** Present economic resource controlled by entity as a result of past events.\n2. **Liability:** Present obligation to transfer economic resource due to past events.\n3. **Equity:** Residual interest in assets after deducting liabilities." },
        { id: "Meas", label: "è®¡é‡åŸºç¡€", group: 1, parent: "Ch2", page: 13, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\n1. **Historical Cost:** å†å²æˆæœ¬ã€‚\n2. **Current Cost:** ç°è¡Œæˆæœ¬ (Equivalent asset cost).\n3. **Fair Value:** Exit price (è„±æ‰‹ä»·).\n4. **Value in Use:** PV of cash flows (ä½¿ç”¨ä»·å€¼)." },

        // Ch3 Regulatory
        { id: "NFP", label: "éè¥åˆ©ç»„ç»‡ (NFP)", group: 1, parent: "Mod_Frame", page: 21, desc: "ã€âš¡è€ƒç‚¹ã€‘\nNFP **éœ€è¦è®¡ç®—**çš„æ¯”ç‡: Current/Quick ratio, Inventory/Rec/Pay days.\nNFP **ä¸éœ€è¦è®¡ç®—**çš„æ¯”ç‡: GP/OP margin, ROCE, EPS." },

        // === 2. èµ„äº§ (Yellow) ===
        { id: "Mod_Asset", label: "èµ„äº§å‡†åˆ™", group: 2, parent: "Root", page: 23 },
        
        // IAS 16
        { id: "IAS16", label: "IAS 16 å›ºå®šèµ„äº§", group: 2, parent: "Mod_Asset", page: 23 },
        { id: "IAS16_Cost", label: "æˆæœ¬æ„æˆ", group: 2, parent: "IAS16", page: 24, desc: "ã€âš¡è€ƒç‚¹ã€‘\nåŒ…å«: åœºåœ°å‡†å¤‡ã€è¿è´¹ã€å®‰è£…æµ‹è¯•ã€æ‹†é™¤æˆæœ¬(PV)ã€‚\nâŒ ä¸åŒ…å«: **Start-up costs**, Staff training, Admin overheads." },
        { id: "IAS16_Depn", label: "æŠ˜æ—§è§„åˆ™", group: 2, parent: "IAS16", page: 25, desc: "ã€âš¡åˆ’é‡ç‚¹ã€‘\n1. æŠ˜æ—§å§‹äº **Ready for use** (éå¼€å§‹ä½¿ç”¨æ—¶)ã€‚\n2. é—²ç½®èµ„äº§ (Idle) **ä»éœ€æŠ˜æ—§** (é™¤éæŒæœ‰å¾…å”®)ã€‚\n3. æ¯å¹´å¤æ ¸æ®‹å€¼ã€å¯¿å‘½ã€æ–¹æ³•ã€‚" },
        { id: "IAS16_Reval", label: "é‡ä¼°æ¨¡å‹", group: 2, parent: "IAS16", page: 25, desc: "ã€âš¡è€ƒç‚¹ã€‘\n1. é¢‘ç‡: åªè¦ FV å˜åŠ¨é‡å¤§å³é‡ä¼°ã€‚\n2. èŒƒå›´: åŒç±»èµ„äº§å¿…é¡» **å…¨éƒ¨é‡ä¼°** (Entire class)ã€‚\n3. æŠµæ¶ˆ: ä¸åŒèµ„äº§ç›ˆäº **ä¸å¯æŠµæ¶ˆ** (Cannot offset)ã€‚\n4. è½¬ç§»: å¤šä½™æŠ˜æ—§ (Excess depn) å¯è½¬å…¥ REã€‚" },

        // IAS 38
        { id: "IAS38", label: "IAS 38 æ— å½¢èµ„äº§", group: 2, parent: "Mod_Asset", page: 30 },
        { id: "RD", label: "R&D ç ”å‘", group: 2, parent: "IAS38", page: 31, desc: "ã€âš¡è€ƒç‚¹ã€‘\nç ”å‘è´¹ç”¨(è´¹ç”¨åŒ–éƒ¨åˆ†)å±é‡å¤§ä¸€æ¬¡æ€§è´¹ç”¨ï¼Œéœ€åœ¨ SPL **å•ç‹¬åˆ—ç¤º**ã€‚\nèµ„æœ¬åŒ–éœ€æ»¡è¶³ PIRATE æ¡ä»¶ã€‚" },
        { id: "IAS38_Meas", label: "åç»­è®¡é‡", group: 2, parent: "IAS38", page: 32, desc: "ã€âš¡è€ƒç‚¹ã€‘\n1. æ‘Šé”€æ–¹æ³•åº”åæ˜ æ¶ˆè€—æ¨¡å¼ã€‚\n2. é‡ä¼°æ³•å‰æ: å¿…é¡»æœ‰ **æ´»è·ƒå¸‚åœº** (Active Market)ã€‚\n3. åç»­è®¡é‡ä¸å¿…ä¸ PPE ä¿æŒä¸€è‡´ã€‚" },
        { id: "IAS38_Life", label: "ä½¿ç”¨å¯¿å‘½", group: 2, parent: "IAS38", page: 32, desc: "ã€âš¡è€ƒç‚¹ã€‘\n1. æœ‰æ˜ç¡®å¯¿å‘½: æŒ‰å¯¿å‘½æ‘Šé”€ã€‚\n2. æ— æ˜ç¡®å¯¿å‘½ (Indefinite): **ä¸æ‘Šé”€**ï¼Œä½†æ¯å¹´å¿…é¡»åš **å‡å€¼æµ‹è¯•**ã€‚" },

        // IAS 40
        { id: "IAS40", label: "IAS 40 æŠ•èµ„æˆ¿äº§", group: 2, parent: "Mod_Asset", page: 35, desc: "ã€âš¡è€ƒç‚¹ã€‘\n1. FV Model (é»˜è®¤): å˜åŠ¨è¿› SPL (æŠ•èµ„æ´»åŠ¨)ï¼Œ**ä¸æŠ˜æ—§**ã€‚\n2. è‡ªç”¨éƒ¨åˆ†ä¸é‡å¤§: æ•´ä½“æŒ‰æŠ•èµ„æˆ¿äº§å¤„ç†ã€‚\n3. å¤„ç½®ç›ˆäº: å½’ç±»ä¸º **æŠ•èµ„æ´»åŠ¨**ã€‚" },

        // IAS 36
        { id: "IAS36", label: "IAS 36 å‡å€¼", group: 2, parent: "Mod_Asset", page: 39 },
        { id: "Imp_Test", label: "å‡å€¼æµ‹è¯•", group: 2, parent: "IAS36", page: 40, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nImpairment if Carrying Amount > Recoverable Amount.\nRA = Higher of (FV-CTS, VIU).\næŸå¤±è¿› SPL (é™¤éæœ‰ RS)ã€‚" },
        { id: "Imp_Mandatory", label: "å¼ºåˆ¶æµ‹è¯•", group: 2, parent: "IAS36", page: 39, desc: "ã€âš¡é«˜é¢‘è€ƒç‚¹ã€‘\nå³ä¾¿æ— è¿¹è±¡ï¼Œä»¥ä¸‹èµ„äº§æ¯å¹´**å¿…é¡»**æµ‹å‡å€¼:\n1. **Goodwill** (å•†èª‰)ã€‚\n2. **Intangible asset with indefinite useful life**ã€‚" },
        { id: "CGU", label: "CGU åˆ†æ‘Š", group: 2, parent: "IAS36", page: 40, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nåˆ†æ‘Šé¡ºåº: 1. Specific assets -> 2. **Goodwill** -> 3. Other assets (Pro-rata)ã€‚" },

        // IAS 23
        { id: "IAS23", label: "IAS 23 å€Ÿæ¬¾è´¹ç”¨", group: 2, parent: "Mod_Asset", page: 44, desc: "ã€âš¡è€ƒç‚¹ã€‘\nè®¡ç®—èµ„æœ¬åŒ–é‡‘é¢æ—¶ï¼Œå¿…é¡» **å‡å»** é—²ç½®èµ„é‡‘çš„ä¸´æ—¶æŠ•èµ„æ”¶ç›Š (Investment income)ã€‚" },

        // IAS 2
        { id: "IAS2", label: "IAS 2 å­˜è´§", group: 2, parent: "Mod_Asset", page: 46 },
        { id: "FIFO_AVCO", label: "è®¡ä»·æ–¹æ³•", group: 2, parent: "IAS2", page: 47, desc: "ã€âš¡è€ƒç‚¹ã€‘\nLIFO è¢«ç¦æ­¢ã€‚\nFIFO è½¬ AVCO è°ƒæ•´åˆ†å½•: Dr Cost of Sales, Cr Inventory (åä¹‹äº¦ç„¶)ã€‚" },
        { id: "NRV", label: "NRV å‡å€¼", group: 2, parent: "IAS2", page: 47, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nå‡å€¼åˆ†å½•: Dr Cost of Sales, Cr Inventoryã€‚" },

        // IFRS 5
        { id: "IFRS5", label: "IFRS 5 æŒæœ‰å¾…å”®", group: 2, parent: "Mod_Asset", page: 50 },
        { id: "HFS_Rule", label: "ç¡®è®¤ä¸è®¡é‡", group: 2, parent: "IFRS5", page: 50, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nç¡®è®¤: Available immediate sale + Highly probable (1 yr).\nè®¡é‡: **Lower of CA and FV-CTS**ã€‚\nä¸€æ—¦ç¡®è®¤ï¼Œ**åœæ­¢æŠ˜æ—§**ã€‚" },
        { id: "Dis_Op", label: "åœæ­¢ç»è¥", group: 2, parent: "IFRS5", page: 52, desc: "ã€âš¡è€ƒç‚¹ã€‘\nåˆ©æ¶¦è¡¨ä¸­å•åˆ—: Profit/Loss from discontinued operation (ç¨åå‡€é¢)ã€‚åŒ…å«ç»è¥æŸç›ŠåŠå¤„ç½®æŸç›Šã€‚" },

        // IAS 41
        { id: "IAS41", label: "IAS 41 å†œä¸š", group: 2, parent: "Mod_Asset", page: 54, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nç”Ÿç‰©èµ„äº§: FV-CTS (å˜åŠ¨è¿› SPL)ã€‚\nã€âš¡è€ƒç‚¹ã€‘Bearer plants (ç”Ÿäº§æ€§æ¤ç‰©) å½’å± **IAS 16**ã€‚" },

        // === 3. è´Ÿå€ºä¸æƒç›Š (Green) ===
        { id: "Mod_Liab", label: "è´Ÿå€ºä¸æƒç›Š", group: 3, parent: "Root", page: 57 },
        
        // IFRS 16
        { id: "IFRS16", label: "IFRS 16 ç§Ÿèµ", group: 3, parent: "Mod_Liab", page: 57 },
        { id: "Lease_Depn", label: "æŠ˜æ—§å¹´é™", group: 3, parent: "IFRS16", page: 60, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\n1. è½¬ç§»æ‰€æœ‰æƒ: æŒ‰èµ„äº§å¯¿å‘½æŠ˜æ—§ã€‚\n2. ä¸è½¬ç§»: æŒ‰ **Shorter** of (Lease term, Asset life) æŠ˜æ—§ã€‚" },
        { id: "Lease_Liab", label: "è´Ÿå€ºå±•ç¤º", group: 3, parent: "IFRS16", page: 60, desc: "ã€âš¡è€ƒç‚¹ã€‘\nå¹´åº•ä½™é¢éœ€æ‹†åˆ†ä¸º **Non-current** (NCL) å’Œ **Current** (CL)ã€‚\nCL = ä¸‹ä¸€å¹´éœ€å¿è¿˜çš„æœ¬é‡‘éƒ¨åˆ†ã€‚" },

        // IAS 37
        { id: "IAS37", label: "IAS 37 é¢„è®¡è´Ÿå€º", group: 3, parent: "Mod_Liab", page: 64 },
        { id: "Prov_Meas", label: "è®¡é‡æ–¹æ³•", group: 3, parent: "IAS37", page: 64, desc: "ã€âš¡è€ƒç‚¹ã€‘\n1. å•ä¸€äº‹ä»¶ (å¦‚è¯‰è®¼): Most likely amountã€‚\n2. å¤§é‡äº‹ä»¶ (å¦‚ä¿ä¿®): Expected value (æ¦‚ç‡åŠ æƒ)ã€‚" },
        { id: "Restruct", label: "é‡ç»„ä¹‰åŠ¡", group: 3, parent: "IAS37", page: 66, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nç¡®è®¤æ¡ä»¶: å¿…é¡»æœ‰ Detailed formal plan **å¹¶ä¸”** å·²å¯¹å¤–å…¬å‘Š (Raised valid expectation)ã€‚" },

        // IAS 12
        { id: "IAS12", label: "IAS 12 æ‰€å¾—ç¨", group: 3, parent: "Mod_Liab", page: 70, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nDeferred Tax Liability (DTL): åº”çº³ç¨æš‚æ—¶æ€§å·®å¼‚ (Taxable Temp Diff)ã€‚\nTax Base: è®¡ç¨åŸºç¡€ã€‚" },

        // IFRS 9
        { id: "IFRS9", label: "IFRS 9 é‡‘èå·¥å…·", group: 3, parent: "Mod_Liab", page: 77 },
        { id: "Fin_Def", label: "å®šä¹‰", group: 3, parent: "IFRS9", page: 77, desc: "ã€âš¡è€ƒç‚¹ã€‘\néœ€èƒŒè¿‡ Financial Asset, Financial Liability, Equity çš„å®šä¹‰ã€‚" },
        { id: "Trans_Cost", label: "äº¤æ˜“è´¹ç”¨", group: 3, parent: "IFRS9", page: 79, desc: "ã€âš¡è€ƒç‚¹/æ”¹é”™ã€‘\nå‘è¡Œå€ºåˆ¸ (Liability) æ—¶ï¼Œäº¤æ˜“è´¹ç”¨åº” **æŠµå‡** åˆå§‹å…¥è´¦é‡‘é¢ (Deduct from proceeds)ã€‚" },

        // === 4. ç»©æ•ˆ (Cyan) ===
        { id: "Mod_Perf", label: "ç»©æ•ˆæŠ¥è¡¨", group: 4, parent: "Root", page: 84 },
        
        // IFRS 15
        { id: "IFRS15", label: "IFRS 15 æ”¶å…¥", group: 4, parent: "Mod_Perf", page: 84 },
        { id: "Step4", label: "åˆ†æ‘Šä»·æ ¼", group: 4, parent: "IFRS15", page: 86, desc: "ã€âš¡è€ƒç‚¹ã€‘\nStand-alone selling price (å•ç‹¬å”®ä»·)ã€‚\né‡å¤§èèµ„æˆåˆ† (Significant financing component): éœ€åˆ†ç¦»åˆ©æ¯æ”¶å…¥ã€‚" },
        { id: "Substance", label: "å®è´¨é‡äºå½¢å¼", group: 4, parent: "IFRS15", page: 91, desc: "ã€âš¡è€ƒç‚¹ã€‘\n1. **å›è´­åè®®** (Repurchase): å®è´¨ä¸ºæŠµæŠ¼å€Ÿæ¬¾ (Loan)ï¼Œä¸èƒ½ç¡®è®¤æ”¶å…¥ã€‚\n2. **ä¿ç†** (Factoring with recourse): æœ‰è¿½ç´¢æƒå®è´¨ä¸ºå€Ÿæ¬¾ã€‚" },

        // IAS 33
        { id: "IAS33", label: "IAS 33 EPS", group: 4, parent: "Mod_Perf", page: 101 },

        // Ch11 Presentation
        { id: "IAS10", label: "IAS 10 æœŸåäº‹é¡¹", group: 4, parent: "Mod_Perf", page: 108, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\n1. å®šä¹‰: End of reporting period ~ Date authorized for issue.\n2. **Adjusting**: æä¾›æœŸæœ«å­˜åœ¨çŠ¶å†µçš„è¯æ® (å¦‚å®¢æˆ·ç ´äº§è¯å®åè´¦)ã€‚\n3. **Non-adjusting**: æœŸåæ–°å‘ç”Ÿ (å¦‚ç«ç¾ã€å¹¶è´­)ã€‚" },
        { id: "IAS21", label: "IAS 21 å¤–æ±‡", group: 4, parent: "Mod_Perf", page: 111, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nåŠŸèƒ½æ€§è´§å¸ (Functional Currency) åˆ¤æ–­å› ç´ : Sales prices, Competitive forces, Costs (Labor/Mat)ã€‚" },
        { id: "IFRS13", label: "IFRS 13 å…¬å…ä»·å€¼", group: 4, parent: "Mod_Perf", page: 113, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nå®šä¹‰: Exit price (è„±æ‰‹ä»·)ã€‚\nå±‚çº§: Level 1 (æ´»è·ƒæŠ¥ä»·) > Level 2 (å¯è§‚å¯Ÿ) > Level 3 (ä¸å¯è§‚å¯Ÿ)ã€‚" },

        // === 5. åˆå¹¶æŠ¥è¡¨ (Purple) ===
        { id: "Mod_Consol", label: "åˆå¹¶æŠ¥è¡¨", group: 5, parent: "Root", page: 133 },
        
        // Basics
        { id: "Control", label: "æ§åˆ¶æƒåˆ¤æ–­", group: 5, parent: "Mod_Consol", page: 134, desc: "ã€âš¡é«˜é¢‘è€ƒç‚¹ã€‘\næŒè‚¡ <50% ä¹Ÿèƒ½æ§åˆ¶:\n1. åè®®æŠ•ç¥¨æƒ >50%ã€‚\n2. æœ‰æƒä»»å‘½å¤šæ•°è‘£äº‹ã€‚\n3. æœ‰æƒä¸»å¯¼è´¢åŠ¡/ç»è¥å†³ç­–ã€‚" },
        
        // W1-W5
        { id: "W1", label: "W1: é›†å›¢ç»“æ„", group: 5, parent: "Mod_Consol", page: 137, desc: "ã€âš¡è€ƒç‚¹ã€‘\nè‹¥å­å…¬å¸å¹³ä»·å‘è¡Œ (At par)ï¼Œåˆ™æ—  Share Premiumã€‚" },
        { id: "W2", label: "W2: å‡€èµ„äº§", group: 5, parent: "Mod_Consol", page: 153, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\næ ‡å‡†æ ¼å¼: Share Capital + Premium + Retained Earnings + FV Adj + Unrecorded Assets - URPã€‚" },
        { id: "W3", label: "W3: å•†èª‰", group: 5, parent: "Mod_Consol", page: 138, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nGoodwill = Cost + NCI - Net Assetsã€‚\nè´Ÿå•†èª‰ (Negative Goodwill) = æ”¶ç›Š (Gain in SPL)ã€‚" },
        
        // Associates
        { id: "Assoc", label: "IAS 28 è”è¥", group: 5, parent: "Mod_Consol", page: 167, desc: "ã€âš¡è€ƒç‚¹ã€‘\n1. å‡å€¼ (Impairment): éœ€ä¹˜ä»¥æŒè‚¡æ¯”ä¾‹ (x%)ã€‚\n2. URP: éœ€ä¹˜ä»¥æŒè‚¡æ¯”ä¾‹ (x%)ã€‚\n3. æŠ•èµ„ä»·å€¼: Cost + Share of Post-acq Profit - Dividendã€‚" },

        // Disposal
        { id: "Disposal", label: "å¤„ç½®å­å…¬å¸", group: 5, parent: "Mod_Consol", page: 163, desc: "ã€âš¡é«˜é¢‘è€ƒç‚¹ã€‘\nå¤„ç½®æ”¶ç›Š = å”®ä»· + å‰©ä½™è‚¡æƒFV - (å¤„ç½®æ—¥å‡€èµ„äº§ + å•†èª‰)ã€‚\n**æ ¼å¼å¿…é¡»èƒŒè¿‡**ã€‚" },

        // === 6. åˆ†æ (Pink) ===
        { id: "Mod_Analy", label: "åˆ†æ", group: 6, parent: "Root", page: 128 },
        { id: "Cashflow", label: "IAS 7 ç°é‡‘æµ", group: 6, parent: "Mod_Analy", page: 122, desc: "ã€ğŸ”¥èƒŒè¿‡ã€‘\nå®šä¹‰: Cash & Cash equivalents.\næ ¼å¼: Operating (Indirect), Investing, Financing." },
        { id: "Ratios", label: "è´¢åŠ¡æ¯”ç‡", group: 6, parent: "Mod_Analy", page: 128, desc: "ã€âš¡è€ƒç‚¹ã€‘\nDebt å®šä¹‰: Loans, Pref Shares, Lease Liab.\nå…¬å¼èƒŒè¯µ: ROCE, Gearing, Interest Cover." }
    ];

    // --- å®‰å…¨æ„å»ºè¿çº¿ ---
    const nodeMap = new Map(nodes.map(n => [n.id, n]));
    const links = [];
    nodes.forEach(n => {
        if (n.parent && nodeMap.has(n.parent)) links.push({ source: n.parent, target: n.id });
    });

    // --- D3 æ¸²æŸ“ ---
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    const svg = d3.select("#graph-area").append("svg")
        .attr("width", width).attr("height", height)
        .call(d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => g.attr("transform", e.transform)))
        .on("dblclick.zoom", null);

    const g = svg.append("g");

    const colorMap = {
        0: "#fff", 1: "#ef4444", 2: "#f59e0b", 3: "#10b981", 4: "#06b6d4", 5: "#8b5cf6", 6: "#ec4899", 7: "#64748b"
    };

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(d => d.group === 7 ? 50 : 80))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(30));

    const link = g.append("g").selectAll("line")
        .data(links).join("line")
        .attr("stroke", "#334155").attr("stroke-width", 1.5).attr("stroke-opacity", 0.6);

    const node = g.append("g").selectAll("g")
        .data(nodes).join("g")
        .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend))
        .on("click", (e, d) => { e.stopPropagation(); showInfo(d); });

    node.append("circle")
        .attr("r", d => d.group === 0 ? 40 : (d.group === 7 ? 10 : 18))
        .attr("fill", d => colorMap[d.group])
        .attr("stroke", "#fff").attr("stroke-width", 2)
        .style("cursor", "pointer");

    node.append("text")
        .text(d => d.label)
        .attr("x", d => d.group === 0 ? 45 : 22)
        .attr("y", 5)
        .style("font-size", d => d.group === 0 ? "18px" : "12px")
        .style("fill", "#e2e8f0")
        .style("pointer-events", "none")
        .style("text-shadow", "2px 2px 3px #000");

    function dragstart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragend(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    function toggleSidebar(show) {
        const sb = document.getElementById("sidebar");
        show ? sb.classList.add("active") : sb.classList.remove("active");
    }

    function showInfo(d) {
        const header = document.getElementById("header-content");
        const body = document.getElementById("body-content");
        const footer = document.getElementById("pdf-footer");
        const color = colorMap[d.group];
        
        header.innerHTML = `<span class="badge" style="background:${color}; color:${d.group===0?'#000':'#fff'}">è€ƒç‚¹è¯¦æƒ…</span><h2>${d.label}</h2>`;
        
        let html = "";
        if (d.desc) {
            // æ ¼å¼åŒ–: é«˜äº®ã€ã€‘å†…å®¹å’Œ **å†…å®¹**
            let content = d.desc.replace(/\n/g, "<br>");
            content = content.replace(/ã€(.*?)ã€‘/g, '<span class="tag-exam">$1</span>');
            content = content.replace(/ã€ğŸ”¥(.*?)ã€‘/g, '<span class="tag-mem">$1</span>');
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong style="color:#fff; border-bottom:1px dashed #94a3b8;">$1</strong>');
            
            if (d.desc.includes("ã€")) {
                html = `<div class="highlight-box">${content}</div>`;
            } else {
                html = d.group === 7 ? `<div class="example-box">${content}</div>` : `<div class="detail-box"><div class="detail-title" style="color:${color}">æ ¸å¿ƒè¦ç‚¹</div><div class="desc">${content}</div></div>`;
            }
        }
        body.innerHTML = html || `<div class="desc" style="text-align:center; color:#64748b;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹æ•™æè¯¦æƒ…</div>`;

        footer.innerHTML = d.page ? `<a href="FRç”µå­æ•™æ.pdf#page=${d.page}" target="_blank" class="pdf-btn"><span>ğŸ“–</span> æ‰“å¼€æ•™æ (ç¬¬ ${d.page} é¡µ)</a>` : "";
        toggleSidebar(true);
    }

    document.getElementById("search").addEventListener("input", (e) => {
        const val = e.target.value.toLowerCase();
        node.style("opacity", d => d.label.toLowerCase().includes(val) ? 1 : 0.1);
        link.style("opacity", d => d.source.label.toLowerCase().includes(val) || d.target.label.toLowerCase().includes(val) ? 1 : 0.05);
    });
</script>
</body>
</html>
