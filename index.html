<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACCA FR ç»ˆæé€»è¾‘å›¾è°± (æ€ç»´å¯¼å›¾å¤åˆ»ç‰ˆ)</title>
    <script src="https://lib.baomitu.com/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-color: #020617;
            --sidebar-bg: #0f172a;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border-color: #334155;
            
            /* å…­å¤§æ¨¡å—é…è‰² (å¯¹åº”æ€ç»´å¯¼å›¾è‰²å—) */
            --c-frame: #ef4444;   /* æ¦‚å¿µç›‘ç®¡ */
            --c-asset: #f59e0b;   /* èµ„äº§ */
            --c-liab: #10b981;    /* è´Ÿå€ºæƒç›Š */
            --c-perf: #06b6d4;    /* ç»©æ•ˆæ”¶å…¥ */
            --c-consol: #8b5cf6;  /* åˆå¹¶æŠ¥è¡¨ */
            --c-analy: #ec4899;   /* åˆ†æ */
            --c-case: #64748b;    /* æ¡ˆä¾‹ */
        }

        body { margin: 0; overflow: hidden; background: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
        #container { display: flex; width: 100vw; height: 100vh; }
        #graph-area { flex: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        /* ä¾§è¾¹æ  (åŠ å®½ä»¥å®¹çº³é€»è¾‘è¡¨) */
        #sidebar {
            width: 600px; 
            background: var(--sidebar-bg); border-left: 1px solid var(--border-color);
            position: absolute; right: 0; top: 0; height: 100%;
            transform: translateX(100%); transition: transform 0.3s ease; z-index: 20;
            box-shadow: -10px 0 30px rgba(0,0,0,0.7); display: flex; flex-direction: column;
        }
        #sidebar.active { transform: translateX(0); }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.98); }
        .sidebar-body { padding: 20px; overflow-y: auto; flex: 1; scroll-behavior: smooth; }
        
        h2 { margin: 0 0 10px 0; color: var(--text-main); border-bottom: 2px solid #334155; padding-bottom: 10px; font-size: 1.5rem; letter-spacing: 0.5px; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; color: #000; text-transform: uppercase; }

        /* --- é€»è¾‘è¡¨æ ¼ç³»ç»Ÿ (æ ¸å¿ƒ) --- */
        .info-table {
            width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9rem;
            background: rgba(0,0,0,0.2); border-radius: 6px; overflow: hidden; border: 1px solid #334155;
        }
        .info-table th { background: rgba(56, 189, 248, 0.15); text-align: left; padding: 12px 10px; color: #38bdf8; font-weight: bold; border-bottom: 1px solid #475569; }
        .info-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #e2e8f0; vertical-align: top; line-height: 1.5; }
        .info-table tr:last-child td { border-bottom: none; }
        .info-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        
        /* è®¡ç®—è¡Œæ ·å¼ */
        .calc-row td { font-family: 'Consolas', monospace; font-weight: bold; color: #fff; background: rgba(255,255,255,0.05); border-top: 1px double #64748b; }
        
        /* é€»è¾‘æ ‘æ ·å¼ */
        .logic-tree { margin-left: 10px; border-left: 2px solid #475569; padding-left: 10px; color: #cbd5e1; }
        .logic-item { margin-bottom: 8px; position: relative; }
        .logic-item::before { content: "â€¢"; color: #38bdf8; position: absolute; left: -15px; }

        /* è¯¦æƒ…æ–‡æœ¬ */
        .desc { line-height: 1.7; color: #cbd5e1; font-size: 0.95rem; white-space: pre-wrap; }
        .highlight { color: #f43f5e; font-weight: bold; background: rgba(244, 63, 94, 0.1); padding: 0 4px; border-radius: 3px; }
        .formula { font-family: 'Consolas', monospace; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; border: 1px dashed #475569; margin: 10px 0; color: #a5f3fc; }

        /* æ¡ˆä¾‹æ¡† */
        .example-box { background: #0f172a; padding: 15px; border-left: 4px solid var(--c-case); border-radius: 6px; font-family: monospace; white-space: pre-wrap; color: #e2e8f0; font-size: 0.9rem; margin-top: 15px; border: 1px solid #334155; }

        /* PDF æŒ‰é’® */
        .pdf-container { padding: 20px; border-top: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .pdf-btn {
            display: flex; align-items: center; justify-content: center; width: 100%;
            background: linear-gradient(135deg, #dc2626, #991b1b); color: white; text-decoration: none;
            padding: 14px; border-radius: 8px; font-weight: bold; border: 1px solid #7f1d1d;
            transition: all 0.2s; font-size: 1rem;
        }
        .pdf-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4); }

        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-sub); font-size: 2rem; cursor: pointer; }
        
        /* æœç´¢ */
        #controls { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
        #search { background: #020617; border: 1px solid var(--border-color); color: white; padding: 8px 12px; border-radius: 6px; width: 220px; outline: none; }
        .legend-item { display: flex; align-items: center; margin-top: 8px; font-size: 0.8rem; color: var(--text-sub); }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>

<div id="container">
    <div id="graph-area">
        <div id="controls">
            <input type="text" id="search" placeholder="ğŸ” æœç´¢è€ƒç‚¹ (å¦‚: Lease)...">
            <div style="margin-top:15px; border-top:1px solid #334155; padding-top:10px;">
                <div class="legend-item"><div class="dot" style="background:var(--c-frame)"></div>æ¦‚å¿µä¸ç›‘ç®¡</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-asset)"></div>èµ„äº§å‡†åˆ™</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-liab)"></div>è´Ÿå€º/æƒç›Š</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-perf)"></div>ç»©æ•ˆ/æ”¶å…¥</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-consol)"></div>åˆå¹¶æŠ¥è¡¨</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-analy)"></div>åˆ†æ</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-case)"></div>æ¡ˆä¾‹</div>
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <div class="sidebar-header">
            <button class="close-btn" onclick="toggleSidebar(false)">Ã—</button>
            <div id="header-content"></div>
        </div>
        <div class="sidebar-body">
            <div id="body-content"></div>
        </div>
        <div class="pdf-container" id="pdf-footer"></div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒæ•°æ®æº (é›†æˆæ€ç»´å¯¼å›¾é€»è¾‘ç»†èŠ‚) ---
    const nodes = [
        { id: "Root", label: "ACCA FR é€»è¾‘å…¨å›¾", group: 0, r: 50, page: 1, desc: "åŒ…å«æ€ç»´å¯¼å›¾æ‰€æœ‰é€»è¾‘åˆ†æ”¯ä¸ç»†èŠ‚" },

        // === 1. æ¦‚å¿µä¸ç›‘ç®¡ (Framework) ===
        { id: "Mod_Frame", label: "æ¦‚å¿µä¸ç›‘ç®¡", group: 1, parent: "Root", page: 9 },
        { id: "Qual", label: "è´¨é‡ç‰¹å¾", group: 1, parent: "Mod_Frame", page: 10, desc: `
ã€ğŸ”¥èƒŒè¿‡ã€‘ç‰¹å¾å±‚çº§ï¼š
<div class="logic-tree">
    <div class="logic-item"><strong>Fundamental (åŸºç¡€):</strong>
        <br>- Relevance (ç›¸å…³æ€§): é¢„æµ‹/è¯å®ä»·å€¼
        <br>- Faithful Representation (å¦‚å®åæ˜ ): å®Œæ•´ã€ä¸­ç«‹ã€æ— è¯¯
    </div>
    <div class="logic-item"><strong>Enhancing (å¼ºåŒ–):</strong>
        <br>- Comparability (å¯æ¯”æ€§)
        <br>- Verifiability (å¯éªŒè¯æ€§)
        <br>- Timeliness (åŠæ—¶æ€§)
        <br>- Understandability (å¯ç†è§£æ€§)
    </div>
</div>` },
        { id: "Meas", label: "è®¡é‡åŸºç¡€", group: 1, parent: "Mod_Frame", page: 13, desc: `
<table class="info-table">
    <tr><th>åŸºç¡€</th><th>å®šä¹‰</th><th>ä¼˜ç¼ºç‚¹</th></tr>
    <tr><td>Historical Cost</td><td>è´­ä¹°ä»·+äº¤æ˜“è´¹</td><td>å®¢è§‚å¯é  / æ­¤æ—¶ä»·å€¼ä½ä¼°</td></tr>
    <tr><td>Fair Value</td><td>å¸‚åœºè„±æ‰‹ä»· (Exit)</td><td>åæ˜ ç°å€¼ / ä¸»è§‚æ€§</td></tr>
    <tr><td>Value in Use</td><td>ç°é‡‘æµæŠ˜ç° (Entity specific)</td><td>åæ˜ æŒæœ‰ä»·å€¼ / å¤æ‚</td></tr>
    <tr><td>Current Cost</td><td>é‡ç½®æˆæœ¬ (Entry)</td><td>é‡ç½®å‚è€ƒ / éš¾ä»¥ç¡®å®š</td></tr>
</table>` },

        // === 2. èµ„äº§ (Assets) ===
        { id: "Mod_Asset", label: "èµ„äº§å‡†åˆ™", group: 2, parent: "Root", page: 23 },
        
        // IAS 16
        { id: "IAS16", label: "IAS 16 å›ºå®šèµ„äº§", group: 2, parent: "Mod_Asset", page: 23 },
        { id: "IAS16_Logic", label: "å¤„ç†é€»è¾‘æ ‘", group: 2, parent: "IAS16", page: 24, desc: `
<div class="logic-tree">
    <div class="logic-item"><strong>Initial Measurement:</strong> Cost (Purchase + Direct costs + Dismantling PV)</div>
    <div class="logic-item"><strong>Subsequent Measurement:</strong>
        <br>1. <strong>Cost Model:</strong> Cost - Acc Depn - Impairment
        <br>2. <strong>Revaluation Model:</strong> Fair Value
        <br>&nbsp;&nbsp;-> Gain: OCI -> Revaluation Surplus (Equity)
        <br>&nbsp;&nbsp;-> Loss: Dr RS (if any) -> Dr SPL
    </div>
    <div class="logic-item"><strong>Depreciation:</strong> Start when "Ready for use".</div>
</div>` },
        { id: "Case_Topsy", label: "æ¡ˆä¾‹: Topsy Co", group: 7, parent: "IAS16_Logic", page: 25, desc: "ã€é‡ä¼°ç›ˆä½™è®¡ç®—ã€‘\næœŸåˆ RS + æœ¬æœŸå¢å€¼ - å¤šä½™æŠ˜æ—§è½¬ç§» = æœŸæœ« RSã€‚\nå¤šä½™æŠ˜æ—§ = (é‡ä¼°åæŠ˜æ—§ - å†å²æˆæœ¬æŠ˜æ—§)ã€‚" },

        // IAS 38
        { id: "IAS38", label: "IAS 38 æ— å½¢èµ„äº§", group: 2, parent: "Mod_Asset", page: 30 },
        { id: "RD_Logic", label: "R&D åˆ¤åˆ«é€»è¾‘", group: 2, parent: "IAS38", page: 31, desc: `
<table class="info-table">
    <tr><th>é˜¶æ®µ</th><th>å¤„ç†</th><th>å…³é”®ç‚¹</th></tr>
    <tr><td>Research</td><td>Expense (SPL)</td><td>æ¢ç´¢æ€§ã€ä¸ç¡®å®šæ€§</td></tr>
    <tr><td>Development</td><td>Capitalize (SOFP)</td><td>å¿…é¡»æ»¡è¶³ <strong>PIRATE</strong> æ¡ä»¶</td></tr>
</table>
<div class="formula">
P - Probable future benefits
I - Intention to complete/sell
R - Resources available
A - Ability to use/sell
T - Technical feasibility
E - Expenditure reliably measured
</div>` },

        // IAS 40
        { id: "IAS40", label: "IAS 40 æŠ•èµ„æˆ¿äº§", group: 2, parent: "Mod_Asset", page: 35, desc: "ã€âš¡è€ƒç‚¹ã€‘ç”¨é€”æ”¹å˜ (Change in use) æ˜¯é‡åˆ†ç±»çš„å‰æã€‚\nFair Value Model å˜åŠ¨è¿› **SPL**ï¼Œä¸” **ä¸æŠ˜æ—§**ã€‚" },

        // IAS 36
        { id: "IAS36", label: "IAS 36 å‡å€¼", group: 2, parent: "Mod_Asset", page: 39 },
        { id: "Imp_Logic", label: "å‡å€¼é€»è¾‘", group: 2, parent: "IAS36", page: 40, desc: `
1. æ¯”è¾ƒ: Carrying Amount vs Recoverable Amount
2. **RA = Max (FV - CTS, VIU)**
3. åˆ†æ‘Š (CGU):
<table class="info-table">
    <tr><th>é¡ºåº</th><th>å¯¹è±¡</th></tr>
    <tr><td>1</td><td>Specific Asset (æ˜æ˜¾å—æŸ)</td></tr>
    <tr><td>2</td><td>Goodwill (å…¨é¢æŠµå‡)</td></tr>
    <tr><td>3</td><td>Pro-rata (å…¶ä»–èµ„äº§)</td></tr>
</table>` },

        // IAS 20 & 23
        { id: "IAS20", label: "IAS 20 æ”¿åºœè¡¥è´´", group: 2, parent: "Mod_Asset", page: 95, desc: "Asset grant: æŠµå‡èµ„äº§æˆæœ¬ æˆ– ç¡®è®¤ä¸ºé€’å»¶æ”¶å…¥ (Deferred Income)ã€‚" },
        { id: "IAS23", label: "IAS 23 å€Ÿæ¬¾è´¹ç”¨", group: 2, parent: "Mod_Asset", page: 44, desc: "èµ„æœ¬åŒ–å¼€å§‹: Expenditure + Borrowing costs + Activities start.\næš‚åœ: Active development suspended.\nåœæ­¢: Substantially complete." },

        // === 3. è´Ÿå€ºä¸æƒç›Š (Liab) ===
        { id: "Mod_Liab", label: "è´Ÿå€ºä¸æƒç›Š", group: 3, parent: "Root", page: 57 },
        
        // IFRS 9 (é€»è¾‘ç»†åŒ–)
        { id: "IFRS9", label: "IFRS 9 é‡‘èå·¥å…·", group: 3, parent: "Mod_Liab", page: 77 },
        { id: "Fin_Class", label: "èµ„äº§åˆ†ç±»é€»è¾‘", group: 3, parent: "IFRS9", page: 78, desc: `
<table class="info-table">
    <tr><th>å·¥å…·ç±»å‹</th><th>æµ‹è¯• (Test)</th><th>åˆ†ç±»</th><th>å˜åŠ¨è®¡å…¥</th></tr>
    <tr><td rowspan="3">Debt (å€ºæƒ)</td><td>BM: Collect<br>CF: SPPI</td><td>Amortized Cost</td><td>SPL (EIR)</td></tr>
    <tr><td>BM: Collect & Sell<br>CF: SPPI</td><td>FVTOCI</td><td>OCI (å¯é‡åˆ†ç±»)</td></tr>
    <tr><td>Other</td><td>FVTPL</td><td>SPL</td></tr>
    <tr><td rowspan="2">Equity (è‚¡æƒ)</td><td>Held for trading</td><td>FVTPL</td><td>SPL</td></tr>
    <tr><td>Strategic (Election)</td><td>FVTOCI</td><td>OCI (ä¸å¯é‡åˆ†ç±»)</td></tr>
</table>` },
        { id: "Fin_Liab", label: "è´Ÿå€ºè®¡é‡", group: 3, parent: "IFRS9", page: 79, desc: "é»˜è®¤ Amortized Costã€‚\nã€âš¡è€ƒç‚¹ã€‘äº¤æ˜“è´¹ç”¨: **æŠµå‡** åˆå§‹è´Ÿå€ºé‡‘é¢ (Proceeds - Trans Cost)ã€‚" },

        // IFRS 16 (æ–°å¢è¡¨æ ¼)
        { id: "IFRS16", label: "IFRS 16 ç§Ÿèµ", group: 3, parent: "Mod_Liab", page: 57 },
        { id: "Lease_Calc", label: "ç§Ÿèµè®¡ç®—é€»è¾‘", group: 3, parent: "IFRS16", page: 58, desc: `
<table class="info-table">
    <tr><th>é¡¹ç›®</th><th>åˆå§‹è®¡é‡</th><th>åç»­è®¡é‡</th></tr>
    <tr><td>Liability</td><td>PV of Payments</td><td>Amortized Cost (Open + Int - Pay)</td></tr>
    <tr><td>ROU Asset</td><td>Liab + Direct Cost + Dismantling - Incentives</td><td>Cost - Depn - Impairment</td></tr>
</table>
<br>ã€âš¡æŠ˜æ—§å¹´é™ã€‘è½¬ç§»æ‰€æœ‰æƒ -> èµ„äº§å¯¿å‘½ï¼›ä¸è½¬ç§» -> Shorter of Lease/Lifeã€‚` },

        // IAS 37
        { id: "IAS37", label: "IAS 37 é¢„è®¡è´Ÿå€º", group: 3, parent: "Mod_Liab", page: 64 },
        { id: "Prov_Dec", label: "å†³ç­–æ ‘", group: 3, parent: "IAS37", page: 66, desc: `
<table class="info-table">
    <tr><th>æ¦‚ç‡</th><th>ä¹‰åŠ¡ç±»å‹</th><th>å¤„ç†</th></tr>
    <tr><td>Virtually Certain (>95%)</td><td>Real</td><td>Provision (Liab)</td></tr>
    <tr><td>Probable (>50%)</td><td>Present</td><td>Provision</td></tr>
    <tr><td>Possible (<50%)</td><td>Possible</td><td>Disclosure (Note)</td></tr>
    <tr><td>Remote</td><td>-</td><td>Ignore</td></tr>
</table>` },

        // === 4. ç»©æ•ˆ (Performance) ===
        { id: "Mod_Perf", label: "ç»©æ•ˆæŠ¥è¡¨", group: 4, parent: "Root", page: 84 },
        
        // Substance Over Form (æ–°å¢é‡ç‚¹æ¿å—)
        { id: "Substance", label: "å®è´¨é‡äºå½¢å¼", group: 4, parent: "Mod_Perf", page: 90 },
        { id: "Consign", label: "å¯„å”® (Consignment)", group: 4, parent: "Substance", page: 90, desc: "ã€åˆ¤æ–­ã€‘è°æ‰¿æ‹…é£é™©(Risk)å’ŒæŠ¥é…¬(Reward)ï¼Ÿ\nè‹¥ç”Ÿäº§å•†æ‰¿æ‹…é£é™©(æ»é”€/é™ˆæ—§) -> å­˜è´§ä»å±äºç”Ÿäº§å•†ï¼Œ**ä¸èƒ½ç¡®è®¤æ”¶å…¥**ã€‚" },
        { id: "Repurchase", label: "å”®åå›è´­", group: 4, parent: "Substance", page: 90, desc: "ã€åˆ¤æ–­ã€‘å–æ–¹æœ‰ä¹‰åŠ¡/æƒåˆ©ä»¥å›ºå®šä»·æ ¼å›è´­ -> å®è´¨æ˜¯**æŠµæŠ¼å€Ÿæ¬¾**ã€‚\nå¤„ç†ï¼šä¸ç¡®è®¤æ”¶å…¥ï¼Œç¡®è®¤ Liabilityï¼Œæ”¶åˆ°çš„é’±è§†ä¸º Loanã€‚" },
        { id: "Factor", label: "ä¿ç† (Factoring)", group: 4, parent: "Substance", page: 91, desc: "ã€åˆ¤æ–­ã€‘With Recourse (æœ‰è¿½ç´¢æƒ) -> é£é™©æœªè½¬ç§» -> è§†ä¸º**å€Ÿæ¬¾** (Loan)ã€‚\nWithout Recourse -> è§†ä¸ºå‡ºå”®åº”æ”¶è´¦æ¬¾ã€‚" },

        // IFRS 15
        { id: "IFRS15", label: "IFRS 15 æ”¶å…¥", group: 4, parent: "Mod_Perf", page: 84 },
        { id: "Step5", label: "æ—¶æ®µç¡®è®¤ (Over Time)", group: 4, parent: "IFRS15", page: 85, desc: `
ã€âš¡åˆ¤æ–­æ ‡å‡†ã€‘æ»¡è¶³å…¶ä¸€å³å¯ï¼š
1. å®¢æˆ·åœ¨å±¥çº¦åŒæ—¶å³å–å¾—å¹¶æ¶ˆè€—åˆ©ç›Š (å¦‚ä¿æ´æœåŠ¡)ã€‚
2. å±¥çº¦è¿‡ç¨‹åˆ›é€ /å¢å¼ºäº†å®¢æˆ·æ§åˆ¶çš„èµ„äº§ (å¦‚åœ¨å®¢æˆ·åœŸåœ°ä¸Šå»ºæˆ¿)ã€‚
3. äº§å‡ºæ— æ›¿ä»£ç”¨é€” **ä¸”** æœ‰æƒå°±å·²å®Œæˆéƒ¨åˆ†æ”¶æ¬¾ã€‚` },

        // IAS 33
        { id: "IAS33", label: "IAS 33 EPS", group: 4, parent: "Mod_Perf", page: 101, desc: "Basic EPS = Earnings / WANS.\nBonus Issue: è§†åŒè¿™å°±å­˜åœ¨ (Restate).\nDiluted: Convertibles (Add interest), Options (Add free shares)." },

        // === 5. åˆå¹¶æŠ¥è¡¨ (Consol - é€»è¾‘ç»†åŒ–) ===
        { id: "Mod_Consol", label: "åˆå¹¶æŠ¥è¡¨", group: 5, parent: "Root", page: 133 },
        
        { id: "Process", label: "åˆå¹¶äº”æ­¥æ³•", group: 5, parent: "Mod_Consol", page: 142 },
        { id: "W2", label: "W2: å‡€èµ„äº§è°ƒæ•´", group: 5, parent: "Process", page: 153, desc: `
<table class="info-table">
    <tr><th>é¡¹ç›®</th><th>At Acquisition</th><th>At Reporting Date</th></tr>
    <tr><td>Share Capital</td><td>X</td><td>X</td></tr>
    <tr><td>Retained Earnings</td><td>X</td><td>X</td></tr>
    <tr><td>FV Adjustments</td><td>X (Asset â†‘)</td><td>X</td></tr>
    <tr><td>Extra Depn (FV)</td><td>-</td><td>(X)</td></tr>
    <tr><td>PURP (Sub sell)</td><td>-</td><td>(X)</td></tr>
    <tr class="calc-row"><td>Net Assets</td><td>(A)</td><td>(B)</td></tr>
</table>` },
        { id: "W3", label: "W3: å•†èª‰", group: 5, parent: "Process", page: 154, desc: "Goodwill = Cost + NCI - Net Assets (A)ã€‚\nã€âš¡ã€‘è´Ÿå•†èª‰ (Negative Goodwill) = å»‰ä»·è´­ä¹°æ”¶ç›Š -> è®¡å…¥ Group REã€‚" },
        { id: "W5", label: "W5: é›†å›¢ RE", group: 5, parent: "Process", page: 154, desc: "Parent RE + (P% x Sub Post-acq RE) - Impairment - PURP (Parent sell)ã€‚" },

        { id: "Adj", label: "åˆå¹¶è°ƒæ•´", group: 5, parent: "Mod_Consol", page: 156 },
        { id: "PURP_Logic", label: "PURP é€»è¾‘", group: 5, parent: "Adj", page: 157, desc: `
<div class="logic-tree">
    <div class="logic-item"><strong>Parent sells to Sub:</strong>
        <br>Dr Group Retained Earnings
        <br>Cr Group Inventory
    </div>
    <div class="logic-item"><strong>Sub sells to Parent:</strong>
        <br>Dr Sub Retained Earnings (in W2)
        <br>Cr Group Inventory
        <br>*(Impacts NCI calculation)*
    </div>
</div>` },

        { id: "Disposal", label: "å¤„ç½®å­å…¬å¸", group: 5, parent: "Mod_Consol", page: 163, desc: `
ã€ğŸ”¥èƒŒè¿‡ã€‘Group Gain Calculation:
<table class="info-table">
    <tr><td>Proceeds (å”®ä»·)</td><td>X</td></tr>
    <tr><td>(+) FV of Retained Interest</td><td>X</td></tr>
    <tr><td>(-) Net Assets at Disposal</td><td>(X)</td></tr>
    <tr><td>(-) Goodwill Carrying Amt</td><td>(X)</td></tr>
    <tr><td>(+) NCI Carrying Amt</td><td>X</td></tr>
    <tr class="calc-row"><td>Gain/Loss</td><td>X</td></tr>
</table>` },

        // === 6. åˆ†æ (Analysis) ===
        { id: "Mod_Analy", label: "åˆ†æ", group: 6, parent: "Root", page: 128 },
        { id: "Reasoning", label: "åŸå› åˆ†æé€»è¾‘", group: 6, parent: "Mod_Analy", page: 129, desc: `
<table class="info-table">
    <tr><th>æ¯”ç‡å˜åŒ–</th><th>æ½œåœ¨åŸå›  (Causes)</th></tr>
    <tr><td>ROCE â†“</td><td>é‡ä¼°èµ„äº§(åˆ†æ¯â†‘)ã€æ–°æŠ•èµ„å°šæœªäº§ç”Ÿå›æŠ¥ã€åˆ©æ¶¦ç‡ä¸‹æ»‘ã€‚</td></tr>
    <tr><td>Gearing â†‘</td><td>æ–°å‘è¡Œå€ºåˆ¸ã€å›è´­è‚¡ç¥¨(æƒç›Šâ†“)ã€äºæŸå¯¼è‡´REå‡å°‘ã€‚</td></tr>
    <tr><td>GP Margin â†“</td><td>é™ä»·ä¿ƒé”€ã€åŸææ–™æ¶¨ä»·ã€å­˜è´§å‡å€¼(Write-down)ã€‚</td></tr>
    <tr><td>Asset Turnover â†“</td><td>èµ„äº§é—²ç½®ã€æ–°è´­èµ„äº§å¤„äºç£¨åˆæœŸã€‚</td></tr>
</table>` }
    ];

    // --- D3.js æ¸²æŸ“ ---
    const nodeMap = new Map(nodes.map(n => [n.id, n]));
    const links = [];
    nodes.forEach(n => {
        if (n.parent && nodeMap.has(n.parent)) links.push({ source: n.parent, target: n.id });
    });

    const width = window.innerWidth;
    const height = window.innerHeight;
    
    const svg = d3.select("#graph-area").append("svg")
        .attr("width", width).attr("height", height)
        .call(d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => g.attr("transform", e.transform)))
        .on("dblclick.zoom", null);

    const g = svg.append("g");

    const colorMap = {
        0: "#fff", 1: "#ef4444", 2: "#f59e0b", 3: "#10b981", 4: "#06b6d4", 5: "#8b5cf6", 6: "#ec4899", 7: "#64748b"
    };

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(d => d.group === 7 ? 60 : 110))
        .force("charge", d3.forceManyBody().strength(-600))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(45));

    const link = g.append("g").selectAll("line")
        .data(links).join("line")
        .attr("stroke", "#334155").attr("stroke-width", 1.5).attr("stroke-opacity", 0.6);

    const node = g.append("g").selectAll("g")
        .data(nodes).join("g")
        .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend))
        .on("click", (e, d) => { e.stopPropagation(); showInfo(d); });

    node.append("circle")
        .attr("r", d => d.group === 0 ? 40 : (d.group === 7 ? 12 : 20))
        .attr("fill", d => colorMap[d.group])
        .attr("stroke", "#fff").attr("stroke-width", 2)
        .style("cursor", "pointer");

    node.append("text")
        .text(d => d.label)
        .attr("x", d => d.group === 0 ? 45 : 25)
        .attr("y", 5)
        .style("font-size", d => d.group === 0 ? "18px" : "12px")
        .style("fill", "#e2e8f0")
        .style("pointer-events", "none")
        .style("text-shadow", "2px 2px 3px #000");

    function dragstart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragend(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    function toggleSidebar(show) {
        const sb = document.getElementById("sidebar");
        show ? sb.classList.add("active") : sb.classList.remove("active");
    }

    function showInfo(d) {
        const header = document.getElementById("header-content");
        const body = document.getElementById("body-content");
        const footer = document.getElementById("pdf-footer");
        const color = colorMap[d.group];
        
        header.innerHTML = `<span class="badge" style="background:${color}; color:${d.group===0?'#000':'#fff'}">è¯¦æƒ…å¡ç‰‡</span><h2>${d.label}</h2>`;
        
        let html = "";
        if (d.desc) {
            let content = d.desc.replace(/\n/g, "<br>");
            content = content.replace(/ã€(.*?)ã€‘/g, '<span class="highlight">$1</span>');
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            html = d.group === 7 ? `<div class="example-box">${content}</div>` : `<div class="detail-box"><div class="detail-title" style="color:${color}">æ ¸å¿ƒé€»è¾‘</div><div class="desc">${content}</div></div>`;
        }
        body.innerHTML = html || `<div class="desc" style="text-align:center; color:#64748b;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹æ•™æè¯¦æƒ…</div>`;

        footer.innerHTML = d.page ? `<a href="FRç”µå­æ•™æ.pdf#page=${d.page}" target="_blank" class="pdf-btn"><span>ğŸ“–</span> æ‰“å¼€æ•™æ (ç¬¬ ${d.page} é¡µ)</a>` : "";
        toggleSidebar(true);
    }

    document.getElementById("search").addEventListener("input", (e) => {
        const val = e.target.value.toLowerCase();
        node.style("opacity", d => d.label.toLowerCase().includes(val) ? 1 : 0.1);
        link.style("opacity", d => d.source.label.toLowerCase().includes(val) || d.target.label.toLowerCase().includes(val) ? 1 : 0.05);
    });
</script>
</body>
</html>
