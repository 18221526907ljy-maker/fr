<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACCA FR ç»ˆæå¤ä¹ å›¾è°± (ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-color: #020617;
            --sidebar-bg: #0f172a;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border-color: #334155;
            
            /* é¢œè‰²ç¼–ç  */
            --c-framework: #ef4444; /* çº¢ */
            --c-assets: #f59e0b;    /* é»„ */
            --c-liab: #10b981;      /* ç»¿ */
            --c-perf: #06b6d4;      /* é’ */
            --c-consol: #8b5cf6;    /* ç´« */
            --c-analy: #ec4899;     /* ç²‰ */
            --c-case: #64748b;      /* ç° */
        }

        body { margin: 0; overflow: hidden; background: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        #container { display: flex; width: 100vw; height: 100vh; }
        
        #graph-area { flex: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        /* åŠ è½½æç¤º */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-sub); font-size: 1.5rem; pointer-events: none;
        }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: 450px;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            position: absolute;
            right: 0; top: 0; height: 100%;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
            box-shadow: -10px 0 30px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
        }
        #sidebar.active { transform: translateX(0); }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .sidebar-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        h2 { font-size: 1.4rem; margin: 0 0 10px 0; color: var(--text-main); line-height: 1.3; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; color: #000; text-transform: uppercase; }

        /* è¯¦æƒ…æ¡† */
        .detail-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .desc { line-height: 1.6; color: #cbd5e1; font-size: 0.95rem; white-space: pre-wrap; }
        
        /* æ¡ˆä¾‹æ¡† */
        .example-box {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--c-case);
            margin-top: 15px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        /* PDF æŒ‰é’® */
        .pdf-container { padding: 20px; border-top: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .pdf-btn {
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #e11d48, #be123c);
            color: white; text-decoration: none;
            padding: 12px; border-radius: 8px; font-weight: bold;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
        }
        .pdf-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(225, 29, 72, 0.5); }

        /* å…³é—­æŒ‰é’® */
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-sub); font-size: 1.8rem; cursor: pointer; }
        .close-btn:hover { color: white; }

        /* æœç´¢æ¡† */
        #controls { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
        #search { background: #020617; border: 1px solid var(--border-color); color: white; padding: 8px 12px; border-radius: 6px; width: 200px; outline: none; }
        
        /* å›¾ä¾‹ */
        .legend-item { display: flex; align-items: center; margin-top: 8px; font-size: 0.8rem; color: var(--text-sub); }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }

    </style>
</head>
<body>

<div id="container">
    <div id="graph-area">
        <div id="loading">æ­£åœ¨åŠ è½½çŸ¥è¯†å›¾è°±...<br><span style="font-size:0.8rem; opacity:0.7;">(å¦‚æœé•¿æ—¶é—´æœªæ˜¾ç¤ºï¼Œè¯·æ£€æŸ¥ç½‘ç»œæ˜¯å¦èƒ½åŠ è½½ cdnjs)</span></div>
        <div id="controls">
            <input type="text" id="search" placeholder="ğŸ” æœç´¢çŸ¥è¯†ç‚¹...">
            <div style="margin-top:15px; border-top:1px solid #334155; padding-top:10px;">
                <div class="legend-item"><div class="dot" style="background:var(--c-framework)"></div>æ¦‚å¿µä¸ç›‘ç®¡</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-assets)"></div>èµ„äº§å‡†åˆ™</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-liab)"></div>è´Ÿå€º/æƒç›Š</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-perf)"></div>ç»©æ•ˆ/æ”¶å…¥</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-consol)"></div>åˆå¹¶æŠ¥è¡¨</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-analy)"></div>åˆ†æ</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-case)"></div>æ¡ˆä¾‹</div>
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <div class="sidebar-header">
            <button class="close-btn" onclick="toggleSidebar(false)">Ã—</button>
            <div id="header-content"></div>
        </div>
        <div class="sidebar-body">
            <div id="body-content"></div>
        </div>
        <div class="pdf-container" id="pdf-footer"></div>
    </div>
</div>

<script>
    // æ£€æŸ¥ D3 æ˜¯å¦åŠ è½½
    if (typeof d3 === 'undefined') {
        document.getElementById('loading').innerHTML = "é”™è¯¯ï¼šD3.js åŠ è½½å¤±è´¥ã€‚<br>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•ä½¿ç”¨æ¢¯å­ã€‚";
    }

    // --- 1. å®Œæ•´æ•°æ®æ„å»º ---
    const nodes = [
        { id: "Root", label: "ACCA FR æ ¸å¿ƒå›¾è°±", group: 0, r: 45, page: 1, desc: "Financial Reporting çŸ¥è¯†ä½“ç³»æ¦‚è§ˆ" },

        // === 1. æ¦‚å¿µä¸ç›‘ç®¡ (Framework - Red) ===
        { id: "Mod_Frame", label: "æ¦‚å¿µä¸ç›‘ç®¡", group: 1, parent: "Root", page: 9, desc: "è´¢åŠ¡æŠ¥å‘Šçš„ç†è®ºåŸºçŸ³ä¸è§„åˆ™ã€‚" },
        [cite_start]{ id: "Ch2", label: "æ¦‚å¿µæ¡†æ¶", group: 1, parent: "Mod_Frame", page: 9, desc: "ä¸ºå‡†åˆ™åˆ¶å®šæä¾›ç†è®ºåŸºç¡€ï¼Œæœ¬èº«ä¸æ˜¯å‡†åˆ™ [cite: 65][cite_start]ã€‚\nå½“å‡†åˆ™ä¸æ¡†æ¶å†²çªæ—¶ï¼Œ**å‡†åˆ™ä¼˜å…ˆ** (IFRS overrides Framework) [cite: 67]ã€‚" },
        [cite_start]{ id: "Qual", label: "è´¨é‡ç‰¹å¾", group: 1, parent: "Ch2", page: 10, desc: "â— **åŸºæœ¬ç‰¹å¾ (Fundamental):**\n  1. ç›¸å…³æ€§ (Relevance): é¢„æµ‹/è¯å®ä»·å€¼ã€‚\n  2. å¦‚å®åæ˜  (Faithful Rep): å®Œæ•´ã€ä¸­ç«‹ã€æ— è¯¯ [cite: 103][cite_start]ã€‚\n\nâ— **å¼ºåŒ–ç‰¹å¾ (Enhancing):**\n  å¯æ¯”æ€§ã€å¯éªŒè¯æ€§ã€åŠæ—¶æ€§ã€å¯ç†è§£æ€§ [cite: 103-110]ã€‚" },
        [cite_start]{ id: "Meas", label: "è®¡é‡åŸºç¡€", group: 1, parent: "Ch2", page: 13, desc: "â— **å†å²æˆæœ¬ (Historical Cost):** è´­ä¹°ä»· + äº¤æ˜“è´¹ [cite: 140][cite_start]ã€‚\nâ— **ç°è¡Œä»·å€¼ (Current Value):**\n  1. å…¬å…ä»·å€¼ (Fair Value): å¸‚åœºå‚ä¸è€…æœ‰åºäº¤æ˜“ä»·æ ¼ (Exit price)ã€‚\n  2. ä½¿ç”¨ä»·å€¼ (Value in Use): æœªæ¥ç°é‡‘æµæŠ˜ç° (Entity specific)ã€‚\n  3. ç°è¡Œæˆæœ¬ (Current Cost): ç°åœ¨è´­ä¹°ç›¸åŒèµ„äº§çš„æˆæœ¬ [cite: 140-147]ã€‚" },
        [cite_start]{ id: "S1", label: "IFRS S1 å¯æŒç»­", group: 1, parent: "Mod_Frame", page: 19, desc: "æ ¸å¿ƒæŠ«éœ²å†…å®¹ï¼šGovernance, Strategy, Risk Mgmt, Metrics & Targets [cite: 250]ã€‚" },

        // === 2. èµ„äº§ (Assets - Yellow) ===
        { id: "Mod_Asset", label: "èµ„äº§å‡†åˆ™", group: 2, parent: "Root", page: 23, desc: "æ ¸å¿ƒèµ„äº§ç±»çš„ç¡®è®¤ã€è®¡é‡ä¸æŠ«éœ²ã€‚" },
        
        // IAS 16 PPE
        [cite_start]{ id: "IAS16", label: "IAS 16 å›ºå®šèµ„äº§", group: 2, parent: "Mod_Asset", page: 23, desc: "æœ‰å½¢èµ„äº§ï¼Œç”¨äºç”Ÿäº§/ä¾›åº”/ç®¡ç†ï¼Œä½¿ç”¨è¶…è¿‡ä¸€æœŸ [cite: 333]ã€‚" },
        [cite_start]{ id: "Init", label: "åˆå§‹è®¡é‡", group: 2, parent: "IAS16", page: 24, desc: "Cost = è´­ä¹°ä»· + è¿›å£ç¨ + **ç›´æ¥å½’å±è´¹ç”¨** (åœºåœ°å‡†å¤‡ã€è¿è´¹ã€å®‰è£…ã€æµ‹è¯•ã€ä¸“ä¸šè´¹) + **æ‹†é™¤æˆæœ¬ç°å€¼** (IAS 37) [cite: 341][cite_start]ã€‚\nâŒ ä¸åŒ…æ‹¬ï¼šç®¡ç†è´¹ã€å‘˜å·¥åŸ¹è®­ã€å¯åŠ¨äºæŸ [cite: 362]ã€‚" },
        [cite_start]{ id: "Reval", label: "é‡ä¼°æ¨¡å‹", group: 2, parent: "IAS16", page: 25, desc: "â— **å¢å€¼ (Gain):** è®¡å…¥ OCIï¼Œç´¯è®¡ä¸ºé‡ä¼°ç›ˆä½™ (Revaluation Surplus) [cite: 398][cite_start]ã€‚\nâ— **å‡å€¼ (Loss):** å…ˆå†²å‡ RSï¼Œä¸å¤Ÿå†è¿› SPL [cite: 406][cite_start]ã€‚\nâ— **æŠ˜æ—§:** æŒ‰é‡ä¼°åä»·å€¼è®¡ç®—ã€‚\nâ— **å¤šä½™æŠ˜æ—§:** æ¯å¹´å¯ä» RS è½¬å…¥ RE (RS -> RE) [cite: 432]ã€‚" },
        { id: "Case_Topsy", label: "æ¡ˆä¾‹: Topsy Co", group: 7, parent: "Reval", page: 25, desc: "ã€é‡ä¼°ç›ˆä½™è®¡ç®—å®æˆ˜ã€‘\n1. **å¤šä½™æŠ˜æ—§è½¬ç§»:**\n   æ–°æŠ˜æ—§ ($30k) - æ—§æŠ˜æ—§ ($15k) = $15k (Dr RS, Cr RE)ã€‚\n2. **åœŸåœ°æ–°é‡ä¼°:**\n   FV $950k - Cost $800k = +$150k (Dr Asset, Cr RS)ã€‚\n3. **æœŸæœ« RS:** $705k - $15k + $150k = **$840,000**ã€‚" },

        // IAS 38 Intangible
        [cite_start]{ id: "IAS38", label: "IAS 38 æ— å½¢èµ„äº§", group: 2, parent: "Mod_Asset", page: 30, desc: "æ— å®ç‰©å½¢æ€ã€å¯è¾¨è®¤ã€éè´§å¸æ€§èµ„äº§ [cite: 498]ã€‚" },
        [cite_start]{ id: "RD", label: "R&D ç ”å‘", group: 2, parent: "IAS38", page: 31, desc: "â— **ç ”ç©¶ (Research):** è´¹ç”¨åŒ– (Expense)ã€‚\nâ— **å¼€å‘ (Development):** èµ„æœ¬åŒ– (Capitalize)ï¼Œéœ€æ»¡è¶³ PIRATE æ¡ä»¶ (Probable benefits, Intention, Resources, Ability, Technical feasibility, Expenditure measured reliably) [cite: 525]ã€‚" },
        { id: "Case_Assoria", label: "æ¡ˆä¾‹: Assoria", group: 7, parent: "RD", page: 33, desc: "ã€R&D æ‘Šé”€ã€‘\nResearch cost ($1.4m) -> SPLã€‚\nDevelopment cost åªæœ‰åœ¨æ»¡è¶³èµ„æœ¬åŒ–æ¡ä»¶**ä¹‹å**å‘ç”Ÿçš„æ‰èƒ½èµ„æœ¬åŒ–ã€‚æ‘Šé”€ä»**Ready for use**å¼€å§‹ã€‚" },

        // IAS 40 Investment Property
        [cite_start]{ id: "IAS40", label: "IAS 40 æŠ•èµ„æˆ¿äº§", group: 2, parent: "Mod_Asset", page: 35, desc: "ä¸ºèµšå–ç§Ÿé‡‘æˆ–èµ„æœ¬å¢å€¼è€ŒæŒæœ‰çš„æˆ¿äº§ [cite: 594]ã€‚" },
        [cite_start]{ id: "FV_Mod", label: "å…¬å…ä»·å€¼æ¨¡å‹", group: 2, parent: "IAS40", page: 36, desc: "é»˜è®¤æ¨¡å‹ã€‚æœŸæœ«æŒ‰ FV è®¡é‡ï¼Œ**å˜åŠ¨è®¡å…¥ SPL** (æŠ•èµ„æ”¶ç›Š)ã€‚**ä¸è®¡ææŠ˜æ—§** [cite: 620]ã€‚\n(åŒºåˆ«äº IAS 16 é‡ä¼°æ¨¡å‹å˜åŠ¨è¿› OCI)ã€‚" },

        // IAS 36 Impairment
        [cite_start]{ id: "IAS36", label: "IAS 36 å‡å€¼", group: 2, parent: "Mod_Asset", page: 39, desc: "å½“ Carrying Amount > Recoverable Amount æ—¶ç¡®è®¤å‡å€¼ [cite: 705]ã€‚" },
        { id: "RA_Calc", label: "å¯å›æ”¶é‡‘é¢ (RA)", group: 2, parent: "IAS36", page: 40, desc: "RA = **Higher of**:\n1. FV less Cost to Sell (å…¬å…ä»·å€¼å‡å‡ºå”®æˆæœ¬)\n2. [cite_start]Value in Use (æœªæ¥ç°é‡‘æµæŠ˜ç°) [cite: 706]ã€‚" },
        [cite_start]{ id: "CGU", label: "CGU å‡å€¼åˆ†æ‘Š", group: 2, parent: "IAS36", page: 40, desc: "åˆ†æ‘Šé¡ºåº [cite: 722]ï¼š\n1. æ˜æ˜¾å—æŸçš„ç‰¹å®šèµ„äº§ã€‚\n2. **å•†èª‰ (Goodwill)**ã€‚\n3. å‰©ä½™èµ„äº§æŒ‰è´¦é¢ä»·å€¼æ¯”ä¾‹åˆ†æ‘Š (Pro-rata)ã€‚" },
        [cite_start]{ id: "Case_Riley", label: "æ¡ˆä¾‹: Riley", group: 7, parent: "RA_Calc", page: 42, desc: "ã€å‡å€¼è®¡ç®—ã€‘\nNBV=$50kã€‚\nFV-CTS=$30kã€‚\nVIU=$31,875 (æŠ˜ç°è®¡ç®—)ã€‚\nRA=$31,875 (å–è¾ƒé«˜è€…)ã€‚\nImpairment = $50k - $31,875 = **$18,125** [cite: 754]ã€‚" },

        // IAS 23 & IAS 2
        [cite_start]{ id: "IAS23", label: "IAS 23 å€Ÿæ¬¾è´¹ç”¨", group: 2, parent: "Mod_Asset", page: 44, desc: "ç¬¦åˆæ¡ä»¶çš„èµ„äº§ (Qualifying Asset) éœ€èµ„æœ¬åŒ–åˆ©æ¯ã€‚\nèµ„æœ¬åŒ–é‡‘é¢ = å®é™…åˆ©æ¯ - é—²ç½®èµ„é‡‘æŠ•èµ„æ”¶ç›Š [cite: 824]ã€‚" },
        [cite_start]{ id: "IAS2", label: "IAS 2 å­˜è´§", group: 2, parent: "Mod_Asset", page: 46, desc: "è®¡é‡ï¼š**Lower of Cost and NRV** [cite: 872][cite_start]ã€‚\nNRV = é¢„è®¡å”®ä»· - å®Œå·¥æˆæœ¬ - é”€å”®è´¹ç”¨ [cite: 898]ã€‚" },

        // === 3. è´Ÿå€ºä¸æƒç›Š (Liab & Equity - Green) ===
        { id: "Mod_Liab", label: "è´Ÿå€ºä¸æƒç›Š", group: 3, parent: "Root", page: 57, desc: "èèµ„å·¥å…·ä¸ä¹‰åŠ¡ã€‚" },
        
        // IFRS 16 Leases
        [cite_start]{ id: "IFRS16", label: "IFRS 16 ç§Ÿèµ", group: 3, parent: "Mod_Liab", page: 57, desc: "æ‰¿ç§Ÿäººå•ä¸€æ¨¡å‹ï¼šç¡®è®¤ä½¿ç”¨æƒèµ„äº§ (ROU Asset) å’Œ ç§Ÿèµè´Ÿå€º (Lease Liability)ã€‚\nè±å…ï¼šçŸ­æœŸ (<12æœˆ) æˆ– ä½ä»·å€¼èµ„äº§ [cite: 1094]ã€‚" },
        [cite_start]{ id: "L_Calc", label: "è®¡é‡é€»è¾‘", group: 3, parent: "IFRS16", page: 58, desc: "â— **è´Ÿå€º:** ç§Ÿèµä»˜æ¬¾é¢ç°å€¼ (PV)ã€‚åç»­æŒ‰æ‘Šä½™æˆæœ¬æ³• (Amortized Cost) [cite: 1098][cite_start]ã€‚\nâ— **èµ„äº§:** è´Ÿå€ºåˆå§‹é¢ + é¢„ä»˜ + ç›´æ¥è´¹ + æ‹†é™¤è´¹ã€‚åç»­æŒ‰æˆæœ¬æ¨¡å¼æŠ˜æ—§ [cite: 1104]ã€‚" },
        { id: "Case_Pebworth", label: "æ¡ˆä¾‹: Pebworth", group: 7, parent: "L_Calc", page: 62, desc: "ã€SPL è´¹ç”¨è®¡ç®—ã€‘\n1. **æŠ˜æ—§ (Depn):** ROU Asset / Shorter of lease term or lifeã€‚\n2. **èèµ„æˆæœ¬ (Finance Cost):** Opening Liability * Interest Rateã€‚\nTotal Charge = Depn + Finance Costã€‚" },

        // IAS 37 Provisions
        [cite_start]{ id: "IAS37", label: "IAS 37 é¢„è®¡è´Ÿå€º", group: 3, parent: "Mod_Liab", page: 64, desc: "æ—¶é—´æˆ–é‡‘é¢ä¸ç¡®å®šçš„è´Ÿå€º [cite: 1225]ã€‚" },
        { id: "Prov_Rule", label: "ç¡®è®¤ä¸‰è¦ç´ ", group: 3, parent: "IAS37", page: 64, desc: "1. [cite_start]**ç°æ—¶ä¹‰åŠ¡** (Present Obligation): ç”±è¿‡å»äº‹é¡¹å¼•èµ· [cite: 1227]ã€‚\n2. [cite_start]**å¾ˆå¯èƒ½æµå‡º** (Probable outflow, >50%) [cite: 1236]ã€‚\n3. [cite_start]**å¯é ä¼°è®¡** (Reliable estimate) [cite: 1237]ã€‚" },
        [cite_start]{ id: "Case_Onerous", label: "äºæŸåˆåŒ", group: 7, parent: "IAS37", page: 65, desc: "Onerous Contract: å±¥è¡ŒåˆåŒçš„ä¸å¯é¿å…æˆæœ¬è¶…è¿‡äº†é¢„æœŸæ”¶ç›Šã€‚\nProvision = Lower of (å±¥è¡Œæˆæœ¬, è¿çº¦ç½šé‡‘) [cite: 1247]ã€‚" },

        // IAS 12 Tax
        { id: "IAS12", label: "IAS 12 æ‰€å¾—ç¨", group: 3, parent: "Mod_Liab", page: 69, desc: "ä¼šè®¡åˆ©æ¶¦ä¸ç¨åŠ¡åˆ©æ¶¦çš„å·®å¼‚å¤„ç†ã€‚" },
        [cite_start]{ id: "Def_Tax", label: "é€’å»¶æ‰€å¾—ç¨", group: 3, parent: "IAS12", page: 70, desc: "â— **æ¥æº:** æš‚æ—¶æ€§å·®å¼‚ (Temporary Difference) = è´¦é¢ä»·å€¼ (CA) - è®¡ç¨åŸºç¡€ (TB)ã€‚\nâ— **è®¡ç®—:** DTL = (CA > TB) * Rate [cite: 1321]ã€‚\nâ— **å˜åŠ¨:** æœŸæœ«ä½™é¢ - æœŸåˆä½™é¢ = å½“æœŸ Tax Expense (æˆ– OCI)ã€‚" },

        // IFRS 9 Financial Instruments
        { id: "IFRS9", label: "IFRS 9 é‡‘èå·¥å…·", group: 3, parent: "Mod_Liab", page: 77, desc: "é‡‘èèµ„äº§ä¸è´Ÿå€ºçš„åˆ†ç±»ä¸è®¡é‡ã€‚" },
        { id: "Fin_Asset", label: "é‡‘èèµ„äº§", group: 3, parent: "IFRS9", page: 78, desc: "1. **Amortized Cost:** æ”¶å–åˆåŒç°é‡‘æµ (æœ¬é‡‘+åˆ©æ¯)ã€‚\n2. **FVTPL:** äº¤æ˜“ç›®çš„ (é»˜è®¤åˆ†ç±»)ï¼Œå˜åŠ¨è¿› SPLã€‚\n3. [cite_start]**FVTOCI:** æˆ˜ç•¥æŠ•èµ„è‚¡ç¥¨ï¼Œå˜åŠ¨è¿› OCI (ä¸å¯å›è½¬) [cite: 1431]ã€‚" },
        { id: "IAS32", label: "æ··åˆå·¥å…·", group: 3, parent: "IFRS9", page: 80, desc: "å¯è½¬å€º (Convertible Bonds) éœ€æ‹†åˆ† (Split Accounting):\n1. **è´Ÿå€ºæˆåˆ†:** æœªæ¥ç°é‡‘æµæŒ‰å¸‚åœºåˆ©ç‡(æ— è½¬æ¢æƒ)æŠ˜ç°ã€‚\n2. [cite_start]**æƒç›Šæˆåˆ†:** å‘è¡Œå¾—æ¬¾ - è´Ÿå€ºæˆåˆ† (Residual) [cite: 1474]ã€‚" },

        // === 4. ç»©æ•ˆ (Performance - Cyan) ===
        { id: "Mod_Perf", label: "ç»©æ•ˆæŠ¥è¡¨", group: 4, parent: "Root", page: 84, desc: "æ”¶å…¥ç¡®è®¤ä¸ EPS è®¡ç®—ã€‚" },
        { id: "IFRS15", label: "IFRS 15 æ”¶å…¥", group: 4, parent: "Mod_Perf", page: 84, desc: "äº”æ­¥æ³•æ¨¡å‹ (5-Step Model)ã€‚" },
        { id: "Step5", label: "äº”æ­¥æ³•", group: 4, parent: "IFRS15", page: 85, desc: "1. è¯†åˆ«åˆåŒ\n2. è¯†åˆ«å±¥çº¦ä¹‰åŠ¡ (PO)\n3. ç¡®å®šä»·æ ¼\n4. åˆ†æ‘Šä»·æ ¼\n5. [cite_start]**å±¥è¡Œä¹‰åŠ¡æ—¶ç¡®è®¤æ”¶å…¥** (æ—¶ç‚¹æˆ–æ—¶æ®µ) [cite: 1559-1562]ã€‚" },
        [cite_start]{ id: "Cons_Cont", label: "å»ºé€ åˆåŒ", group: 4, parent: "IFRS15", page: 88, desc: "å±äºæ—¶æ®µç¡®è®¤ (Over time)ã€‚\nè¿›åº¦æŒ‰ **æŠ•å…¥æ³• (Input)** æˆ– **äº§å‡ºæ³• (Output)** è®¡ç®—ã€‚\näºæŸåˆåŒéœ€ç«‹å³ç¡®è®¤å…¨éƒ¨é¢„è®¡æŸå¤± [cite: 1594]ã€‚" },
        
        { id: "IAS33", label: "IAS 33 EPS", group: 4, parent: "Mod_Perf", page: 101, desc: "æ¯è‚¡æ”¶ç›Šã€‚" },
        [cite_start]{ id: "Basic", label: "åŸºæœ¬ EPS", group: 4, parent: "IAS33", page: 101, desc: "EPS = å½’å±æ™®é€šè‚¡è‚¡ä¸œå‡€åˆ©æ¶¦ / åŠ æƒå¹³å‡è‚¡æ•° (WANS)ã€‚\nâ— **çº¢è‚¡ (Bonus):** è§†ä¸ºæœŸåˆå‘è¡Œï¼Œéœ€è°ƒæ•´å»å¹´ EPSã€‚\nâ— **é…è‚¡ (Rights):** éœ€è®¡ç®—é™¤æƒä»· (TERP) [cite: 1806]ã€‚" },

        // === 5. åˆå¹¶æŠ¥è¡¨ (Consolidation - Purple) ===
        { id: "Mod_Consol", label: "åˆå¹¶æŠ¥è¡¨", group: 5, parent: "Root", page: 133, desc: "FR è€ƒè¯•çš„æ ¸å¿ƒéš¾ç‚¹ï¼šIFRS 10 & IFRS 3ã€‚" },
        [cite_start]{ id: "Process", label: "åˆå¹¶äº”æ­¥æ³• (SOFP)", group: 5, parent: "Mod_Consol", page: 142, desc: "åˆå¹¶èµ„äº§è´Ÿå€ºè¡¨çš„æ ‡å‡†æµç¨‹ [cite: 1945]ã€‚" },
        [cite_start]{ id: "W1", label: "W1: é›†å›¢ç»“æ„", group: 5, parent: "Process", page: 142, desc: "â— ç¡®å®šæ”¶è´­æ—¥ã€æŒè‚¡æ¯”ä¾‹ã€‚\nâ— è®¡ç®— **Cost of Investment**: ç°é‡‘ã€æ¢è‚¡ã€é€’å»¶å¯¹ä»· (PV)ã€æˆ–æœ‰å¯¹ä»· (FV) [cite: 1945]ã€‚" },
        [cite_start]{ id: "W2", label: "W2: å­å…¬å¸å‡€èµ„äº§", group: 5, parent: "Process", page: 153, desc: "â— **At Acquisition:** ç”¨äºç®—å•†èª‰ã€‚\nâ— **At Reporting Date:** ç”¨äºç®— NCI å’Œ Group REã€‚\nâ— **è°ƒæ•´:** å…¬å…ä»·å€¼è°ƒæ•´ (FV Adj)ã€æœªå®ç°åˆ©æ¶¦ (URP-Sub)ã€è¡¥ææŠ˜æ—§ [cite: 1967]ã€‚" },
        [cite_start]{ id: "W3", label: "W3: å•†èª‰", group: 5, parent: "Process", page: 154, desc: "Goodwill = Cost of Investment + FV of NCI - Net Assets @ Acqã€‚\nâ— **å‡å€¼:** Impairment è®¡å…¥å½“æœŸæŸç›Š (Group RE) [cite: 1968]ã€‚" },
        [cite_start]{ id: "W4", label: "W4: NCI", group: 5, parent: "Process", page: 154, desc: "æœŸæœ« NCI = NCI @ Acq + NCI% * (Post-acq Net Assets Change) - NCI% * Impairment [cite: 1968]ã€‚" },
        [cite_start]{ id: "W5", label: "W5: é›†å›¢RE", group: 5, parent: "Process", page: 154, desc: "Group RE = Parent RE + Parent% * Sub Post-acq RE - Parent% * Impairment - URP (Parent seller) [cite: 1968]ã€‚" },

        { id: "Adj", label: "åˆå¹¶è°ƒæ•´", group: 5, parent: "Mod_Consol", page: 156, desc: "æŠµæ¶ˆå†…éƒ¨äº¤æ˜“ã€‚" },
        [cite_start]{ id: "PURP", label: "PURP (æœªå®ç°åˆ©æ¶¦)", group: 5, parent: "Adj", page: 157, desc: "å­˜è´§å†…éƒ¨äº¤æ˜“æŠµæ¶ˆï¼š\nâ— **æ¯å–å­:** Dr Group RE, Cr Group Inventoryã€‚\nâ— **å­å–æ¯:** Dr Sub RE (W2), Cr Group Inventory (å½±å“ NCI) [cite: 1980]ã€‚" },
        
        [cite_start]{ id: "Assoc", label: "IAS 28 è”è¥å…¬å¸", group: 5, parent: "Mod_Consol", page: 164, desc: "é‡å¤§å½±å“ (Significant Influence, 20%-50%) -> **æƒç›Šæ³• (Equity Method)**ã€‚\nâŒ ä¸åˆå¹¶èµ„äº§è´Ÿå€ºï¼Œåªç¡®è®¤ä¸€é¡¹èµ„äº§ Investment in Associateã€‚\nè®¡ç®—: Cost + Share of Post-acq Profit - Dividend [cite: 2000]ã€‚" },

        // === 6. åˆ†æ (Analysis - Pink) ===
        { id: "Mod_Analy", label: "åˆ†æä¸è§£è¯»", group: 6, parent: "Root", page: 128, desc: "è´¢æŠ¥åˆ†æä¸ç°é‡‘æµã€‚" },
        [cite_start]{ id: "Ratios", label: "è´¢åŠ¡æ¯”ç‡", group: 6, parent: "Mod_Analy", page: 128, desc: "â— **ROCE:** PBIT / (Equity + Debt) [cite: 1897][cite_start]ã€‚\nâ— **Gearing:** Debt / (Equity + Debt) [cite: 1898]ã€‚\nâ— **Liquidity:** Current Ratio, Quick Ratioã€‚\nâ— **Working Capital:** Inv days + Rec days - Pay daysã€‚" },
        [cite_start]{ id: "Cashflow", label: "IAS 7 ç°é‡‘æµ", group: 6, parent: "Mod_Analy", page: 122, desc: "â— **ç»è¥æ´»åŠ¨ (Operating):** PBIT + Depn +/- WC Changes - Interest - Tax [cite: 1883]ã€‚\nâ— **æŠ•èµ„æ´»åŠ¨ (Investing):** è´­ä¹°/å‡ºå”®èµ„äº§ã€æ”¶åˆ©æ¯ã€‚\nâ— **èèµ„æ´»åŠ¨ (Financing):** å‘è¡Œè‚¡ç¥¨/å€ºåˆ¸ã€ä»˜è‚¡åˆ©ã€‚" }
    ];

    const links = nodes.filter(n => n.parent).map(n => ({ source: n.parent, target: n.id }));

    // --- 2. D3.js æ¸²æŸ“ ---
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    const svg = d3.select("#graph-area").append("svg")
        .attr("width", width).attr("height", height)
        .call(d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => g.attr("transform", e.transform)))
        .on("dblclick.zoom", null);

    const g = svg.append("g");

    // é¢œè‰²æ˜ å°„
    const colorMap = {
        0: "#fff", 1: "#ef4444", 2: "#f59e0b", 3: "#10b981", 4: "#06b6d4", 5: "#8b5cf6", 6: "#ec4899", 7: "#64748b"
    };

    // åŠ›å¯¼å‘æ¨¡æ‹Ÿ
    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
            if (d.source.group === 0) return 180;
            if (d.source.group === 1) return 120;
            if (d.source.group === 5) return 100;
            return 60;
        }))
        .force("charge", d3.forceManyBody().strength(-500))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(30).iterations(2));

    // è¿çº¿
    const link = g.append("g").selectAll("line")
        .data(links).join("line")
        .attr("stroke", "#334155").attr("stroke-width", 1.5).attr("stroke-opacity", 0.6);

    // èŠ‚ç‚¹
    const node = g.append("g").selectAll("g")
        .data(nodes).join("g")
        .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend))
        .on("click", (e, d) => { e.stopPropagation(); showInfo(d); });

    node.append("circle")
        .attr("r", d => d.group === 0 ? 40 : (d.group === 7 ? 10 : 18))
        .attr("fill", d => colorMap[d.group])
        .attr("stroke", "#fff").attr("stroke-width", 2)
        .style("cursor", "pointer");

    node.append("text")
        .text(d => d.label)
        .attr("x", d => d.group === 0 ? 45 : 22)
        .attr("y", 5)
        .style("font-size", d => d.group === 0 ? "18px" : "12px")
        .style("fill", "#e2e8f0")
        .style("font-weight", d => d.group <= 2 ? "bold" : "normal")
        .style("pointer-events", "none")
        .style("text-shadow", "2px 2px 3px #000");

    // åŠ è½½å®Œæˆç§»é™¤æç¤º
    document.getElementById('loading').style.display = 'none';

    // --- 3. äº¤äº’é€»è¾‘ ---
    function dragstart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragend(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    function toggleSidebar(show) {
        const sb = document.getElementById("sidebar");
        show ? sb.classList.add("active") : sb.classList.remove("active");
    }

    function showInfo(d) {
        const header = document.getElementById("header-content");
        const body = document.getElementById("body-content");
        const footer = document.getElementById("pdf-footer");
        
        const groupNames = ["Core", "Framework", "Assets", "Liabilities", "Performance", "Consolidation", "Analysis", "Case"];
        const color = colorMap[d.group];

        // 1. Header
        header.innerHTML = `
            <span class="badge" style="background:${color}">${groupNames[d.group]}</span>
            <h2>${d.label}</h2>
        `;

        // 2. Body
        let descHtml = '';
        if (d.group === 7) {
            descHtml = `<div class="example-box">${formatText(d.desc)}</div>`;
        } else {
            if (d.desc) {
                descHtml += `<div class="detail-box">
                    <div class="detail-title" style="color:${color}">çŸ¥è¯†è¦ç‚¹</div>
                    <div class="desc">${formatText(d.desc)}</div>
                </div>`;
            }
        }
        body.innerHTML = descHtml || `<div class="desc" style="text-align:center; color:#64748b;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹æ•™æè¯¦æƒ…</div>`;

        // 3. Footer (PDF Button)
        if (d.page) {
            footer.innerHTML = `
                <a href="FRç”µå­æ•™æ.pdf#page=${d.page}" target="_blank" class="pdf-btn">
                    <span>ğŸ“–</span> æ‰“å¼€æ•™æ (ç¬¬ ${d.page} é¡µ)
                </a>`;
        } else {
            footer.innerHTML = '';
        }

        toggleSidebar(true);
    }

    function formatText(text) {
        if (!text) return "";
        // é«˜äº®å¼•ç”¨
        text = text.replace(/\/g, '<span style="color:#64748b; font-size:0.8em; margin-left:5px;">$&</span>');
        // é«˜äº® **Text**
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong style="color:#fff; border-bottom:1px dashed #64748b;">$1</strong>');
        return text;
    }

    // æœç´¢
    document.getElementById("search").addEventListener("input", (e) => {
        const val = e.target.value.toLowerCase();
        node.style("opacity", d => d.label.toLowerCase().includes(val) ? 1 : 0.1);
        link.style("opacity", d => d.source.label.toLowerCase().includes(val) || d.target.label.toLowerCase().includes(val) ? 1 : 0.05);
    });

</script>
</body>
</html>
