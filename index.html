<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACCA FR ç»ˆæå¤ä¹ å›¾è°± (è¡¨æ ¼å¢å¼ºç‰ˆ)</title>
    <script src="https://lib.baomitu.com/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border-color: #334155;
            
            /* é¢œè‰²ç¼–ç  */
            --c-framework: #ef4444; --c-assets: #f59e0b; --c-liab: #10b981;
            --c-perf: #06b6d4; --c-consol: #8b5cf6; --c-analy: #ec4899; --c-case: #64748b;
            --c-highlight: #f43f5e;
        }

        body { margin: 0; overflow: hidden; background: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
        #container { display: flex; width: 100vw; height: 100vh; }
        #graph-area { flex: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: 520px; /* åŠ å®½ä»¥å®¹çº³è¡¨æ ¼ */
            background: var(--sidebar-bg); border-left: 1px solid var(--border-color);
            position: absolute; right: 0; top: 0; height: 100%;
            transform: translateX(100%); transition: transform 0.3s ease; z-index: 20;
            box-shadow: -10px 0 30px rgba(0,0,0,0.6); display: flex; flex-direction: column;
        }
        #sidebar.active { transform: translateX(0); }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .sidebar-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        h2 { margin: 0 0 10px 0; color: var(--text-main); border-bottom: 2px solid #334155; padding-bottom: 10px; font-size: 1.4rem; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; color: #000; }

        /* --- è¡¨æ ¼æ ·å¼ (æ ¸å¿ƒå‡çº§) --- */
        .info-table {
            width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.85rem;
            background: rgba(0,0,0,0.2); border-radius: 6px; overflow: hidden;
        }
        .info-table th { background: rgba(255,255,255,0.1); text-align: left; padding: 8px; color: #38bdf8; font-weight: bold; border-bottom: 1px solid var(--border-color); }
        .info-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #cbd5e1; }
        .info-table tr:last-child td { border-bottom: none; }
        .info-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        .calc-row td { font-family: monospace; font-weight: bold; color: #fff; }
        .sub-total td { border-top: 1px dashed #64748b; font-style: italic; }

        /* è¯¦æƒ…å†…å®¹æ ·å¼ */
        .detail-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .detail-title { color: var(--text-sub); font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .desc { line-height: 1.7; color: #cbd5e1; font-size: 0.95rem; white-space: pre-wrap; }
        
        /* é«˜äº®æ ·å¼ */
        .highlight-box { border-left: 4px solid var(--c-highlight); background: rgba(244, 63, 94, 0.1); padding: 10px 15px; margin: 10px 0; border-radius: 0 4px 4px 0; }
        .tag-exam { color: #f43f5e; font-weight: bold; font-size: 0.85em; border: 1px solid #f43f5e; padding: 1px 4px; border-radius: 3px; margin-right: 5px; }
        .tag-mem { color: #fbbf24; font-weight: bold; font-size: 0.85em; border: 1px solid #fbbf24; padding: 1px 4px; border-radius: 3px; margin-right: 5px; }

        /* PDF æŒ‰é’® */
        .pdf-container { padding: 20px; border-top: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .pdf-btn {
            display: flex; align-items: center; justify-content: center; width: 100%;
            background: linear-gradient(135deg, #dc2626, #991b1b); color: white; text-decoration: none;
            padding: 12px; border-radius: 8px; font-weight: bold; border: 1px solid #7f1d1d;
            transition: all 0.2s;
        }
        .pdf-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4); }

        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-sub); font-size: 1.8rem; cursor: pointer; }
        
        /* æœç´¢æ  */
        #controls { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
        #search { background: #020617; border: 1px solid var(--border-color); color: white; padding: 8px 12px; border-radius: 6px; width: 220px; outline: none; }
        .legend-item { display: flex; align-items: center; margin-top: 8px; font-size: 0.8rem; color: var(--text-sub); }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>

<div id="container">
    <div id="graph-area">
        <div id="controls">
            <input type="text" id="search" placeholder="ğŸ” æœç´¢è€ƒç‚¹...">
            <div style="margin-top:15px; border-top:1px solid #334155; padding-top:10px;">
                <div class="legend-item"><div class="dot" style="background:var(--c-framework)"></div>æ¦‚å¿µä¸ç›‘ç®¡</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-assets)"></div>èµ„äº§å‡†åˆ™</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-liab)"></div>è´Ÿå€º/æƒç›Š</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-perf)"></div>ç»©æ•ˆ/æ”¶å…¥</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-consol)"></div>åˆå¹¶æŠ¥è¡¨</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-analy)"></div>åˆ†æ</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-case)"></div>æ¡ˆä¾‹</div>
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <div class="sidebar-header">
            <button class="close-btn" onclick="toggleSidebar(false)">Ã—</button>
            <div id="header-content"></div>
        </div>
        <div class="sidebar-body">
            <div id="body-content"></div>
        </div>
        <div class="pdf-container" id="pdf-footer"></div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒæ•°æ®æº (å«è¡¨æ ¼ HTML) ---
    const nodes = [
        { id: "Root", label: "ACCA FR è€ƒç‚¹å…¨å›¾", group: 0, r: 45, page: 1, desc: "åŒ…å«æ‰€æœ‰é‡è¦ Format å’Œ Proforma" },

        // === 1. æ¦‚å¿µä¸ç›‘ç®¡ ===
        { id: "Mod_Frame", label: "æ¦‚å¿µä¸ç›‘ç®¡", group: 1, parent: "Root", page: 9 },
        { id: "Elements", label: "äº”å¤§è¦ç´ ", group: 1, parent: "Mod_Frame", page: 12, desc: `
<table class="info-table">
    <tr><th>Element</th><th>Definition Key</th></tr>
    <tr><td>Asset</td><td>Present resource, Controlled, Past event</td></tr>
    <tr><td>Liability</td><td>Present obligation, Transfer resource, Past event</td></tr>
    <tr><td>Equity</td><td>Residual interest (Assets - Liab)</td></tr>
    <tr><td>Income</td><td>Increase in assets / Decrease in liab -> Equity â†‘</td></tr>
    <tr><td>Expense</td><td>Decrease in assets / Increase in liab -> Equity â†“</td></tr>
</table>` },

        // === 2. èµ„äº§ ===
        { id: "Mod_Asset", label: "èµ„äº§å‡†åˆ™", group: 2, parent: "Root", page: 23 },
        { id: "IAS16_Cost", label: "IAS 16 æˆæœ¬", group: 2, parent: "Mod_Asset", page: 24, desc: `
ã€âš¡è€ƒç‚¹ã€‘åˆå§‹æˆæœ¬æ„æˆï¼š
<table class="info-table">
    <tr><th>åŒ…å« (Include)</th><th>ä¸åŒ…å« (Exclude)</th></tr>
    <tr><td>Purchase Price</td><td>Administration overheads</td></tr>
    <tr><td>Import duties</td><td>Start-up costs</td></tr>
    <tr><td>Site prep / Delivery</td><td>Staff training</td></tr>
    <tr><td>Installation / Testing</td><td>Operating losses</td></tr>
    <tr><td>Dismantling (PV)</td><td>Maintenance</td></tr>
</table>` },
        { id: "IAS36", label: "IAS 36 å‡å€¼", group: 2, parent: "Mod_Asset", page: 40, desc: `
ã€ğŸ”¥èƒŒè¿‡ã€‘CGU å‡å€¼åˆ†æ‘Šé¡ºåºï¼š
<table class="info-table">
    <tr><th>Order</th><th>Asset</th><th>Rule</th></tr>
    <tr><td>1</td><td>Specific Asset</td><td>æ˜æ˜¾å—æŸæˆ–æ¯åçš„èµ„äº§</td></tr>
    <tr><td>2</td><td>Goodwill</td><td>å…ˆæŠµå‡å•†èª‰ï¼Œä¸å¯è½¬å›</td></tr>
    <tr><td>3</td><td>Others</td><td>å‰©ä½™èµ„äº§æŒ‰è´¦é¢ä»·å€¼æ¯”ä¾‹ (Pro-rata)</td></tr>
</table>
<br>æ³¨æ„ï¼šå•é¡¹èµ„äº§å‡å€¼åä¸èƒ½ä½äºå…¶ Recoverable Amount (å¦‚æœ‰)ã€‚` },

        // === 3. è´Ÿå€ºä¸æƒç›Š ===
        { id: "Mod_Liab", label: "è´Ÿå€ºä¸æƒç›Š", group: 3, parent: "Root", page: 57 },
        { id: "IFRS16", label: "IFRS 16 ç§Ÿèµ", group: 3, parent: "Mod_Liab", page: 57, desc: "ã€âš¡è€ƒç‚¹ã€‘ROU Asset åˆå§‹è®¡é‡ = Liab + Direct costs + Dismantling + Prepayments - Incentives." },

        // === 4. ç»©æ•ˆ/æ”¶å…¥ ===
        { id: "Mod_Perf", label: "ç»©æ•ˆæŠ¥è¡¨", group: 4, parent: "Root", page: 84 },
        { id: "SPL", label: "åˆ©æ¶¦è¡¨æ ¼å¼ (SPL)", group: 4, parent: "Mod_Perf", page: 7, desc: `
[cite_start]ã€ğŸ”¥Proformaã€‘IFRS 18 æ–°è§„åˆ†ç±» [cite: 45]ï¼š
<table class="info-table">
    <tr><th>Category</th><th>Item</th></tr>
    <tr><td>Revenue</td><td>Sales</td></tr>
    <tr><td>Cost of Sales</td><td>(COS)</td></tr>
    <tr class="calc-row"><td>Gross Profit</td><td>X</td></tr>
    <tr><td>Operating</td><td>Distribution / Admin expenses</td></tr>
    <tr class="calc-row"><td>Operating Profit</td><td>X</td></tr>
    <tr><td>Investing</td><td>Investment income, Share of Assoc Profit</td></tr>
    <tr><td>Financing</td><td>Interest expense</td></tr>
    <tr><td>Tax</td><td>Income tax expense</td></tr>
    <tr class="calc-row"><td>Profit for year</td><td>X</td></tr>
</table>` },
        { id: "IFRS15", label: "å»ºé€ åˆåŒ", group: 4, parent: "Mod_Perf", page: 88, desc: `
ã€âš¡è€ƒç‚¹ã€‘åˆåŒè¿›åº¦è®¡ç®— (Profit/Loss)ï¼š
<table class="info-table">
    <tr><td>Total Revenue</td><td>X</td></tr>
    <tr><td>Less: Total Cost</td><td>(X)</td></tr>
    <tr class="calc-row"><td>Overall Profit/Loss</td><td>X / (X)</td></tr>
</table>
<br>è‹¥æ˜¯äºæŸåˆåŒ (Loss)ï¼Œéœ€**ç«‹å³ç¡®è®¤å…¨éƒ¨é¢„è®¡æŸå¤±**ã€‚` },

        // === 5. åˆå¹¶æŠ¥è¡¨ (æ ¸å¿ƒè¡¨æ ¼åŒºåŸŸ) ===
        { id: "Mod_Consol", label: "åˆå¹¶æŠ¥è¡¨", group: 5, parent: "Root", page: 133 },
        { id: "W2", label: "W2: å‡€èµ„äº§è¡¨", group: 5, parent: "Mod_Consol", page: 153, desc: `
[cite_start]ã€ğŸ”¥èƒŒè¿‡ã€‘W2 Net Assets of Subsidiary [cite: 1962]
<table class="info-table">
    <tr><th>Item</th><th>At Acq</th><th>At Rep Date</th></tr>
    <tr><td>Share Capital</td><td>X</td><td>X</td></tr>
    <tr><td>Retained Earnings</td><td>X</td><td>X</td></tr>
    <tr><td>FV Adjustment</td><td>X</td><td>X</td></tr>
    <tr><td>Depn on FV Adj</td><td>-</td><td>(X)</td></tr>
    <tr><td>URP (Sub seller)</td><td>-</td><td>(X)</td></tr>
    <tr class="calc-row"><td>Total Net Assets</td><td>(A)</td><td>(B)</td></tr>
</table>` },
        { id: "W3", label: "W3: å•†èª‰è®¡ç®—", group: 5, parent: "Mod_Consol", page: 154, desc: `
[cite_start]ã€ğŸ”¥èƒŒè¿‡ã€‘W3 Goodwill Calculation [cite: 1963]
<table class="info-table">
    <tr><td>Cost of Investment</td><td>X</td></tr>
    <tr><td>Add: FV of NCI @ Acq</td><td>X</td></tr>
    <tr><td>Less: Net Assets @ Acq (W2)</td><td>(X)</td></tr>
    <tr class="calc-row"><td>Goodwill at Acq</td><td>X</td></tr>
    <tr><td>Less: Impairment to date</td><td>(X)</td></tr>
    <tr class="calc-row"><td>Carrying Amount</td><td>X</td></tr>
</table>` },
        { id: "W5", label: "W5: é›†å›¢ RE", group: 5, parent: "Mod_Consol", page: 154, desc: `
[cite_start]ã€ğŸ”¥èƒŒè¿‡ã€‘W5 Group Retained Earnings [cite: 1964]
<table class="info-table">
    <tr><td>Parent's 100% RE</td><td>X</td></tr>
    <tr><td>Add: Parent% x Sub Post-acq RE</td><td>X</td></tr>
    <tr><td>Less: Parent% x Goodwill Impairment</td><td>(X)</td></tr>
    <tr><td>Less: URP (if Parent seller)</td><td>(X)</td></tr>
    <tr><td>Add: Gain on bargain purchase</td><td>X</td></tr>
    <tr class="calc-row"><td>Group RE</td><td>X</td></tr>
</table>` },
        { id: "Disposal", label: "å¤„ç½®å­å…¬å¸", group: 5, parent: "Mod_Consol", page: 163, desc: `
[cite_start]ã€âš¡é«˜é¢‘ã€‘Group Gain on Disposal [cite: 1991]
<table class="info-table">
    <tr><td>Sale Proceeds</td><td>X</td></tr>
    <tr><td>Add: FV of Retained Interest</td><td>X</td></tr>
    <tr><td>Less: Net Assets at Disposal</td><td>(X)</td></tr>
    <tr><td>Less: Carrying Amt of Goodwill</td><td>(X)</td></tr>
    <tr><td>Add: Carrying Amt of NCI</td><td>X</td></tr>
    <tr class="calc-row"><td>Group Gain/Loss</td><td>X</td></tr>
</table>` },

        // === 6. åˆ†æ ===
        { id: "Mod_Analy", label: "åˆ†æ", group: 6, parent: "Root", page: 128 },
        { id: "Ratios", label: "å…³é”®æ¯”ç‡å…¬å¼", group: 6, parent: "Mod_Analy", page: 128, desc: `
[cite_start]ã€âš¡è€ƒç‚¹ã€‘å¿…èƒŒå…¬å¼è¡¨ [cite: 1892]ï¼š
<table class="info-table">
    <tr><th>Ratio</th><th>Formula</th></tr>
    <tr><td>ROCE</td><td>PBIT / (Equity + Debt) %</td></tr>
    <tr><td>Gearing</td><td>Debt / (Equity + Debt) %</td></tr>
    <tr><td>Interest Cover</td><td>PBIT / Interest expense</td></tr>
    <tr><td>Current Ratio</td><td>Current Assets / Current Liab</td></tr>
    <tr><td>Quick Ratio</td><td>(CA - Inventory) / CL</td></tr>
    <tr><td>Inv Days</td><td>Inv / COS * 365</td></tr>
    <tr><td>Rec Days</td><td>Receivables / Credit Sales * 365</td></tr>
</table>` },
        { id: "Cashflow", label: "ç°é‡‘æµ (é—´æ¥æ³•)", group: 6, parent: "Mod_Analy", page: 123, desc: `
[cite_start]ã€ğŸ”¥èƒŒè¿‡ã€‘Operating Activities [cite: 1878]ï¼š
<table class="info-table">
    <tr><td>Profit before tax</td><td>X</td></tr>
    <tr><td>Add: Finance cost</td><td>X</td></tr>
    <tr><td>Add: Depreciation / Amort</td><td>X</td></tr>
    <tr><td>Add: Loss on disposal</td><td>X</td></tr>
    <tr><td>(Incr)/Decr in Inventory</td><td>(X)/X</td></tr>
    <tr><td>(Incr)/Decr in Receivables</td><td>(X)/X</td></tr>
    <tr><td>Incr/(Decr) in Payables</td><td>X/(X)</td></tr>
    <tr><td>Less: Interest paid</td><td>(X)</td></tr>
    <tr><td>Less: Tax paid</td><td>(X)</td></tr>
    <tr class="calc-row"><td>Net Cash from Op</td><td>X</td></tr>
</table>` }
    ];

    // --- è¿çº¿ç”Ÿæˆ ---
    const nodeMap = new Map(nodes.map(n => [n.id, n]));
    const links = [];
    nodes.forEach(n => {
        if (n.parent && nodeMap.has(n.parent)) links.push({ source: n.parent, target: n.id });
    });

    // --- D3 æ¸²æŸ“ ---
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    const svg = d3.select("#graph-area").append("svg")
        .attr("width", width).attr("height", height)
        .call(d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => g.attr("transform", e.transform)))
        .on("dblclick.zoom", null);

    const g = svg.append("g");

    const colorMap = {
        0: "#fff", 1: "#ef4444", 2: "#f59e0b", 3: "#10b981", 4: "#06b6d4", 5: "#8b5cf6", 6: "#ec4899", 7: "#64748b"
    };

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-500))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(40));

    const link = g.append("g").selectAll("line")
        .data(links).join("line")
        .attr("stroke", "#334155").attr("stroke-width", 1.5).attr("stroke-opacity", 0.6);

    const node = g.append("g").selectAll("g")
        .data(nodes).join("g")
        .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend))
        .on("click", (e, d) => { e.stopPropagation(); showInfo(d); });

    node.append("circle")
        .attr("r", d => d.group === 0 ? 40 : 18)
        .attr("fill", d => colorMap[d.group])
        .attr("stroke", "#fff").attr("stroke-width", 2)
        .style("cursor", "pointer");

    node.append("text")
        .text(d => d.label)
        .attr("x", d => d.group === 0 ? 45 : 22)
        .attr("y", 5)
        .style("font-size", d => d.group === 0 ? "18px" : "12px")
        .style("fill", "#e2e8f0")
        .style("pointer-events", "none")
        .style("text-shadow", "2px 2px 3px #000");

    function dragstart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragend(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    function toggleSidebar(show) {
        const sb = document.getElementById("sidebar");
        show ? sb.classList.add("active") : sb.classList.remove("active");
    }

    function showInfo(d) {
        const header = document.getElementById("header-content");
        const body = document.getElementById("body-content");
        const footer = document.getElementById("pdf-footer");
        const color = colorMap[d.group];
        
        header.innerHTML = `<span class="badge" style="background:${color}; color:${d.group===0?'#000':'#fff'}">è€ƒç‚¹è¯¦æƒ…</span><h2>${d.label}</h2>`;
        
        let html = "";
        if (d.desc) {
            // æ ¼å¼åŒ–æ–‡å­—ä¸­çš„å¼ºè°ƒ
            let content = d.desc.replace(/\n/g, "<br>");
            content = content.replace(/ã€(.*?)ã€‘/g, '<span class="tag-exam">$1</span>');
            content = content.replace(/ã€ğŸ”¥(.*?)ã€‘/g, '<span class="tag-mem">$1</span>');
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong style="color:#fff; border-bottom:1px dashed #94a3b8;">$1</strong>');
            html = `<div class="detail-box"><div class="detail-title" style="color:${color}">æ ¸å¿ƒå†…å®¹</div><div class="desc">${content}</div></div>`;
        }
        body.innerHTML = html || `<div class="desc" style="text-align:center; color:#64748b;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹æ•™æè¯¦æƒ…</div>`;

        footer.innerHTML = d.page ? `<a href="FRç”µå­æ•™æ.pdf#page=${d.page}" target="_blank" class="pdf-btn"><span>ğŸ“–</span> æ‰“å¼€æ•™æ (ç¬¬ ${d.page} é¡µ)</a>` : "";
        toggleSidebar(true);
    }

    document.getElementById("search").addEventListener("input", (e) => {
        const val = e.target.value.toLowerCase();
        node.style("opacity", d => d.label.toLowerCase().includes(val) ? 1 : 0.1);
        link.style("opacity", d => d.source.label.toLowerCase().includes(val) || d.target.label.toLowerCase().includes(val) ? 1 : 0.05);
    });
</script>
</body>
</html>
