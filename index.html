<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACCA FR æ€ç»´å¯¼å›¾å¤åˆ»ç‰ˆ (PDFè”åŠ¨)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-color: #020617;
            --sidebar-bg: #0f172a;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            
            /* é¢œè‰²ç¼–ç  - å¯¹åº”æ€ç»´å¯¼å›¾å…­å¤§æ¿å— */
            --c-framework: #ef4444; /* çº¢ï¼šæ¦‚å¿µæ¡†æ¶ */
            --c-assets: #f59e0b;    /* é»„ï¼šèµ„äº§ */
            --c-liab: #10b981;      /* ç»¿ï¼šè´Ÿå€ºä¸å·¥å…· */
            --c-perf: #06b6d4;      /* é’ï¼šæ”¶å…¥ä¸EPS */
            --c-consol: #8b5cf6;    /* ç´«ï¼šåˆå¹¶æŠ¥è¡¨ */
            --c-analy: #ec4899;     /* ç²‰ï¼šåˆ†æ */
            --c-case: #64748b;      /* ç°ï¼šæ¡ˆä¾‹ */
        }

        body { margin: 0; overflow: hidden; background: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
        #container { display: flex; width: 100vw; height: 100vh; }
        
        /* å›¾è°±åŒºåŸŸ */
        #graph-area { flex: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: 400px;
            background: var(--sidebar-bg);
            border-left: 1px solid #334155;
            padding: 20px;
            position: absolute;
            right: 0; top: 0; height: 100%;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        #sidebar.active { transform: translateX(0); }

        /* å†…å®¹æ ·å¼ */
        h2 { font-size: 1.4rem; border-bottom: 2px solid #334155; padding-bottom: 10px; margin-top: 0; color: var(--text-main); }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; color: #000; }
        .desc { line-height: 1.6; color: var(--text-sub); margin-bottom: 20px; white-space: pre-wrap; }
        
        /* PDF æŒ‰é’® */
        .pdf-btn {
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #e11d48, #be123c);
            color: white; text-decoration: none;
            padding: 12px; border-radius: 8px; font-weight: bold;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
        }
        .pdf-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(225, 29, 72, 0.5); }

        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute; top: 20px; left: 20px;
            background: rgba(15, 23, 42, 0.9);
            padding: 15px; border-radius: 12px;
            border: 1px solid #334155; backdrop-filter: blur(10px);
        }
        #search {
            background: #020617; border: 1px solid #334155; color: white;
            padding: 10px; border-radius: 6px; width: 250px; outline: none;
        }
        #search:focus { border-color: #38bdf8; }

        /* å›¾ä¾‹ */
        .legend-item { display: flex; align-items: center; margin-top: 8px; font-size: 0.85rem; color: var(--text-sub); }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }

        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #64748b; font-size: 1.5rem; cursor: pointer; }
        .close-btn:hover { color: white; }
    </style>
</head>
<body>

<div id="container">
    <div id="graph-area">
        <div id="controls">
            <input type="text" id="search" placeholder="ğŸ” æœç´¢çŸ¥è¯†ç‚¹ (å¦‚: Goodwill)...">
            <div style="margin-top:15px; border-top:1px solid #334155; padding-top:10px;">
                <div class="legend-item"><div class="dot" style="background:var(--c-framework)"></div>æ¦‚å¿µä¸ç›‘ç®¡ (Framework)</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-assets)"></div>èµ„äº§å‡†åˆ™ (Assets)</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-liab)"></div>è´Ÿå€º/æƒç›Š (Liab & Equity)</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-perf)"></div>ç»©æ•ˆæŠ¥è¡¨ (Performance)</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-consol)"></div>åˆå¹¶æŠ¥è¡¨ (Consolidation)</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-analy)"></div>åˆ†æ (Analysis)</div>
            </div>
        </div>
    </div>
    <div id="sidebar">
        <button class="close-btn" onclick="toggleSidebar(false)">Ã—</button>
        <div id="content"></div>
    </div>
</div>

<script>
    // --- æ•°æ®æ„å»ºï¼šåŸºäºæ€ç»´å¯¼å›¾é€»è¾‘çš„æ·±åº¦å¤åˆ» ---
    const nodes = [
        { id: "Root", label: "ACCA FR æ ¸å¿ƒå›¾è°±", group: 0, r: 40, page: 1 },

        // === 1. æ¦‚å¿µä¸ç›‘ç®¡ (Framework) ===
        { id: "Mod_Frame", label: "æ¦‚å¿µä¸ç›‘ç®¡", group: 1, parent: "Root", page: 9 },
        { id: "Ch2", label: "æ¦‚å¿µæ¡†æ¶", group: 1, parent: "Mod_Frame", page: 9 },
        { id: "Qual", label: "è´¨é‡ç‰¹å¾", group: 1, parent: "Ch2", desc: "Fundamental: Relevance, Faithful Rep\nEnhancing: Comparability, Verifiability, Timeliness, Understandability", page: 10 },
        { id: "Meas", label: "è®¡é‡åŸºç¡€", group: 1, parent: "Ch2", desc: "Historical Cost vs Current Value (FV, VIU, Current Cost)", page: 13 },
        { id: "Ch3", label: "ç›‘ç®¡æ¡†æ¶", group: 1, parent: "Mod_Frame", page: 17 },
        { id: "S1", label: "IFRS S1 å¯æŒç»­", group: 1, parent: "Ch3", desc: "Governance, Strategy, Risk Mgmt, Metrics", page: 19 },

        // === 2. èµ„äº§ (Assets - The Largest Branch) ===
        { id: "Mod_Asset", label: "èµ„äº§å‡†åˆ™", group: 2, parent: "Root", page: 23 },
        
        // PPE
        { id: "IAS16", label: "IAS 16 å›ºå®šèµ„äº§", group: 2, parent: "Mod_Asset", page: 23 },
        { id: "Init", label: "åˆå§‹è®¡é‡", group: 2, parent: "IAS16", desc: "Cost = Purchase Price + Directly Attributable Costs + Dismantling (PV)", page: 24 },
        { id: "Depn", label: "æŠ˜æ—§æ–¹æ³•", group: 2, parent: "IAS16", desc: "Straight-line vs Reducing balance. Component depreciation.", page: 24 },
        { id: "Reval", label: "é‡ä¼°æ¨¡å‹", group: 2, parent: "IAS16", desc: "Gain -> OCI/RS. Loss -> PL (unless reversing gain). Transfer excess depn.", page: 25 },
        { id: "Case_Topsy", label: "æ¡ˆä¾‹: Topsy Co", group: 7, parent: "Reval", desc: "ã€é‡ä¼°ç›ˆä½™è®¡ç®—ã€‘\n1. Transfer excess depn: ($15k)\n2. Land gain: +$150k\nClosing RS = $840k", page: 25 },

        // Intangibles
        { id: "IAS38", label: "IAS 38 æ— å½¢èµ„äº§", group: 2, parent: "Mod_Asset", page: 30 },
        { id: "RD", label: "R&D ç ”å‘", group: 2, parent: "IAS38", desc: "Research: Expense.\nDevelopment: Capitalize (PIRATE criteria).", page: 31 },
        { id: "Case_Assoria", label: "æ¡ˆä¾‹: Assoria", group: 7, parent: "RD", desc: "ç ”å‘è´¹ç”¨æ‘Šé”€è®¡ç®—ä¸èµ„æœ¬åŒ–æ—¶ç‚¹åˆ¤æ–­ã€‚", page: 33 },

        // Investment Property
        { id: "IAS40", label: "IAS 40 æŠ•èµ„æˆ¿äº§", group: 2, parent: "Mod_Asset", page: 35 },
        { id: "FV_Mod", label: "å…¬å…ä»·å€¼æ¨¡å‹", group: 2, parent: "IAS40", desc: "FV changes -> P&L. No depreciation.", page: 36 },
        { id: "Case_Carter", label: "æ¡ˆä¾‹: Carter", group: 7, parent: "FV_Mod", desc: "PPE è½¬ IP çš„ä¼šè®¡å¤„ç†ã€‚", page: 38 },

        // Impairment
        { id: "IAS36", label: "IAS 36 å‡å€¼", group: 2, parent: "Mod_Asset", page: 39 },
        { id: "CGU", label: "CGU åˆ†æ‘Š", group: 2, parent: "IAS36", desc: "Order: 1.Specific 2.Goodwill 3.Pro-rata", page: 40 },
        { id: "Case_Riley", label: "æ¡ˆä¾‹: Riley", group: 7, parent: "IAS36", desc: "VIU vs FV-CTS è®¡ç®— RAã€‚", page: 42 },

        // Other Assets
        { id: "IAS23", label: "IAS 23 å€Ÿæ¬¾è´¹ç”¨", group: 2, parent: "Mod_Asset", desc: "Qualifying Asset Capitalization", page: 44 },
        { id: "IAS2", label: "IAS 2 å­˜è´§", group: 2, parent: "Mod_Asset", desc: "Lower of Cost & NRV", page: 46 },
        { id: "IFRS5", label: "IFRS 5 æŒæœ‰å¾…å”®", group: 2, parent: "Mod_Asset", desc: "Available for immediate sale + Highly probable", page: 50 },
        { id: "IAS41", label: "IAS 41 å†œä¸š", group: 2, parent: "Mod_Asset", desc: "Bio Assets: FV-CTS", page: 54 },

        // === 3. è´Ÿå€ºä¸æƒç›Š (Liab & Equity) ===
        { id: "Mod_Liab", label: "è´Ÿå€ºä¸æƒç›Š", group: 3, parent: "Root", page: 57 },
        
        // Leases
        { id: "IFRS16", label: "IFRS 16 ç§Ÿèµ", group: 3, parent: "Mod_Liab", page: 57 },
        { id: "ROU", label: "ROU èµ„äº§", group: 3, parent: "IFRS16", desc: "Cost model (Depreciation)", page: 58 },
        { id: "L_Liab", label: "ç§Ÿèµè´Ÿå€º", group: 3, parent: "IFRS16", desc: "PV of payments. Subsequent: Amortized Cost.", page: 59 },
        { id: "Case_Pebworth", label: "æ¡ˆä¾‹: Pebworth", group: 7, parent: "L_Liab", desc: "ç§Ÿèµè´Ÿå€ºæ‘Šé”€è¡¨ä¸æ‹†åˆ† NCL/CLã€‚", page: 62 },

        // Provisions
        { id: "IAS37", label: "IAS 37 é¢„è®¡è´Ÿå€º", group: 3, parent: "Mod_Liab", page: 64 },
        { id: "Prov_Def", label: "ç¡®è®¤æ¡ä»¶", group: 3, parent: "IAS37", desc: "Present Obligation + Probable Outflow + Reliable Estimate", page: 64 },
        
        // Tax
        { id: "IAS12", label: "IAS 12 æ‰€å¾—ç¨", group: 3, parent: "Mod_Liab", page: 69 },
        { id: "Def_Tax", label: "é€’å»¶æ‰€å¾—ç¨", group: 3, parent: "IAS12", desc: "(Carrying Amt - Tax Base) * Rate", page: 70 },

        // Financial Instruments
        { id: "IFRS9", label: "IFRS 9 é‡‘èå·¥å…·", group: 3, parent: "Mod_Liab", page: 77 },
        { id: "Fin_Asset", label: "é‡‘èèµ„äº§", group: 3, parent: "IFRS9", desc: "Amortized Cost / FVTOCI / FVTPL", page: 78 },
        { id: "Fin_Liab", label: "é‡‘èè´Ÿå€º", group: 3, parent: "IFRS9", desc: "Amortized Cost (EIR Method)", page: 79 },
        { id: "IAS32", label: "æ··åˆå·¥å…·", group: 3, parent: "IFRS9", desc: "Convertible Bonds: Split Accounting (Liab + Equity)", page: 80 },
        { id: "Case_Tenfold", label: "æ¡ˆä¾‹: Tenfold", group: 7, parent: "Fin_Asset", desc: "æ‘Šä½™æˆæœ¬æ³•è®¡ç®—ã€‚", page: 81 },

        // === 4. ç»©æ•ˆ (Performance) ===
        { id: "Mod_Perf", label: "ç»©æ•ˆæŠ¥è¡¨", group: 4, parent: "Root", page: 84 },
        { id: "IFRS15", label: "IFRS 15 æ”¶å…¥", group: 4, parent: "Mod_Perf", page: 84 },
        { id: "Steps", label: "äº”æ­¥æ³•", group: 4, parent: "IFRS15", desc: "Contract -> PO -> Price -> Allocate -> Recognize", page: 85 },
        { id: "Cons_Cont", label: "å»ºé€ åˆåŒ", group: 4, parent: "IFRS15", desc: "Input/Output method for progress", page: 88 },
        { id: "IAS33", label: "IAS 33 EPS", group: 4, parent: "Mod_Perf", page: 101 },
        { id: "Basic", label: "Basic EPS", group: 4, parent: "IAS33", desc: "Earnings / WANS (Bonus/Rights issue adj)", page: 101 },
        { id: "Diluted", label: "Diluted EPS", group: 4, parent: "IAS33", desc: "Convertibles & Options impact", page: 103 },

        // === 5. åˆå¹¶æŠ¥è¡¨ (Consolidation - The Big One) ===
        { id: "Mod_Consol", label: "åˆå¹¶æŠ¥è¡¨", group: 5, parent: "Root", page: 133 },
        { id: "Process", label: "åˆå¹¶äº”æ­¥æ³• (SOFP)", group: 5, parent: "Mod_Consol", page: 142 },
        { id: "W1", label: "W1: é›†å›¢ç»“æ„", group: 5, parent: "Process", desc: "Acquisition Date, % Holding, Consideration", page: 142 },
        { id: "W2", label: "W2: å­å…¬å¸å‡€èµ„äº§", group: 5, parent: "Process", desc: "At Acq vs At Reporting Date (FV adjustments)", page: 153 },
        { id: "W3", label: "W3: å•†èª‰ (Goodwill)", group: 5, parent: "Process", desc: "Cost + NCI - Net Assets @ Acq", page: 154 },
        { id: "W4", label: "W4: NCI", group: 5, parent: "Process", desc: "NCI @ Acq + % * Post-acq retained earnings", page: 154 },
        { id: "W5", label: "W5: é›†å›¢ç•™å­˜æ”¶ç›Š", group: 5, parent: "Process", desc: "Parent RE + % * Sub Post-acq RE - Impairment", page: 154 },
        
        { id: "Adj", label: "åˆå¹¶è°ƒæ•´", group: 5, parent: "Mod_Consol", page: 156 },
        { id: "PURP", label: "PURP (æœªå®ç°åˆ©æ¶¦)", group: 5, parent: "Adj", desc: "Inventory Intra-group trading. Parent Sell vs Sub Sell.", page: 157 },
        { id: "Inter", label: "å†…éƒ¨å¾€æ¥", group: 5, parent: "Adj", desc: "Cancel Receivables/Payables/Loans", page: 158 },
        
        { id: "Assoc", label: "IAS 28 è”è¥å…¬å¸", group: 5, parent: "Mod_Consol", desc: "Equity Accounting (Not consolidated)", page: 164 },
        { id: "Disp", label: "å¤„ç½®å­å…¬å¸", group: 5, parent: "Mod_Consol", page: 163 },
        { id: "Case_Golden", label: "æ¡ˆä¾‹: Golden Co", group: 7, parent: "Disp", desc: "å¤„ç½®æ”¶ç›Šè®¡ç®—ï¼šProceeds + Retained - Net Assets - Goodwill", page: 163 },

        // === 6. åˆ†æ (Analysis) ===
        { id: "Mod_Analy", label: "åˆ†æä¸è§£è¯»", group: 6, parent: "Root", page: 128 },
        { id: "Ratios", label: "è´¢åŠ¡æ¯”ç‡", group: 6, parent: "Mod_Analy", desc: "ROCE, Gearing, Current Ratio, Working Capital cycles", page: 128 },
        { id: "Cashflow", label: "IAS 7 ç°é‡‘æµ", group: 6, parent: "Mod_Analy", desc: "Operating (Indirect), Investing, Financing", page: 122 }
    ];

    const links = nodes.filter(n => n.parent).map(n => ({ source: n.parent, target: n.id }));

    // --- D3.js æ¸²æŸ“å¼•æ“ ---
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    const svg = d3.select("#graph-area").append("svg")
        .attr("width", width).attr("height", height)
        .call(d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => g.attr("transform", e.transform)))
        .on("dblclick.zoom", null);

    const g = svg.append("g");

    // é¢œè‰²æ˜ å°„
    const colorMap = {
        0: "#fff", 1: "#ef4444", 2: "#f59e0b", 3: "#10b981", 4: "#06b6d4", 5: "#8b5cf6", 6: "#ec4899", 7: "#64748b"
    };

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(d => d.target.group === 7 ? 60 : 100))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(30).iterations(2));

    // è¿çº¿
    const link = g.append("g").selectAll("line")
        .data(links).join("line")
        .attr("stroke", "#334155").attr("stroke-width", 1.5).attr("stroke-opacity", 0.6);

    // èŠ‚ç‚¹å®¹å™¨
    const node = g.append("g").selectAll("g")
        .data(nodes).join("g")
        .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend))
        .on("click", (e, d) => { e.stopPropagation(); showInfo(d); });

    // èŠ‚ç‚¹åœ†åœˆ
    node.append("circle")
        .attr("r", d => d.group === 0 ? 35 : (d.group === 7 ? 8 : 15))
        .attr("fill", d => colorMap[d.group])
        .attr("stroke", "#fff").attr("stroke-width", 2)
        .attr("class", "node-circle");

    // èŠ‚ç‚¹æ–‡å­—
    node.append("text")
        .text(d => d.label)
        .attr("x", d => d.group === 0 ? 40 : 20)
        .attr("y", 5)
        .style("font-size", d => d.group === 0 ? "16px" : "12px")
        .style("fill", "#e2e8f0")
        .style("pointer-events", "none")
        .style("text-shadow", "2px 2px 4px #000");

    // --- é€»è¾‘å‡½æ•° ---
    function dragstart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragend(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    // ä¾§è¾¹æ é€»è¾‘
    function toggleSidebar(show) {
        const sb = document.getElementById("sidebar");
        show ? sb.classList.add("active") : sb.classList.remove("active");
    }

    function showInfo(d) {
        const content = document.getElementById("content");
        const groupNames = ["Core", "Framework", "Assets", "Liabilities", "Performance", "Consolidation", "Analysis", "Case"];
        const badgeColor = colorMap[d.group];
        
        // åŠ¨æ€ç”Ÿæˆå†…å®¹
        let html = `
            <span class="badge" style="background:${badgeColor}">${groupNames[d.group]}</span>
            <h2>${d.label}</h2>
            <div class="desc">${d.desc || "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹æ•™æè¯¦æƒ…ã€‚"}</div>
        `;

        // æ¡ˆä¾‹ç‰¹æ®Šæ ·å¼
        if(d.group === 7) {
            html += `<div class="example-box" style="border-left-color:${badgeColor}">${d.desc}</div>`;
        }

        // PDF æŒ‰é’®
        if (d.page) {
            html += `
                <a href="FRç”µå­æ•™æ.pdf#page=${d.page}" target="_blank" class="pdf-btn">
                    <span>ğŸ“– æ‰“å¼€æ•™æ (ç¬¬ ${d.page} é¡µ)</span>
                </a>
            `;
        }

        content.innerHTML = html;
        toggleSidebar(true);
    }

    // æœç´¢é€»è¾‘
    document.getElementById("search").addEventListener("input", (e) => {
        const val = e.target.value.toLowerCase();
        node.style("opacity", d => d.label.toLowerCase().includes(val) ? 1 : 0.1);
        link.style("opacity", d => d.source.label.toLowerCase().includes(val) || d.target.label.toLowerCase().includes(val) ? 1 : 0.05);
    });

</script>
</body>
</html>
