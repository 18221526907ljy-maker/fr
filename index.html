<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACCA FR ç»ˆæå¤ä¹ å›¾è°± (ç¨³å®šæé€Ÿç‰ˆ)</title>
    
    <script src="https://lib.baomitu.com/d3/7.8.5/d3.min.js"></script>
    
    <style>
        :root {
            --bg-color: #020617;
            --sidebar-bg: #0f172a;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border-color: #334155;
            /* é¢œè‰²å®šä¹‰ */
            --c-framework: #ef4444; --c-assets: #f59e0b; --c-liab: #10b981;
            --c-perf: #06b6d4; --c-consol: #8b5cf6; --c-analy: #ec4899; --c-case: #64748b;
        }

        body { margin: 0; overflow: hidden; background: var(--bg-color); color: var(--text-main); font-family: sans-serif; }
        #container { display: flex; width: 100vw; height: 100vh; }
        #graph-area { flex: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        /* çŠ¶æ€æç¤ºå±‚ */
        #status-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.9); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #status-text { font-size: 1.5rem; color: #38bdf8; margin-bottom: 10px; }
        #error-log { color: #ef4444; font-family: monospace; margin-top: 10px; font-size: 0.9rem; max-width: 80%; white-space: pre-wrap; }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: 450px; background: var(--sidebar-bg); border-left: 1px solid var(--border-color);
            position: absolute; right: 0; top: 0; height: 100%;
            transform: translateX(100%); transition: transform 0.3s ease; z-index: 20;
            box-shadow: -10px 0 30px rgba(0,0,0,0.6); display: flex; flex-direction: column;
        }
        #sidebar.active { transform: translateX(0); }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .sidebar-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        h2 { margin: 0 0 10px 0; color: var(--text-main); border-bottom: 2px solid #334155; padding-bottom: 10px; font-size: 1.4rem; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; color: #000; }

        /* å†…å®¹æ ·å¼ */
        .desc { line-height: 1.6; color: #cbd5e1; font-size: 0.95rem; white-space: pre-wrap; margin-bottom: 15px; }
        .detail-title { color: var(--text-sub); font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; }
        .detail-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .example-box { background: #1e293b; padding: 15px; border-left: 4px solid var(--c-case); border-radius: 6px; font-family: monospace; white-space: pre-wrap; }

        /* PDF æŒ‰é’® */
        .pdf-container { padding: 20px; border-top: 1px solid var(--border-color); background: rgba(15, 23, 42, 0.95); }
        .pdf-btn {
            display: flex; align-items: center; justify-content: center; width: 100%;
            background: linear-gradient(135deg, #e11d48, #be123c); color: white; text-decoration: none;
            padding: 12px; border-radius: 8px; font-weight: bold; border: 1px solid #be123c;
            transition: transform 0.1s;
        }
        .pdf-btn:hover { transform: translateY(-2px); background: #be123c; }

        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-sub); font-size: 2rem; cursor: pointer; }
        
        /* æœç´¢æ  */
        #controls { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
        #search { background: #020617; border: 1px solid var(--border-color); color: white; padding: 8px 12px; border-radius: 6px; width: 200px; outline: none; }
        .legend-item { display: flex; align-items: center; margin-top: 8px; font-size: 0.8rem; color: var(--text-sub); }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>

<div id="container">
    <div id="status-overlay">
        <div id="status-text">æ­£åœ¨åˆå§‹åŒ–å¼•æ“...</div>
        <div id="error-log"></div>
    </div>

    <div id="graph-area">
        <div id="controls">
            <input type="text" id="search" placeholder="ğŸ” æœç´¢çŸ¥è¯†ç‚¹...">
            <div style="margin-top:15px; border-top:1px solid #334155; padding-top:10px;">
                <div class="legend-item"><div class="dot" style="background:var(--c-framework)"></div>æ¦‚å¿µä¸ç›‘ç®¡</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-assets)"></div>èµ„äº§å‡†åˆ™</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-liab)"></div>è´Ÿå€º/æƒç›Š</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-perf)"></div>ç»©æ•ˆ/æ”¶å…¥</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-consol)"></div>åˆå¹¶æŠ¥è¡¨</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-analy)"></div>åˆ†æ</div>
                <div class="legend-item"><div class="dot" style="background:var(--c-case)"></div>æ¡ˆä¾‹</div>
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <div class="sidebar-header">
            <button class="close-btn" onclick="toggleSidebar(false)">Ã—</button>
            <div id="header-content"></div>
        </div>
        <div class="sidebar-body">
            <div id="body-content"></div>
        </div>
        <div class="pdf-container" id="pdf-footer"></div>
    </div>
</div>

<script>
    // æ—¥å¿—å·¥å…·
    function logStatus(msg, isError = false) {
        const el = document.getElementById('status-text');
        const log = document.getElementById('error-log');
        if (el) el.innerText = isError ? "ç¨‹åºä¸­æ­¢" : msg;
        if (isError && log) log.innerText += "\né”™è¯¯: " + msg;
        console.log(msg);
    }

    // å…¨å±€é”™è¯¯æ•è·
    window.onerror = function(msg, source, lineno, colno, error) {
        logStatus(`ç³»ç»Ÿé”™è¯¯: ${msg} (Line ${lineno})`, true);
        return false;
    };

    // åˆå§‹åŒ–å…¥å£
    window.onload = function() {
        try {
            if (typeof d3 === 'undefined') {
                throw new Error("D3.js åº“æœªèƒ½åŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ (cdn.staticfile.net)ã€‚");
            }
            logStatus("æ•°æ®æ„å»ºä¸­...");
            initGraph();
        } catch (e) {
            logStatus(e.message, true);
        }
    };

    function initGraph() {
        // --- 1. æ•°æ®æº ---
        const nodes = [
            { id: "Root", label: "ACCA FR æ ¸å¿ƒå›¾è°±", group: 0, r: 45, page: 1, desc: "Financial Reporting çŸ¥è¯†ä½“ç³»æ¦‚è§ˆ" },

            // === Framework (Red) ===
            { id: "Mod_Frame", label: "æ¦‚å¿µä¸ç›‘ç®¡", group: 1, parent: "Root", page: 9, desc: "è´¢åŠ¡æŠ¥å‘ŠåŸºç¡€ã€‚" },
            { id: "Ch2", label: "æ¦‚å¿µæ¡†æ¶", group: 1, parent: "Mod_Frame", page: 9, desc: "å‡†åˆ™çš„åŸºç¡€ã€‚IFRS ä¼˜å…ˆäºæ¡†æ¶ã€‚" },
            { id: "Qual", label: "è´¨é‡ç‰¹å¾", group: 1, parent: "Ch2", page: 10, desc: "Fundamental: Relevance, Faithful Rep.\nEnhancing: Comparability, Verifiability, Timeliness, Understandability." },
            { id: "Meas", label: "è®¡é‡åŸºç¡€", group: 1, parent: "Ch2", page: 13, desc: "Historical Cost vs Current Value (FV, VIU, Current Cost)." },
            { id: "S1", label: "IFRS S1 å¯æŒç»­", group: 1, parent: "Mod_Frame", page: 19, desc: "æŠ«éœ² Governance, Strategy, Risk, Metrics." },

            // === Assets (Yellow) ===
            { id: "Mod_Asset", label: "èµ„äº§å‡†åˆ™", group: 2, parent: "Root", page: 23, desc: "èµ„äº§ç¡®è®¤ä¸è®¡é‡ã€‚" },
            
            // IAS 16
            { id: "IAS16", label: "IAS 16 å›ºå®šèµ„äº§", group: 2, parent: "Mod_Asset", page: 23, desc: "æœ‰å½¢é•¿æœŸèµ„äº§ã€‚" },
            { id: "Init", label: "åˆå§‹è®¡é‡", group: 2, parent: "IAS16", page: 24, desc: "Cost = Purchase + Direct costs + Dismantling." },
            { id: "Reval", label: "é‡ä¼°æ¨¡å‹", group: 2, parent: "IAS16", page: 25, desc: "Gain -> OCI (RS). Loss -> SPL (unless reversing gain)." },
            { id: "Case_Topsy", label: "æ¡ˆä¾‹: Topsy Co", group: 7, parent: "Reval", page: 25, desc: "é‡ä¼°ç›ˆä½™è®¡ç®—ï¼š\næœŸåˆ RS + æ–°å¢å€¼ - å¤šä½™æŠ˜æ—§è½¬ç§» = æœŸæœ« RSã€‚" },

            // IAS 38
            { id: "IAS38", label: "IAS 38 æ— å½¢èµ„äº§", group: 2, parent: "Mod_Asset", page: 30, desc: "æ— å®ä½“èµ„äº§ã€‚" },
            { id: "RD", label: "R&D ç ”å‘", group: 2, parent: "IAS38", page: 31, desc: "Research: Expense.\nDev: Capitalize if PIRATE met." },
            { id: "Case_Assoria", label: "æ¡ˆä¾‹: Assoria", group: 7, parent: "RD", page: 33, desc: "ç ”å‘æ‘Šé”€è®¡ç®—ã€‚" },

            // IAS 40
            { id: "IAS40", label: "IAS 40 æŠ•èµ„æˆ¿äº§", group: 2, parent: "Mod_Asset", page: 35, desc: "èµšç§Ÿé‡‘/å¢å€¼ã€‚" },
            { id: "FV_Mod", label: "å…¬å…ä»·å€¼æ¨¡å‹", group: 2, parent: "IAS40", page: 36, desc: "FV å˜åŠ¨è¿› SPLã€‚ä¸æŠ˜æ—§ã€‚" },

            // IAS 36
            { id: "IAS36", label: "IAS 36 å‡å€¼", group: 2, parent: "Mod_Asset", page: 39, desc: "CA > RAã€‚" },
            { id: "RA_Calc", label: "RA è®¡ç®—", group: 2, parent: "IAS36", page: 40, desc: "Max(FV-CTS, VIU)ã€‚" },
            { id: "Case_Riley", label: "æ¡ˆä¾‹: Riley", group: 7, parent: "RA_Calc", page: 42, desc: "å‡å€¼æµ‹è¯•å®ä¾‹ã€‚" },

            // Other Assets
            { id: "IAS23", label: "IAS 23 å€Ÿæ¬¾è´¹ç”¨", group: 2, parent: "Mod_Asset", page: 44, desc: "ç¬¦åˆæ¡ä»¶èµ„äº§éœ€èµ„æœ¬åŒ–ã€‚" },
            { id: "IAS2", label: "IAS 2 å­˜è´§", group: 2, parent: "Mod_Asset", page: 46, desc: "Lower of Cost & NRVã€‚" },

            // === Liab & Equity (Green) ===
            { id: "Mod_Liab", label: "è´Ÿå€ºä¸æƒç›Š", group: 3, parent: "Root", page: 57, desc: "è´Ÿå€ºå¤„ç†ã€‚" },
            { id: "IFRS16", label: "IFRS 16 ç§Ÿèµ", group: 3, parent: "Mod_Liab", page: 57, desc: "ROU Asset + Lease Liabã€‚" },
            { id: "L_Calc", label: "ç§Ÿèµè®¡ç®—", group: 3, parent: "IFRS16", page: 58, desc: "Liab: PV + Interest - Payment.\nAsset: Cost - Depn." },
            { id: "Case_Pebworth", label: "æ¡ˆä¾‹: Pebworth", group: 7, parent: "L_Calc", page: 62, desc: "ç§Ÿèµ SPL è´¹ç”¨è®¡ç®—ã€‚" },
            { id: "IAS37", label: "IAS 37 é¢„è®¡è´Ÿå€º", group: 3, parent: "Mod_Liab", page: 64, desc: "Probable outflow, reliable estimate." },
            { id: "IAS12", label: "IAS 12 æ‰€å¾—ç¨", group: 3, parent: "Mod_Liab", page: 69, desc: "é€’å»¶ç¨ = (CA - TB) * Rate." },
            { id: "IFRS9", label: "IFRS 9 é‡‘èå·¥å…·", group: 3, parent: "Mod_Liab", page: 77, desc: "Asset: Amortized/FVTPL/FVTOCI.\nLiab: Amortized Cost." },
            { id: "Case_Tenfold", label: "æ¡ˆä¾‹: Tenfold", group: 7, parent: "IFRS9", page: 81, desc: "æ‘Šä½™æˆæœ¬æ³•è®¡ç®—ã€‚" },

            // === Performance (Cyan) ===
            { id: "Mod_Perf", label: "ç»©æ•ˆæŠ¥è¡¨", group: 4, parent: "Root", page: 84, desc: "æ”¶å…¥ & EPSã€‚" },
            { id: "IFRS15", label: "IFRS 15 æ”¶å…¥", group: 4, parent: "Mod_Perf", page: 84, desc: "äº”æ­¥æ³•æ¨¡å‹ã€‚" },
            { id: "Cons_Cont", label: "å»ºé€ åˆåŒ", group: 4, parent: "IFRS15", page: 88, desc: "Over time recognition." },
            { id: "IAS33", label: "IAS 33 EPS", group: 4, parent: "Mod_Perf", page: 101, desc: "Basic & Diluted EPS." },

            // === Consolidation (Purple) ===
            { id: "Mod_Consol", label: "åˆå¹¶æŠ¥è¡¨", group: 5, parent: "Root", page: 133, desc: "IFRS 10 & 3ã€‚" },
            { id: "Process", label: "åˆå¹¶äº”æ­¥æ³•", group: 5, parent: "Mod_Consol", page: 142, desc: "Structure, Net Assets, Goodwill, NCI, RE." },
            { id: "W3", label: "W3: å•†èª‰", group: 5, parent: "Process", page: 154, desc: "Cost + NCI - Net Assets." },
            { id: "W4", label: "W4: NCI", group: 5, parent: "Process", page: 154, desc: "Fair Value @ Acq + % Post-acq profits." },
            { id: "Adj", label: "åˆå¹¶è°ƒæ•´", group: 5, parent: "Mod_Consol", page: 156, desc: "PURP (Inventory), Intra-group balances." },
            { id: "Assoc", label: "IAS 28 è”è¥", group: 5, parent: "Mod_Consol", page: 164, desc: "æƒç›Šæ³•: Cost + Share of Profit." },
            { id: "Case_Golden", label: "æ¡ˆä¾‹: Golden", group: 7, parent: "Mod_Consol", page: 163, desc: "å¤„ç½®å­å…¬å¸æ”¶ç›Šè®¡ç®—ã€‚" },

            // === Analysis (Pink) ===
            { id: "Mod_Analy", label: "åˆ†æ", group: 6, parent: "Root", page: 128, desc: "æ¯”ç‡ä¸ç°é‡‘æµã€‚" },
            { id: "Ratios", label: "è´¢åŠ¡æ¯”ç‡", group: 6, parent: "Mod_Analy", page: 128, desc: "ROCE, Gearing, Liquidity." },
            { id: "Cashflow", label: "IAS 7 ç°é‡‘æµ", group: 6, parent: "Mod_Analy", page: 122, desc: "Operating, Investing, Financing." }
        ];

        // --- 2. å®‰å…¨æ„å»ºè¿çº¿ (é˜²é”™æœºåˆ¶) ---
        logStatus("æ„å»ºæ•°æ®å…³è”...");
        const nodeMap = new Map(nodes.map(n => [n.id, n]));
        const links = [];
        
        nodes.forEach(n => {
            if (n.parent) {
                if (nodeMap.has(n.parent)) {
                    links.push({ source: n.parent, target: n.id });
                } else {
                    console.warn("è·³è¿‡å­¤ç«‹èŠ‚ç‚¹ (æ‰¾ä¸åˆ°çˆ¶èŠ‚ç‚¹): " + n.id);
                }
            }
        });

        // --- 3. æ¸²æŸ“å¼•æ“ ---
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        const svg = d3.select("#graph-area").append("svg")
            .attr("width", width).attr("height", height)
            .call(d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => g.attr("transform", e.transform)))
            .on("dblclick.zoom", null);

        const g = svg.append("g");

        const colorMap = {
            0: "#fff", 1: "#ef4444", 2: "#f59e0b", 3: "#10b981", 4: "#06b6d4", 5: "#8b5cf6", 6: "#ec4899", 7: "#64748b"
        };

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(d => d.group === 7 ? 50 : 100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(35));

        const link = g.append("g").selectAll("line")
            .data(links).join("line")
            .attr("stroke", "#334155").attr("stroke-width", 1.5).attr("stroke-opacity", 0.6);

        const node = g.append("g").selectAll("g")
            .data(nodes).join("g")
            .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend))
            .on("click", (e, d) => { e.stopPropagation(); showInfo(d); });

        node.append("circle")
            .attr("r", d => d.group === 0 ? 40 : (d.group === 7 ? 10 : 18))
            .attr("fill", d => colorMap[d.group])
            .attr("stroke", "#fff").attr("stroke-width", 2)
            .style("cursor", "pointer");

        node.append("text")
            .text(d => d.label)
            .attr("x", d => d.group === 0 ? 45 : 22)
            .attr("y", 5)
            .style("font-size", d => d.group === 0 ? "18px" : "12px")
            .style("fill", "#e2e8f0")
            .style("pointer-events", "none")
            .style("text-shadow", "2px 2px 3px #000");

        // ç§»é™¤åŠ è½½å±‚
        document.getElementById('status-overlay').style.display = 'none';

        // äº¤äº’å‡½æ•°
        function dragstart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
        function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
        function dragend(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // æœç´¢
        document.getElementById("search").addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            node.style("opacity", d => d.label.toLowerCase().includes(val) ? 1 : 0.1);
            link.style("opacity", d => d.source.label.toLowerCase().includes(val) || d.target.label.toLowerCase().includes(val) ? 1 : 0.05);
        });
    }

    // ä¾§è¾¹æ 
    function toggleSidebar(show) {
        const sb = document.getElementById("sidebar");
        show ? sb.classList.add("active") : sb.classList.remove("active");
    }

    function showInfo(d) {
        const header = document.getElementById("header-content");
        const body = document.getElementById("body-content");
        const footer = document.getElementById("pdf-footer");
        const color = {0: "#fff", 1: "#ef4444", 2: "#f59e0b", 3: "#10b981", 4: "#06b6d4", 5: "#8b5cf6", 6: "#ec4899", 7: "#64748b"}[d.group];
        
        header.innerHTML = `<span class="badge" style="background:${color}; color:${d.group===0?'#000':'#fff'}">èŠ‚ç‚¹è¯¦æƒ…</span><h2>${d.label}</h2>`;
        
        let html = "";
        if (d.desc) {
            const content = d.desc.replace(/\n/g, "<br>").replace(/\*\*(.*?)\*\*/g, '<strong style="color:#fff">$1</strong>');
            html = d.group === 7 ? `<div class="example-box">${content}</div>` : `<div class="detail-box"><div class="detail-title" style="color:${color}">æ ¸å¿ƒè¦ç‚¹</div><div class="desc">${content}</div></div>`;
        }
        body.innerHTML = html || `<div class="desc" style="text-align:center; color:#64748b;">æš‚æ— è¯¦ç»†æè¿°</div>`;

        footer.innerHTML = d.page ? `<a href="FRç”µå­æ•™æ.pdf#page=${d.page}" target="_blank" class="pdf-btn"><span>ğŸ“–</span> æ‰“å¼€æ•™æ (ç¬¬ ${d.page} é¡µ)</a>` : "";
        toggleSidebar(true);
    }
</script>
</body>
</html>
